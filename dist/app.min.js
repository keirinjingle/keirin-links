(()=>{(function(){if(window.updateDropdown)return;let e=["\u4E09\u5206\u6226","\u4E8C\u5206\u6226","\u5358\u9A0E","\u5148\u884C\u4E00\u8ECA","\u307E\u304F\u308A","\u5DEE\u3057","\u30AB\u30DE\u30B7","\u81EA\u5728"];function t(s){return(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function i(s,r){let a=s.slice(0,r).match(/(^|\s)\/(\S*)$/);return a?{token:a[2],start:r-a[2].length-1,end:r}:null}function n(s){let r=(s||"").toLowerCase(),a=[],c=!!(r&&r.length>0);try{let d=window.RIDERS;Array.isArray(d)&&d.length&&c&&d.filter(f=>((f.name||"")+" "+(f.region||"")+" "+(f.ki||"")).toLowerCase().includes(r)).slice(0,24).forEach(f=>a.push({type:"rider",text:"@"+(f.name||""),label:f.name||"",payload:f}))}catch{}(r?e.filter(d=>d.toLowerCase().includes(r)):e).forEach(d=>a.push({type:"tactic",text:"#"+d,label:"#"+d})),r&&a.push({type:"tag",text:"+"+s,label:"+"+s});try{let d=window.DAYCARDS;if(Array.isArray(d)&&d.length)for(let f of d){let o=f.venue||"",u=o.toLowerCase();for(let g of f.races||[]){let v=`${o}${g.race_number}R`,S=v.toLowerCase();(r?S.includes(r)||u.includes(r):!0)&&a.push({type:"race",text:"- "+v,label:v})}}}catch{}return window.__shim_items=a.slice(0,80),window.__shim_items}function p(s){let r=document.getElementById("dropdown");if(!r)return;if(!s||!s.length){r.style.display="none",r.innerHTML="";return}r.innerHTML=s.map((l,d)=>`<div class="item" data-i="${d}"><span class="type">${l.type==="race"?"\u30EC\u30FC\u30B9":l.type==="tactic"?"\u6226\u6CD5":l.type==="rider"?"\u9078\u624B":"\u30BF\u30B0"}</span> ${t(l.text||l.label||"")}</div>`).join(""),r.style.display="block";let a=0;for(let l=0;l<s.length;l++)if(s[l].type==="rider"){a=l;break}r.querySelectorAll(".item").forEach((l,d)=>l.classList.toggle("is-active",d===a))}window.__getSlashToken=i,window.updateDropdown=function(){if(window.__isComposing){let l=document.getElementById("dropdown");l&&(l.style.display="none",l.innerHTML="");return}let s=document.getElementById("ta");if(!s)return;let r=s.selectionStart||0,a=i(s.value,r);if(!a){p([]);return}let c=n(a.token);p(c)},window.__shim_items=window.__shim_items||[],console.info("mofu: shim installed (dropdown builder)")})();var j="https://keirinjingle.github.io/keirin-links/senshuID.json",O=e=>`https://keirinjingle.github.io/keirin-links/data/keirin_race_list_${e}.json`,k="mofu:entries:mvp2",w=document.getElementById("ta"),y=document.getElementById("dropdown"),_=document.getElementById("cards"),b=document.getElementById("riderStatus"),C=document.getElementById("raceStatus");window.__isComposing=!1;function x(...e){window.console&&console.log(...e)}function N(){let e=new Date,t=e.getTimezoneOffset()*6e4;return new Date(e.getTime()-t).toISOString().slice(0,10).replace(/-/g,"")}function A(e,t,i){if(!e)return;let n=e.querySelector(".mark");n&&(n.textContent=t?"\u2705":`\u2716${i?`(${i})`:""}`),e.classList.toggle("ok",!!t),e.classList.toggle("ng",!t)}var E=null,L=!0;(function(){try{localStorage.setItem(k+":hc","1"),localStorage.removeItem(k+":hc"),L=!0}catch(e){L=!1,console.warn("localStorage not available",e)}})();function h(){if(E)return E;try{if(!L)return E=[],E;let e=localStorage.getItem(k);return E=e?JSON.parse(e):[],E}catch(e){console.warn("loadEntries error \u2014 reinit",e),E=[];try{L&&localStorage.setItem(k,"[]")}catch{}return E}}function D(e){if(E=Array.isArray(e)?e:[],!L)return!1;try{return localStorage.setItem(k,JSON.stringify(E)),!0}catch(t){return console.warn("saveEntries error",t),!1}}function q(e){return e.replace(/@([^\s@#\+（）()]+)/g,(t,i)=>`<a href="#" class="riderLink" data-q="@${i}">@${i}</a>`).replace(/\+("[^"]+"|[\w\u3040-\u30ff\u4e00-\u9faf]+)/g,t=>`<a href="#" class="tagLink" data-q="${t}">${t}</a>`)}function I(e){if(!_)return;let t=(e??h()).slice().reverse();if(!t.length){_.innerHTML='<div class="card" style="color:#9ca3af">\uFF08\u307E\u3060\u30E1\u30E2\u304C\u3042\u308A\u307E\u305B\u3093\uFF09</div>';return}_.innerHTML=t.map(i=>{let n=(i.at||"").slice(0,10),p=(i.raw||"").replace(/</g,"&lt;");return`<div class="card" id="card_${i.id}">
      <div class="head"><span class="date">${n}</span>
        <div style="margin-left:auto;display:flex;gap:.4rem">
          <button class="linklike editBtn" data-id="${i.id}">\u7DE8\u96C6</button>
          <button class="linklike delBtn" data-id="${i.id}">\u524A\u9664</button>
        </div>
      </div>
      <div class="raw">${q(p)}</div>
    </div>`}).join("")}function R(e){let t={id:Date.now().toString(36)+Math.random().toString(16).slice(2),at:new Date().toISOString(),raw:e},i=h().slice();i.push(t);let n=D(i);I(i),n||alert("\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F\uFF08\u30B9\u30C8\u30EC\u30FC\u30B8\u306B\u66F8\u304D\u8FBC\u3081\u307E\u305B\u3093\uFF09")}function F(e,t){let i=h().slice(),n=i.findIndex(s=>s.id===e);if(n<0)return;i[n]={...i[n],raw:t,at:new Date().toISOString()};let p=D(i);I(i),p||alert("\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F")}function H(e){let t=h().filter(n=>n.id!==e),i=D(t);I(t),i||alert("\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F")}async function Y(){try{let e=await fetch(j,{cache:"no-cache"});if(!e.ok)throw new Error("HTTP "+e.status);let t=await e.text(),i=JSON.parse(t||"[]");if(window.RIDERS=(i||[]).map(n=>({id:String(n.\u767B\u9332\u756A\u53F7||"").trim(),name:n.\u9078\u624B\u540D||n.name||"",ki:(n.\u671F||n.ki||"")+"",region:n.\u5730\u57DF||n.region||"",grade:n.\u7D1A||n.grade||""})),A(b,!0),typeof window.updateDropdown=="function")try{window.updateDropdown()}catch(n){console.warn("updateDropdown failed after fetchRiders",n)}x("RIDERS loaded:",window.RIDERS.length)}catch(e){window.RIDERS=[],A(b,!1,e.message||"fetch error"),console.warn("fetchRiders error",e)}}async function G(){try{let e=O(N()),t=await fetch(e,{cache:"no-cache"});if(!t.ok)throw new Error("HTTP "+t.status);let i=await t.json();if(window.DAYCARDS=Array.isArray(i)?i:[],A(C,!0),typeof window.updateDropdown=="function")try{window.updateDropdown()}catch(n){console.warn("updateDropdown failed after fetchRaces",n)}x("DAYCARDS loaded:",window.DAYCARDS.length)}catch(e){window.DAYCARDS=[],A(C,!1,e.message||"fetch error"),console.warn("fetchRaces error",e)}}function J(e,t){let i=e.slice(0,t).match(/(^|\s)\/(\S*)$/);return i?{token:i[2],start:t-i[2].length-1,end:t}:null}function M(e){let t=window.__shim_items||[];if(!t.length)return;let i=t[e];if(!i&&(e=0,i=t[0],!i))return;let n=typeof window.__getSlashToken=="function"?window.__getSlashToken(w.value,w.selectionStart):J(w.value,w.selectionStart);if(n&&n.token&&n.token.length>0&&i.type!=="rider"){let f=t.find(o=>o.type==="rider");f&&(i=f)}let p=i.text||i.label||"";if(!p)return;let s=n?w.value.slice(0,n.start):w.value.slice(0,w.selectionStart),r=n?w.value.slice(n.end):w.value.slice(w.selectionEnd),a=s&&!/\s$/.test(s),c=r&&!/^\s/.test(r),l=(a?" ":"")+p+(c?" ":"");w.value=s+l+r;let d=(s+l).length;w.setSelectionRange(d,d),y&&(y.style.display="none"),w.focus()}function T(e){if(!y)return;let t=Array.from(y.querySelectorAll(".item"));if(!t.length)return;let i=t.findIndex(s=>s.classList.contains("is-active"));i<0&&(i=0);let n=(i+e+t.length)%t.length;t.forEach((s,r)=>s.classList.toggle("is-active",r===n));let p=t[n];p&&p.scrollIntoView({block:"nearest"})}if(y){let e=null;y.addEventListener("pointerdown",t=>{let i=t.target.closest&&t.target.closest(".item");i&&(e={idx:parseInt(i.dataset.i,10),x:t.clientX,y:t.clientY,dragged:!1})}),y.addEventListener("pointermove",t=>{e&&(Math.abs(t.clientX-e.x)>6||Math.abs(t.clientY-e.y)>6)&&(e.dragged=!0)}),y.addEventListener("pointerup",t=>{if(!e)return;let i=t.target.closest&&t.target.closest(".item"),n=i?parseInt(i.dataset.i,10):e.idx,p=e.dragged;e=null,p||M(n)}),y.addEventListener("pointercancel",()=>{e=null})}w&&(w.addEventListener("compositionstart",()=>{window.__isComposing=!0}),w.addEventListener("compositionend",()=>{window.__isComposing=!1,setTimeout(()=>{typeof window.updateDropdown=="function"&&window.updateDropdown()},30)}),w.addEventListener("input",()=>{window.__isComposing||typeof window.updateDropdown=="function"&&window.updateDropdown()}),w.addEventListener("keyup",e=>{e.key==="/"&&!window.__isComposing&&typeof window.updateDropdown=="function"&&window.updateDropdown()}),w.addEventListener("keydown",e=>{if(!window.__isComposing&&!(!y||y.style.display!=="block")){if(e.key==="ArrowDown"){e.preventDefault(),T(1);return}if(e.key==="ArrowUp"){e.preventDefault(),T(-1);return}if(e.key==="Enter"||e.key==="Tab"){let t=y.querySelector(".item.is-active")||y.querySelector('.item[data-i="0"]');if(t){e.preventDefault();let i=parseInt(t.dataset.i,10);M(i)}}e.key==="Escape"&&(y.style.display="none")}}));(function(){let t=()=>{let i=document.getElementById("settingsBtn"),n=document.getElementById("settingsMenu");if(!i||!n){setTimeout(t,120);return}n.style.display=n.style.display||"none",n.style.zIndex=n.style.zIndex||999,i.addEventListener("click",p=>{p.stopPropagation(),n.style.display=n.style.display==="block"?"none":"block"}),document.addEventListener("click",p=>{!n.contains(p.target)&&p.target!==i&&(n.style.display="none")}),document.addEventListener("keydown",p=>{p.key==="Escape"&&(n.style.display="none")}),window.addEventListener("scroll",()=>{n&&n.style.display==="block"&&(n.style.display="none")},{passive:!0})};document.readyState==="complete"||document.readyState==="interactive"?t():document.addEventListener("DOMContentLoaded",t)})();document.body.addEventListener("click",e=>{let t=e.target.closest&&e.target.closest(".editBtn"),i=e.target.closest&&e.target.closest(".delBtn");if(t){let s=t.dataset.id,r=h().find(c=>c.id===s);if(!r)return;let a=prompt("\u30E1\u30E2\u3092\u7DE8\u96C6",r.raw||"");if(a==null)return;F(s,a);return}if(i){let s=i.dataset.id;confirm("\u3053\u306E\u30E1\u30E2\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F")&&H(s);return}let n=e.target.closest&&e.target.closest("a.riderLink"),p=e.target.closest&&e.target.closest("a.tagLink");if(n){e.preventDefault();let s=n.dataset.q,r=document.getElementById("searchInput");r&&(r.value=s);let a=document.getElementById("searchDlg");a&&a.showModal();return}if(p){e.preventDefault();let s=p.dataset.q,r=document.getElementById("searchInput");r&&(r.value=s);let a=document.getElementById("searchDlg");a&&a.showModal();return}});(function(){I(h()),Y(),G()})();(()=>{let e=typeof k<"u"?k:"mofu:entries:mvp2",t=c=>document.querySelector(c),i=document.getElementById("dropdown");function n(){let c=t("#settingsMenu");c&&(c.style.display="none")}async function p(){try{if(typeof window.ensureGisReady!="function"){alert("Google\u30ED\u30B0\u30A4\u30F3\u306E\u6E96\u5099\u95A2\u6570(ensureGisReady)\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3002index.html \u306EGIS\u30D8\u30EB\u30D1\u633F\u5165\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002");return}if(!await window.ensureGisReady())return;window.tokenClient?(window.accessToken=null,window.tokenClient.requestAccessToken({prompt:"consent"}),alert("Google\u30ED\u30B0\u30A4\u30F3\u3092\u958B\u59CB\u3057\u307E\u3057\u305F\u3002\u8A31\u53EF\u30D5\u30ED\u30FC\u3092\u5B8C\u4E86\u3057\u3066\u304F\u3060\u3055\u3044\u3002")):alert("tokenClient \u304C\u672A\u521D\u671F\u5316\u3067\u3059\u3002\u30DA\u30FC\u30B8\u3092\u518D\u8AAD\u307F\u8FBC\u307F\u3057\u3066\u518D\u8A66\u884C\u3057\u3066\u304F\u3060\u3055\u3044\u3002")}catch(c){console.error(c),alert("Google\u30ED\u30B0\u30A4\u30F3\u4E2D\u306B\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F\u3002")}finally{n()}}function s(){try{let l=((typeof h=="function"?h():JSON.parse(localStorage.getItem(e)||"[]"))||[]).map(u=>JSON.stringify(u)).join(`
`),d=new Blob([l],{type:"application/x-ndjson"}),f=document.createElement("a"),o=new Date().toISOString().slice(0,10).replace(/-/g,"");f.href=URL.createObjectURL(d),f.download=`mofu_entries_${o}.ndjson`,document.body.appendChild(f),f.click(),f.remove()}catch(c){console.error(c),alert("\u30A8\u30AF\u30B9\u30DD\u30FC\u30C8\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002")}finally{n()}}function r(){let c=document.createElement("input");c.type="file",c.accept=".ndjson,text/plain,application/x-ndjson",c.onchange=async()=>{let l=c.files&&c.files[0];if(!l){n();return}try{let f=(await l.text()).split(/\r?\n/).filter(Boolean),o=[];for(let u of f)try{o.push(JSON.parse(u))}catch{}if(!o.length){alert("\u6709\u52B9\u306ANDJSON\u304C\u8AAD\u307F\u53D6\u308C\u307E\u305B\u3093\u3067\u3057\u305F\u3002"),n();return}typeof D=="function"?(D(o),I(o)):(localStorage.setItem(e,JSON.stringify(o)),location.reload()),alert("\u30A4\u30F3\u30DD\u30FC\u30C8\u304C\u5B8C\u4E86\u3057\u307E\u3057\u305F\u3002")}catch(d){console.error(d),alert("\u30A4\u30F3\u30DD\u30FC\u30C8\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002")}finally{n()}},c.click()}window.manualDriveSync=async function(){try{!window.accessToken&&typeof window.refreshAccessTokenSilent=="function"&&await window.refreshAccessTokenSilent();let l=((typeof h=="function"?h():JSON.parse(localStorage.getItem(e)||"[]"))||[]).map(f=>JSON.stringify(f)).join(`
`);if(typeof window.driveFindFileIdByName!="function"){alert("Drive API \u30D8\u30EB\u30D1\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\uFF08driveFindFileIdByName \u7B49\uFF09\u3002index.html \u306EGIS\u30D8\u30EB\u30D1\u633F\u5165\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002");return}let d=await window.driveFindFileIdByName("mofu_entries.ndjson");d?await window.driveUpdateFile(d,l):d=await window.driveCreateFile("mofu_entries.ndjson",l),alert("Google Drive \u540C\u671F\u304C\u5B8C\u4E86\u3057\u307E\u3057\u305F\u3002")}catch(c){console.error(c),alert("Drive \u540C\u671F\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002\u5148\u306B Google\u30ED\u30B0\u30A4\u30F3 \u3092\u5B9F\u884C\u3057\u3066\u304F\u3060\u3055\u3044\u3002")}};function a(){let c=t("#loginMi"),l="#importMi",d="#exportMi",f=document.querySelector(l),o=document.querySelector(d);c&&c.addEventListener("click",p),f&&f.addEventListener("click",r),o&&o.addEventListener("click",s)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",a):a()})();(()=>{let e=o=>document.querySelector(o),t=o=>Array.from(document.querySelectorAll(o));function i(){let o=e("#ta");if(!o)return;let u=(o.value||"").trim();if(!u){alert("\u30E1\u30E2\u5185\u5BB9\u304C\u7A7A\u3067\u3059\u3002\u30C6\u30AD\u30B9\u30C8\u30A8\u30EA\u30A2\u306B\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002"),o.focus();return}typeof R=="function"?(R(u),o.value="",typeof window.updateDropdown=="function"&&window.updateDropdown(),o.focus()):alert("addEntry() \u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3002app.js \u306E\u30ED\u30FC\u30C9\u9806\u3092\u78BA\u8A8D\u3057\u3066\u304F\u3060\u3055\u3044\u3002")}function n(){let o=e("#ta");if(!o)return;let u=o.selectionStart??o.value.length,g=o.selectionEnd??o.value.length,v=o.value.slice(0,u),S=o.value.slice(g);o.value=v+"/"+S;let m=u+1;o.setSelectionRange(m,m),o.focus(),typeof window.updateDropdown=="function"&&window.updateDropdown()}function p(){let o=e("#searchDlg");if(!o)return;r("race"),typeof o.showModal=="function"?o.showModal():o.setAttribute("open","");let u=e("#raceSearchInput");if(u&&u.focus(),!Array.isArray(window.DAYCARDS)||!window.DAYCARDS.length){let g=e("#raceSuggest");g&&(g.innerHTML='<div class="muted small">\u5F53\u65E5\u306E\u30EC\u30FC\u30B9\u60C5\u5831\u3092\u53D6\u5F97\u3067\u304D\u3066\u3044\u307E\u305B\u3093\uFF08\u30CD\u30C3\u30C8\u63A5\u7D9A/\u30C7\u30FC\u30BF\u53D6\u5F97\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\uFF09\u3002</div>')}}function s(){let o=e("#searchDlg");o&&(typeof o.close=="function"?o.close():o.removeAttribute("open"))}function r(o){let u=e("#tabRace"),g=e("#tabFull"),v=e("#panelRace"),S=e("#panelFull");if(!(!u||!g||!v||!S))if(o==="race"){u.classList.add("is-active"),g.classList.remove("is-active"),v.classList.add("is-active"),S.classList.remove("is-active");let m=e("#raceSearchInput");m&&m.focus()}else{g.classList.add("is-active"),u.classList.remove("is-active"),S.classList.add("is-active"),v.classList.remove("is-active");let m=e("#searchInput");m&&m.focus(),l()}}function a(){let o=e("#raceSuggest"),u=(e("#raceSearchInput")?.value||"").trim();if(!o)return;if(!Array.isArray(window.DAYCARDS)||!window.DAYCARDS.length){o.innerHTML='<div class="muted small">\u30C7\u30FC\u30BF\u672A\u53D6\u5F97\u306E\u305F\u3081\u691C\u7D22\u3067\u304D\u307E\u305B\u3093\u3002</div>';return}if(!u){o.innerHTML='<div class="muted small">\u4F1A\u5834\u540D\u3084\u300C7R\u300D\u300C12R\u300D\u306A\u3069\u3092\u5165\u529B\u3059\u308B\u3068\u30B5\u30B8\u30A7\u30B9\u30C8\u3057\u307E\u3059\u3002</div>';return}let g=window.DAYCARDS.length;o.innerHTML=`<div class="muted small">\u5F53\u65E5\u30EC\u30FC\u30B9\u30C7\u30FC\u30BF ${g} \u4EF6\u3092\u8AAD\u307F\u8FBC\u307F\u6E08\u307F\uFF08\u8A73\u7D30\u30B5\u30B8\u30A7\u30B9\u30C8\u306F\u6B21\u306E\u66F4\u65B0\u3067\u62E1\u5F35\u4E88\u5B9A\uFF09\u3002</div>`}function c(o){let u=e("#newMemoText");e("#newMemoBox")?.style&&(e("#newMemoBox").style.display="block"),u&&(u.value=o||"",u.focus())}function l(){let o=(e("#searchInput")?.value||"").trim().toLowerCase(),u=e("#searchList"),g=e("#searchCount");if(!u||!g)return;let v=typeof h=="function"?h():[];if(!o){g.textContent="",u.innerHTML="";return}let S=v.filter(m=>(m.raw||"").toLowerCase().includes(o));g.textContent=`${S.length} \u4EF6\u30D2\u30C3\u30C8`,u.innerHTML=S.map(m=>{let B=(m.at||"").replace("T"," ").slice(0,16),$=(m.raw||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return`<div class="card"><div class="head"><span class="date">${B}</span></div><div class="raw">${$}</div></div>`}).join("")}function d(){let o=e("#newMemoText");if(!o)return;let u=(o.value||"").trim();if(!u){alert("\u30E1\u30E2\u5185\u5BB9\u304C\u7A7A\u3067\u3059");return}typeof R=="function"&&(R(u),o.value="")}function f(){e("#addBtn")?.addEventListener("click",i),e("#inlineSlash")?.addEventListener("click",n),e("#openSearch")?.addEventListener("click",p),e("#searchClose")?.addEventListener("click",s),e("#tabRace")?.addEventListener("click",()=>r("race")),e("#tabFull")?.addEventListener("click",()=>r("full")),e("#raceSearchInput")?.addEventListener("input",a),e("#raceSearchClear")?.addEventListener("click",()=>{let o=e("#raceSearchInput");o&&(o.value=""),a()}),e("#searchInput")?.addEventListener("input",l),a()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f()})();})();
