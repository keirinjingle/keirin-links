(()=>{var R=(document.querySelector('meta[name="mofu:google-client-id"]')?.content||"").trim(),le=(document.querySelector('meta[name="mofu:allowed-origins"]')?.content||"").split(",").map(e=>e.trim()).filter(Boolean),Ne=!le.length||le.includes(location.origin),c=document.getElementById("ta"),u=document.getElementById("dropdown"),K=document.getElementById("riderStatus"),W=document.getElementById("raceStatus"),w="mofu:entries:mvp2",p=null,S=!0,re=!1,Y=!1,y=-1,Oe=[],v=0,je=200;var Ae=e=>String(e).padStart(2,"0"),b=()=>{let e=new Date,t=e.getTimezoneOffset()*6e4;return new Date(e.getTime()-t).toISOString().slice(0,10).replace(/-/g,"")},D=()=>{let e=new Date,t=e.getTimezoneOffset()*6e4;return new Date(e.getTime()-t).toISOString().slice(0,10)},xe=(e,t)=>!/^\d{8}$/.test(e)||!/^\d{2}:\d{2}$/.test(t)?null:`${e.slice(0,4)}-${e.slice(4,6)}-${e.slice(6)}T${t}:00+09:00`,C=e=>(e||"").normalize("NFKC").replace(/\s+/g," ").trim(),de=e=>C(e).replace(/\s+/g,""),Pe={\u795E\u5948:"\u795E\u5948\u5DDD",\u5317\u6D77:"\u5317\u6D77\u9053",\u9E7F\u5150:"\u9E7F\u5150\u5CF6",\u5FB3\u5CF6:"\u5FB3\u5CF6",\u7FA4\u99AC:"\u7FA4\u99AC",\u5343\u8449:"\u5343\u8449",\u57FC\u7389:"\u57FC\u7389",\u6771\u4EAC:"\u6771\u4EAC",\u798F\u5CF6:"\u798F\u5CF6",\u9752\u68EE:"\u9752\u68EE",\u5CA9\u624B:"\u5CA9\u624B",\u5BAE\u57CE:"\u5BAE\u57CE",\u79CB\u7530:"\u79CB\u7530",\u5C71\u5F62:"\u5C71\u5F62",\u8328\u57CE:"\u8328\u57CE",\u6803\u6728:"\u6803\u6728",\u65B0\u6F5F:"\u65B0\u6F5F",\u5BCC\u5C71:"\u5BCC\u5C71",\u77F3\u5DDD:"\u77F3\u5DDD",\u798F\u4E95:"\u798F\u4E95",\u5C71\u68A8:"\u5C71\u68A8",\u9577\u91CE:"\u9577\u91CE",\u5C90\u961C:"\u5C90\u961C",\u9759\u5CA1:"\u9759\u5CA1",\u611B\u77E5:"\u611B\u77E5",\u4E09\u91CD:"\u4E09\u91CD",\u6ECB\u8CC0:"\u6ECB\u8CC0",\u4EAC\u90FD:"\u4EAC\u90FD",\u5927\u962A:"\u5927\u962A",\u5175\u5EAB:"\u5175\u5EAB",\u5948\u826F:"\u5948\u826F",\u548C\u6B4C\u5C71:"\u548C\u6B4C\u5C71",\u9CE5\u53D6:"\u9CE5\u53D6",\u5CF6\u6839:"\u5CF6\u6839",\u5CA1\u5C71:"\u5CA1\u5C71",\u5E83\u5CF6:"\u5E83\u5CF6",\u5C71\u53E3:"\u5C71\u53E3",\u9999\u5DDD:"\u9999\u5DDD",\u611B\u5A9B:"\u611B\u5A9B",\u9AD8\u77E5:"\u9AD8\u77E5",\u798F\u5CA1:"\u798F\u5CA1",\u4F50\u8CC0:"\u4F50\u8CC0",\u9577\u5D0E:"\u9577\u5D0E",\u718A\u672C:"\u718A\u672C",\u5927\u5206:"\u5927\u5206",\u5BAE\u5D0E:"\u5BAE\u5D0E",\u6C96\u7E04:"\u6C96\u7E04"},M=e=>Pe[e]||e||"";function I(e,t,n){let a=e.querySelector(".mark");a.textContent=t?"\u2705":`\u2716${n?`(${n})`:""}`,e.classList.toggle("ok",!!t),e.classList.toggle("ng",!t)}var Fe="https://keirinjingle.github.io/keirin-links/senshuID.json",He=e=>`https://keirinjingle.github.io/keirin-links/data/keirin_race_list_${e}.json`,N=[],O=[];(function(){try{let t=w+":healthcheck";localStorage.setItem(t,"1"),localStorage.removeItem(t),S=!0}catch(t){console.warn("localStorage \u304C\u4F7F\u3048\u307E\u305B\u3093\uFF08\u30E1\u30E2\u30EA\u306E\u307F\u3067\u7D99\u7D9A\uFF09:",t),S=!1}})();var m=()=>{if(p)return p;try{if(!S)return p=[],p;let e=localStorage.getItem(w);if(!e)return p=[],p;let t=JSON.parse(e);return p=Array.isArray(t)?t:[],p}catch(e){console.warn("\u4FDD\u5B58\u30C7\u30FC\u30BF\u304C\u58CA\u308C\u3066\u3044\u308B\u305F\u3081\u521D\u671F\u5316\u3057\u307E\u3059\uFF08\u30D0\u30C3\u30AF\u30A2\u30C3\u30D7\u3092 :corrupt \u306B\u9000\u907F\uFF09\u3002",e);try{S&&localStorage.setItem(w+":corrupt",localStorage.getItem(w)||"")}catch{}return p=[],S&&localStorage.setItem(w,"[]"),p}},H=e=>{if(p=Array.isArray(e)?e:[],!S)return!1;try{return localStorage.setItem(w,JSON.stringify(p)),!0}catch(t){return console.warn("localStorage \u4FDD\u5B58\u306B\u5931\u6557\uFF08\u30E1\u30E2\u30EA\u306E\u307F\uFF09:",t),!1}};function Je(e){let t=(e||"").match(/(\d+)期/);return t?`${t[1]}\u671F`:e||""}async function Ue(){try{let e=await fetch(Fe,{cache:"no-cache"});if(!e.ok)throw new Error(`HTTP ${e.status}`);let t=await e.text(),n;try{n=JSON.parse(t)}catch{throw new Error("JSON parse error")}N=n.map(a=>({id:String(a.\u767B\u9332\u756A\u53F7||"").trim(),name:a.\u9078\u624B\u540D,ki:Je(a.\u671F),region:a.\u5730\u57DF||"",grade:a.\u7D1A||"",profile:(a.\u30D7\u30ED\u30D5\u30A3\u30FC\u30EBURL||"").replace("https://keirin.netkeiba.comhttps://","https://")})),I(K,!0)}catch(e){console.warn("\u9078\u624BDB\u53D6\u5F97\u5931\u6557:",e),N=[],I(K,!1,e.message||"fetch error")}}async function Ge(){try{let e=He(b()),t=await fetch(e,{cache:"no-cache"});if(!t.ok)throw new Error(`HTTP ${t.status}`);let n=await t.text(),a;try{a=JSON.parse(n)}catch{throw new Error("JSON parse error")}O=Array.isArray(a)?a:[],I(W,!0)}catch(e){console.warn("\u5F53\u65E5\u30EC\u30FC\u30B9\u53D6\u5F97\u5931\u6557:",e),O=[],I(W,!1,e.message||"fetch error")}}function ke(e,t){let n=e.slice(0,t).match(/(^|\s)\/(\S*)$/);return n?{token:n[2],start:t-n[2].length-1,end:t}:null}function Ve(){let e=u.querySelectorAll(".item");e.forEach((n,a)=>n.classList.toggle("is-active",a===y));let t=e[y];if(t){let n=t.getBoundingClientRect(),a=u.getBoundingClientRect();(n.top<a.top||n.bottom>a.bottom)&&t.scrollIntoView({block:"nearest"})}}function ue(e){let t=u.querySelectorAll(".item").length;t&&(y<0&&(y=0),y=(y+e+t)%t,Ve())}function Ie(e){let t=ke(c.value,v);if(!t){u.style.display="none",y=-1;return}let n=Oe[e];if(!n){u.style.display="none",y=-1;return}let a="";n.type==="tactic"?a="#"+n.t:n.type==="riderDb"?a="@"+n.r.name:n.type==="race"?a=`- ${n.v.venue}${n.r.race_number}R`:n.type==="rider"?a="@"+n.name:a="+"+n.tag;let r=c.value.slice(0,t.start),s=c.value.slice(t.end),o=r&&!/\s$/.test(r),l=s&&!/^\s/.test(s),i=(o?" ":"")+a+(l?" ":"");c.value=r+i+s;let f=(r+i).length;c.setSelectionRange(f,f),v=f,u.style.display="none",y=-1,c.focus()}c.addEventListener("compositionstart",()=>{re=!0});c.addEventListener("compositionend",()=>{re=!1,v=c.selectionStart,updateDropdown(),Y=!0,setTimeout(()=>Y=!1,je)});c.addEventListener("input",()=>{v=c.selectionStart,updateDropdown()});c.addEventListener("keyup",e=>{v=c.selectionStart,e.key==="/"&&!re&&updateDropdown()});c.addEventListener("click",()=>{v=c.selectionStart});document.addEventListener("selectionchange",()=>{document.activeElement===c&&(v=c.selectionStart)});c.addEventListener("keydown",e=>{if(!(e.isComposing||(v=c.selectionStart,u.style.display!=="block")||!ke(c.value,v)))if(e.key==="ArrowDown")e.preventDefault(),ue(1);else if(e.key==="ArrowUp")e.preventDefault(),ue(-1);else if(e.key==="Enter"||e.key==="Tab"){if(Y)return;e.preventDefault(),y>=0&&Ie(y)}else e.key==="Escape"&&(e.preventDefault(),u.style.display="none",y=-1)});var g=null,me=6;u.addEventListener("pointerdown",e=>{let t=e.target.closest(".item");if(!t){g=null;return}g={idx:parseInt(t.dataset.i,10),x:e.clientX,y:e.clientY,dragged:!1}});u.addEventListener("pointermove",e=>{g&&(Math.abs(e.clientX-g.x)>me||Math.abs(e.clientY-g.y)>me)&&(g.dragged=!0)});u.addEventListener("scroll",()=>{g&&(g.dragged=!0)});u.addEventListener("pointerup",e=>{if(!g)return;let t=e.target.closest(".item"),n=t?parseInt(t.dataset.i,10):g.idx,a=g.dragged;g=null,a||(e.preventDefault(),e.stopPropagation(),Ie(n))});u.addEventListener("pointercancel",()=>{g=null});document.getElementById("inlineSlash").addEventListener("click",e=>{e.stopPropagation(),c.focus();let t=c.selectionStart;c.setRangeText("/",t,t,"end"),v=c.selectionStart,updateDropdown()});function Le(e,t=null){let n={id:Date.now().toString(36)+Math.random().toString(16).slice(2),at:new Date().toISOString(),raw:e};t&&typeof t=="object"&&(n.entities=t);let a=m().slice();a.push(n);let r=H(a);$(a),V(),r||alert("\u6CE8\u610F\uFF1A\u3053\u306E\u74B0\u5883\u3067\u306F\u4FDD\u5B58\u304C\u5236\u9650\u3055\u308C\u3066\u3044\u308B\u53EF\u80FD\u6027\u304C\u3042\u308A\u307E\u3059\uFF08\u30D7\u30E9\u30A4\u30D9\u30FC\u30C8\u30E2\u30FC\u30C9\u7B49\uFF09\u3002")}function ze(e,t){let n=m().slice(),a=n.findIndex(s=>s.id===e);if(a<0)return;n[a]={...n[a],raw:t,at:new Date().toISOString()};let r=H(n);$(n),V(),r||alert("\u6CE8\u610F\uFF1A\u3053\u306E\u74B0\u5883\u3067\u306F\u4FDD\u5B58\u304C\u5236\u9650\u3055\u308C\u3066\u3044\u307E\u3059\u3002")}function Ke(e){let t=m().filter(a=>a.id!==e),n=H(t);$(t),V(),n||alert("\u6CE8\u610F\uFF1A\u3053\u306E\u74B0\u5883\u3067\u306F\u4FDD\u5B58\u304C\u5236\u9650\u3055\u308C\u3066\u3044\u307E\u3059\u3002")}document.getElementById("addBtn").addEventListener("click",e=>{e.stopPropagation();let t=c.value.trim();if(!t){alert("\u30C6\u30AD\u30B9\u30C8\u304C\u7A7A\u3067\u3059");return}Le(t),c.value="",u.style.display="none"});function se(e){let t=(e||"").match(/-\s*([\u3040-\u30ff\u4e00-\u9fafA-Za-z]+)(\d{1,2})R/);if(!t)return null;let n=t[1],a=parseInt(t[2],10),r=(O||[]).find(i=>i.venue===n);if(!r)return{venue:n,raceNo:a,entry:null,result:null,date:D()};let s=(r.races||[]).find(i=>i.race_number===a);if(!s)return{venue:n,raceNo:a,entry:null,result:null,date:D()};let o=s.race_url||s.url||null,l=s.result_url||(o&&o.includes("/entry/")?o.replace("/entry/","/result/"):null);return{venue:n,raceNo:a,entry:o,result:l,date:r.date?`${r.date.slice(0,4)}-${r.date.slice(4,6)}-${r.date.slice(6)}`:D()}}function We(e){return e=e.replace(/@([^\s@#\+（）()]+)/g,(t,n)=>`<a href="#" class="riderLink" data-q="@${n}">@${n}</a>`),e=e.replace(/\+("[^"]+"|[\w\u3040-\u30ff\u4e00-\u9faf]+)/g,t=>`<a href="#" class="tagLink" data-q="${t}">${t}</a>`),e}function $(e){let t=document.getElementById("cards"),n=(e??m()).slice().reverse();t.innerHTML=n.map(a=>{let r=(a.at||"").slice(0,10),s=se(a.raw||""),o=s&&(s.entry||s.result)?`
      <a href="${s.entry||"#"}" ${s.entry?'target="_blank" rel="noopener"':""}>[\u51FA\u8D70\u8868]</a>
      ${s.result?`<a href="${s.result}" target="_blank" rel="noopener">[\u7D50\u679C]</a>`:""}
    `:"",l=We((a.raw||"").replace(/</g,"&lt;")),i=`<div style="margin-left:auto;display:flex;gap:.4rem">
      <button class="linklike editBtn" data-id="${a.id}">\u7DE8\u96C6</button>
      <button class="linklike delBtn" data-id="${a.id}">\u524A\u9664</button></div>`;return`<div class="card" id="card_${a.id}">
      <div class="head"><span class="date">${s?`${s.date} ${s.venue}${s.raceNo}R`:r}</span> ${o} ${i}</div>
      <div class="raw">${l}</div></div>`}).join("")||'<div class="card" style="color:#9ca3af">\uFF08\u307E\u3060\u30E1\u30E2\u304C\u3042\u308A\u307E\u305B\u3093\uFF09</div>'}$(m());document.body.addEventListener("click",e=>{let t=e.target.closest(".editBtn"),n=e.target.closest(".delBtn"),a=e.target.closest("a.riderLink"),r=e.target.closest("a.tagLink");if(t){let s=t.dataset.id,o=m().find(i=>i.id===s);if(!o)return;let l=prompt("\u30E1\u30E2\u3092\u7DE8\u96C6",o.raw||"");if(l==null)return;ze(s,l);return}if(n){let s=n.dataset.id;confirm("\u3053\u306E\u30E1\u30E2\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F")&&Ke(s);return}a&&(e.preventDefault(),j(""),B("full"),_.value=a.dataset.q,X()),r&&(e.preventDefault(),j(""),B("full"),_.value=r.dataset.q,X())});var J=document.getElementById("searchDlg"),_=document.getElementById("searchInput");document.getElementById("openSearch").addEventListener("click",()=>{j("")});document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="k"&&(e.preventDefault(),j(""))});function j(e){_.value=e||"",document.getElementById("searchList").innerHTML="",document.getElementById("searchCount").textContent="",B("race"),J.showModal(),_e()}document.getElementById("searchClose").addEventListener("click",()=>J.close());var fe=null;_.addEventListener("input",()=>{clearTimeout(fe),fe=setTimeout(X,200)});function Ye(e){let n=[...e].sort((r,s)=>s.length-r.length).map(r=>r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"));if(!n.length)return r=>r;let a=new RegExp("("+n.join("|")+")","gi");return r=>r.replace(a,'<span class="hl">$1</span>')}function Xe(e,t){if(!t.length)return e.slice(0,120);let n=t[0],a=e.toLowerCase().indexOf(n.toLowerCase()),r=a>=0?a:0,s=Math.max(0,r-40),o=Math.min(e.length,r+80);return(s>0?"\u2026":"")+e.slice(s,o)+(o<e.length?"\u2026":"")}function X(){let e=(_.value||"").trim(),t=m(),n=e?t.filter(o=>(o.raw||"").includes(e)):t.slice();n.sort((o,l)=>(l.at||"").localeCompare(o.at||""));let a=e?[e]:[],r=Ye(a),s=n.slice(0,200).map(o=>{let l=se(o.raw||""),i=l?`${l.date} ${l.venue}${l.raceNo}R`:(o.at||"").slice(0,10),f=Xe(o.raw,a).replace(/</g,"&lt;");return`<div class="card result-item">
      <div class="head"><span class="date">${i}</span>
        <button class="linklike openCardBtn" data-id="${o.id}">\u8868\u793A</button></div>
      <div class="raw">${r(f)}</div>
    </div>`}).join("")||'<div class="card" style="color:#9ca3af">\uFF08\u8A72\u5F53\u306A\u3057\uFF09</div>';document.getElementById("searchList").innerHTML=s,document.getElementById("searchCount").textContent=`${n.length} \u4EF6`,document.getElementById("searchList").onclick=o=>{let l=o.target.closest(".openCardBtn");if(!l)return;let i=l.dataset.id;J.close();let f=document.getElementById("card_"+i);f&&f.scrollIntoView({behavior:"smooth",block:"center"})}}var q=document.getElementById("tabFull"),Z=document.getElementById("tabRace"),pe=document.getElementById("panelFull"),ge=document.getElementById("panelRace");function B(e){e==="full"?(q.classList.add("is-active"),Z.classList.remove("is-active"),pe.classList.add("is-active"),ge.classList.remove("is-active")):(Z.classList.add("is-active"),q.classList.remove("is-active"),ge.classList.add("is-active"),pe.classList.remove("is-active"))}q.addEventListener("click",()=>B("full"));Z.addEventListener("click",()=>{B("race"),_e(),oe()});var U=document.getElementById("raceSearchInput"),A=document.getElementById("raceSuggest"),qe=document.getElementById("raceSearchClear"),ye=document.getElementById("raceView"),Ze=document.getElementById("raceHead"),ve=document.getElementById("raceEntryLink"),z=document.getElementById("raceResultLink"),he=document.getElementById("playerList"),be=document.getElementById("playerNotesWrap"),Qe=document.getElementById("playerNotesHead"),we=document.getElementById("playerNotes"),x=document.getElementById("newMemoWrap"),Q=document.getElementById("newMemoTa"),et=document.getElementById("saveMemoBtn"),tt=document.getElementById("cancelMemoBtn");function _e(){setTimeout(()=>U.focus(),0)}function nt(){let e=[];for(let t of O)for(let n of t.races||[])e.push({label:`${t.venue}${n.race_number}R`,venue:t.venue,race_number:n.race_number,date:t.date,jo_code:t.jo_code||"",race_url:n.race_url||n.url||"",result_url:n.result_url||null,start_time:n.start_time||"",closed_at:n.closed_at||"",class_category:n.class_category||"",players:n.players||[]});return e}function oe(){let e=C(U.value||""),t=nt(),a=(e?t.filter(r=>C(r.label).includes(e)||C(r.venue).includes(e)):t).slice(0,100);A.innerHTML=a.map((r,s)=>`
    <div class="row" data-i="${s}">
      <strong>${r.label}</strong>
      <span class="muted small">\uFF08${r.date?`${r.date.slice(0,4)}-${r.date.slice(4,6)}-${r.date.slice(6)}`:"\u2014"}\uFF09</span>
      ${r.class_category?`<span class="pill">${r.class_category}</span>`:""}
    </div>
  `).join("")||'<div class="muted small" style="padding:.5rem">\uFF08\u5F53\u65E5\u306E\u30EC\u30FC\u30B9\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\uFF09</div>',A.dataset.rows=JSON.stringify(a)}U.addEventListener("input",()=>oe());qe.addEventListener("click",()=>{U.value="",oe()});A.addEventListener("click",e=>{let t=e.target.closest(".row");if(!t)return;let a=JSON.parse(A.dataset.rows||"[]")[parseInt(t.dataset.i,10)];a&&rt(a)});var ee=null,P=null;function at(e){return`${e.date||b()}-${e.jo_code||"jo"}-${Ae(e.race_number)}`}function rt(e){ee=e,P=null,ye.style.display="block";let t=e.date?`${e.date.slice(0,4)}-${e.date.slice(4,6)}-${e.date.slice(6)}`:D();Ze.textContent=`${t} ${e.venue}${e.race_number}R`,ve.href=e.race_url||"#",ve.style.display=e.race_url?"inline-flex":"none",e.result_url?(z.href=e.result_url,z.style.display="inline-flex"):z.style.display="none";let n=e.players||[];he.innerHTML=n.map((a,r)=>{let s=M(a.region||""),o=a.term?`${a.term}\u671F`:"";return`<div class="player-item" data-i="${r}">
      <div><strong>@${(a.name||"").trim()}</strong> <span class="muted small">${s} ${o}</span></div>
    </div>`}).join("")||'<div class="muted small">\uFF08\u51FA\u8D70\u8868\u306B\u9078\u624B\u60C5\u5831\u304C\u3042\u308A\u307E\u305B\u3093\uFF09</div>',he.onclick=a=>{let r=a.target.closest(".player-item");if(!r)return;let s=parseInt(r.dataset.i,10),o=(e.players||[])[s];o&&st(e,o)},be.style.display="none",x.style.display="none",ye.scrollIntoView({behavior:"smooth",block:"start"})}function st(e,t){P=t;let n=(t.name||"").trim();Qe.textContent=`@${n} \u306E\u904E\u53BB\u30E1\u30E2`;let a=Be(t);Te(a),Q.value=`- ${e.venue}${e.race_number}R  @${n}`,x.style.display="block",be.style.display="block",x.scrollIntoView({behavior:"smooth",block:"start"})}function Be(e){let t=m(),n=Re(e);return t.filter(a=>!!(n&&a.entities?.players&&Array.isArray(a.entities.players)&&a.entities.players.some(r=>r.id&&String(r.id)===String(n))||(a.raw||"").includes("@"+(e.name||"").trim()))).sort((a,r)=>(r.at||"").localeCompare(a.at||""))}function Te(e){if(!e.length){we.innerHTML='<div class="muted small" style="padding:.3rem .2rem">\u3053\u306E\u9078\u624B\u306B\u95A2\u3059\u308B\u30E1\u30E2\u306F\u3042\u308A\u307E\u305B\u3093</div>';return}we.innerHTML=e.slice(0,20).map(t=>{let n=se(t.raw||""),a=n?`${n.date} ${n.venue}${n.raceNo}R`:(t.at||"").slice(0,10),r=(t.raw||"").replace(/</g,"&lt;");return`<div class="note">
      <div class="small muted">${a}</div>
      <div class="raw">${r}</div>
    </div>`}).join("")}et.addEventListener("click",()=>{if(!ee||!P){alert("\u30EC\u30FC\u30B9\u3068\u9078\u624B\u3092\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044");return}let e=Q.value.trim();if(!e){alert("\u30C6\u30AD\u30B9\u30C8\u304C\u7A7A\u3067\u3059");return}let t=ee,n=P,a=at(t),r=Re(n),s={race:{uid:a,date:t.date||b(),venue:t.venue,jo_code:t.jo_code||"",race_number:t.race_number,start_at_iso:xe(t.date||b(),t.start_time||"00:00")},players:[{id:r||null,name:(n.name||"").trim(),region:M(n.region||""),term:n.term||null}]};Le(e,s);let o=Be(n);Te(o),Q.value=`- ${t.venue}${t.race_number}R  @${(n.name||"").trim()}`,J.close()});tt.addEventListener("click",()=>{x.style.display="none"});function Re(e){if(!N.length)return null;let t=de(e.name||""),n=e.term?`${e.term}\u671F`:null,a=M(e.region||""),r=N.filter(s=>de(s.name)===t);return n&&(r=r.filter(s=>(s.ki||"")===n)),a&&(r=r.filter(s=>M(s.region)===a)),r.length===1?r[0].id:null}var De=document.getElementById("settingsBtn"),E=document.getElementById("settingsMenu");De.addEventListener("click",e=>{e.stopPropagation(),E.style.display=E.style.display==="block"?"none":"block"});document.addEventListener("click",e=>{!E.contains(e.target)&&e.target!==De&&(E.style.display="none")});document.getElementById("loginMi").addEventListener("click",async()=>{E.style.display="none",await lt()&&k.requestAccessToken({prompt:"consent"})});document.getElementById("importMi").addEventListener("click",()=>{E.style.display="none";let e=Object.assign(document.createElement("input"),{type:"file",accept:".ndjson,.jsonl"});e.onchange=async()=>{let n=(await e.files[0].text()).split(/\r?\n/).filter(Boolean),a=[],r=0;for(let i of n)try{a.push(JSON.parse(i))}catch{r++}let s=m(),o=new Set(s.map(i=>i.id));for(let i of a)i&&!o.has(i.id)&&(s.push(i),o.add(i.id));let l=H(s);$(s),alert(`\u30A4\u30F3\u30DD\u30FC\u30C8\u5B8C\u4E86\uFF08\u65B0\u898F ${a.length-r} \u4EF6\uFF0F\u58CA\u308C\u884C ${r} \u4EF6\uFF09`),V(),l||alert("\u6CE8\u610F\uFF1A\u3053\u306E\u74B0\u5883\u3067\u306F\u4FDD\u5B58\u304C\u5236\u9650\u3055\u308C\u3066\u3044\u307E\u3059\u3002")},e.click()});document.getElementById("exportMi").addEventListener("click",()=>{E.style.display="none";let e=m().map(a=>JSON.stringify(a)).join(`
`),t=new Blob([e],{type:"application/x-ndjson"}),n=Object.assign(document.createElement("a"),{href:URL.createObjectURL(t),download:`mofu_${b()}.ndjson`});n.click(),URL.revokeObjectURL(n.href)});var F="mofu_entries.ndjson",k=null,T=null,d=null,Ee=!1,Ce="https://www.googleapis.com/auth/drive.appdata",ot=1200,$e=null;function G(){if(!T)throw new Error("no access token");return{Authorization:`Bearer ${T}`}}async function Me(){for(let e=0;e<50;e++){if(window.google?.accounts?.oauth2)return;await new Promise(t=>setTimeout(t,100))}throw new Error("GIS load fail")}async function te(e=F){let t=new URLSearchParams({spaces:"appDataFolder",q:`name='${e.replace(/'/g,"\\'")}' and trashed=false`,fields:"files(id,name)",pageSize:"1"}),n=await fetch(`https://www.googleapis.com/drive/v3/files?${t}`,{headers:G()});if(!n.ok)throw new Error(`Drive list failed ${n.status}`);return(await n.json()).files?.[0]?.id||null}async function ct(e){let t=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:G()});if(!t.ok)throw new Error(`Drive download failed ${t.status}`);return await t.text()}async function ne(e,t){let n={name:e,parents:["appDataFolder"]},a="mofu_"+Math.random().toString(16).slice(2),r=`--${a}\r
Content-Type: application/json; charset=UTF-8\r
\r
${JSON.stringify(n)}\r
--${a}\r
Content-Type: application/x-ndjson\r
\r
${t}\r
--${a}--`,s=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{...G(),"Content-Type":`multipart/related; boundary=${a}`},body:r});if(!s.ok)throw new Error(`Drive create failed ${s.status}`);return(await s.json()).id}async function L(e,t){let n=await fetch(`https://www.googleapis.com/upload/drive/v3/files/${e}?uploadType=media`,{method:"PATCH",headers:{...G(),"Content-Type":"application/x-ndjson"},body:t});if(!n.ok)throw new Error(`Drive update failed ${n.status}`)}function ae(e){return e.map(t=>JSON.stringify(t)).join(`
`)}function it(e){return e?e.split(/\r?\n/).filter(Boolean).map(t=>JSON.parse(t)):[]}function Se(e){return e.reduce((t,n)=>Math.max(t,Date.parse(n.at||0)||0),0)}async function lt(){try{await Me()}catch{return alert("Google\u306E\u30E9\u30A4\u30D6\u30E9\u30EA\u304C\u8AAD\u307F\u8FBC\u3081\u307E\u305B\u3093\u3067\u3057\u305F\u3002"),!1}return!R||!R.endsWith(".apps.googleusercontent.com")?(alert("Google\u30AF\u30E9\u30A4\u30A2\u30F3\u30C8ID\u304C\u672A\u8A2D\u5B9A\u304B\u4E0D\u6B63\u3067\u3059\u3002"),!1):Ne?(k||(k=google.accounts.oauth2.initTokenClient({client_id:R,scope:Ce,callback:async e=>{if(e.error){console.error(e),alert("Google\u63A5\u7D9A\u306B\u5931\u6557\u3057\u307E\u3057\u305F");return}T=e.access_token,Ee||(Ee=!0,await ut())}})),!0):(alert("\u3053\u306E\u30AA\u30EA\u30B8\u30F3\u3067\u306FDrive\u9023\u643A\u3092\u7121\u52B9\u5316\u3057\u3066\u3044\u307E\u3059\u3002"),!1)}async function dt(){return new Promise(async(e,t)=>{try{await Me(),k||(k=google.accounts.oauth2.initTokenClient({client_id:R,scope:Ce,callback:n=>{n.error?t(n):(T=n.access_token,e(n))}})),k.requestAccessToken({prompt:"none"})}catch(n){t(n)}})}async function ut(){try{d=await te();let e=[],t="";if(d){t=await ct(d);try{e=it(t)}catch{e=[]}}let n=m(),a=n.length,r=e.length,s=Se(n),o=Se(e),l=h=>h?new Date(h).toISOString().slice(0,19).replace("T"," "):"\u2014",i=`
      <div>\u30ED\u30FC\u30AB\u30EB\uFF1A<strong>${a}</strong> \u4EF6\uFF08\u6700\u7D42 ${l(s)}\uFF09</div>
      <div>\u30B5\u30FC\u30D0\u30FC\uFF1A<strong>${r}</strong> \u4EF6\uFF08\u6700\u7D42 ${l(o)}\uFF09</div>
      <div style="margin-top:6px;color:#6b7280">\u3069\u3061\u3089\u3092<strong>\u6B63</strong>\u3068\u3057\u3066\u53CD\u6620\u3057\u307E\u3059\u304B\uFF1F</div>
    `,f=document.getElementById("syncDlg");document.getElementById("syncSummary").innerHTML=i;let ce=await new Promise(h=>{function ie(){f.removeEventListener("close",ie),h(f.returnValue)}f.addEventListener("close",ie),f.showModal()});if(ce==="localToServer"){let h=ae(n);d?await L(d,h):d=await ne(F,h),alert("\u30B5\u30FC\u30D0\u30FC\u3078\u4E0A\u66F8\u304D\u3057\u307E\u3057\u305F\u3002\u4EE5\u5F8C\u306F\u81EA\u52D5\u540C\u671F\u3057\u307E\u3059\u3002")}else ce==="serverToLocal"?(localStorage.setItem(w,JSON.stringify(e)),p=e,$(e),alert("\u30ED\u30FC\u30AB\u30EB\u3078\u4E0A\u66F8\u304D\u3057\u307E\u3057\u305F\u3002\u4EE5\u5F8C\u306F\u81EA\u52D5\u540C\u671F\u3057\u307E\u3059\u3002")):alert("\u540C\u671F\u8A2D\u5B9A\u3092\u30AD\u30E3\u30F3\u30BB\u30EB\u3057\u307E\u3057\u305F\u3002\uFF08\u3044\u3064\u3067\u3082\u300C\u8A2D\u5B9A\u2192Google\u30ED\u30B0\u30A4\u30F3\u300D\u304B\u3089\u518D\u8A2D\u5B9A\u3067\u304D\u307E\u3059\uFF09")}catch(e){console.error(e),alert("\u540C\u671F\u521D\u671F\u8A2D\u5B9A\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002\u518D\u5EA6\u304A\u8A66\u3057\u304F\u3060\u3055\u3044\u3002")}}function V(){T&&(clearTimeout($e),$e=setTimeout(async()=>{try{let e=ae(m());d?await L(d,e):(d=await te(),d?await L(d,e):d=await ne(F,e))}catch(e){let t=String(e||"");if(t.includes("401")||t.includes("403"))try{await dt();let n=ae(m());d?await L(d,n):(d=await te(),d?await L(d,n):d=await ne(F,n))}catch(n){console.warn("Drive\u4FDD\u5B58\u5931\u6557\uFF08\u518D\u8A66\u884C\u3082\u5931\u6557\uFF09:",n)}else console.warn("Drive\u4FDD\u5B58\u5931\u6557:",e)}},ot))}(async()=>(I(K,!1,"\u2026"),I(W,!1,"\u2026"),$(m()),await Promise.allSettled([Ue(),Ge()]),v=c.selectionStart,updateDropdown()))();})();
