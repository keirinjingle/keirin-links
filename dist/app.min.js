(()=>{(function(){if(window.updateDropdown)return;let w=["\u4E09\u5206\u6226","\u4E8C\u5206\u6226","\u5358\u9A0E","\u5148\u884C\u4E00\u8ECA","\u307E\u304F\u308A","\u5DEE\u3057","\u30AB\u30DE\u30B7","\u81EA\u5728"];function x(m){return(m||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function X(m,i){let d=m.slice(0,i).match(/(^|\s)\/(\S*)$/);return d?{token:d[2],start:i-d[2].length-1,end:i}:null}function o(m){let i=(m||"").toLowerCase(),d=[];try{let p=window.DAYCARDS;if(Array.isArray(p)&&i.length)for(let f of p)for(let k of f.races||[])(`${f.venue}${k.race_number}R`.toLowerCase().includes(i)||(f.venue||"").toLowerCase().includes(i))&&d.push({type:"race",text:`- ${f.venue}${k.race_number}R`})}catch{}(i?w.filter(p=>p.toLowerCase().includes(i)):w).forEach(p=>d.push({type:"tactic",text:"#"+p}));try{let p=window.RIDERS;Array.isArray(p)&&i.length?p.filter(f=>((f.name||"")+" "+(f.region||"")+" "+(f.ki||"")).toLowerCase().includes(i)).slice(0,6).forEach(f=>d.push({type:"rider",text:"@"+f.name})):i.length&&d.push({type:"rider",text:"@"+m})}catch{i.length&&d.push({type:"rider",text:"@"+m})}return i.length&&d.push({type:"tag",text:"+"+m}),d.slice(0,60)}function g(m){let i=document.getElementById("dropdown");if(!i)return;if(!m||!m.length){i.style.display="none",i.innerHTML="";return}i.innerHTML=m.map((c,p)=>`<div class="item" data-i="${p}"><span class="type">${c.type==="race"?"\u30EC\u30FC\u30B9":c.type==="tactic"?"\u6226\u6CD5":c.type==="rider"?"\u9078\u624B":"\u30BF\u30B0"}</span> ${x(c.text)}</div>`).join(""),i.style.display="block",i.querySelectorAll(".item").forEach((c,p)=>c.classList.toggle("is-active",p===0))}window.updateDropdown=function(){let m=document.getElementById("ta");if(!m)return;let i=m.selectionStart||0,d=X(m.value,i);if(!d){g([]);return}let c=o(d.token);g(c)},document.addEventListener("click",m=>{let i=m.target.closest&&m.target.closest(".item");if(i){let d=parseInt(i.dataset.i,10),c=document.getElementById("ta"),p=c&&c.selectionStart?c.selectionStart:0}}),console.info("mofu: shim installed (src/shim.js)")})();(()=>{var w=(document.querySelector('meta[name="mofu:google-client-id"]')?.content||"").trim(),x=(document.querySelector('meta[name="mofu:allowed-origins"]')?.content||"").split(",").map(e=>e.trim()).filter(Boolean),X=!x.length||x.includes(location.origin),o=document.getElementById("ta"),g=document.getElementById("dropdown"),m=document.getElementById("riderStatus"),i=document.getElementById("raceStatus"),d="mofu:entries:mvp2",c=null,p=!0,f=!1,k=!1,C=-1,xe=[],h=0,Me=200,Re=e=>String(e).padStart(2,"0"),I=()=>{let e=new Date,t=e.getTimezoneOffset()*6e4;return new Date(e.getTime()-t).toISOString().slice(0,10).replace(/-/g,"")},M=()=>{let e=new Date,t=e.getTimezoneOffset()*6e4;return new Date(e.getTime()-t).toISOString().slice(0,10)},Oe=(e,t)=>!/^\d{8}$/.test(e)||!/^\d{2}:\d{2}$/.test(t)?null:`${e.slice(0,4)}-${e.slice(4,6)}-${e.slice(6)}T${t}:00+09:00`,R=e=>(e||"").normalize("NFKC").replace(/\s+/g," ").trim(),oe=e=>R(e).replace(/\s+/g,""),Ne={\u795E\u5948:"\u795E\u5948\u5DDD",\u5317\u6D77:"\u5317\u6D77\u9053",\u9E7F\u5150:"\u9E7F\u5150\u5CF6",\u5FB3\u5CF6:"\u5FB3\u5CF6",\u7FA4\u99AC:"\u7FA4\u99AC",\u5343\u8449:"\u5343\u8449",\u57FC\u7389:"\u57FC\u7389",\u6771\u4EAC:"\u6771\u4EAC",\u798F\u5CF6:"\u798F\u5CF6",\u9752\u68EE:"\u9752\u68EE",\u5CA9\u624B:"\u5CA9\u624B",\u5BAE\u57CE:"\u5BAE\u57CE",\u79CB\u7530:"\u79CB\u7530",\u5C71\u5F62:"\u5C71\u5F62",\u8328\u57CE:"\u8328\u57CE",\u6803\u6728:"\u6803\u6728",\u65B0\u6F5F:"\u65B0\u6F5F",\u5BCC\u5C71:"\u5BCC\u5C71",\u77F3\u5DDD:"\u77F3\u5DDD",\u798F\u4E95:"\u798F\u4E95",\u5C71\u68A8:"\u5C71\u68A8",\u9577\u91CE:"\u9577\u91CE",\u5C90\u961C:"\u5C90\u961C",\u9759\u5CA1:"\u9759\u5CA1",\u611B\u77E5:"\u611B\u77E5",\u4E09\u91CD:"\u4E09\u91CD",\u6ECB\u8CC0:"\u6ECB\u8CC0",\u4EAC\u90FD:"\u4EAC\u90FD",\u5927\u962A:"\u5927\u962A",\u5175\u5EAB:"\u5175\u5EAB",\u5948\u826F:"\u5948\u826F",\u548C\u6B4C\u5C71:"\u548C\u6B4C\u5C71",\u9CE5\u53D6:"\u9CE5\u53D6",\u5CF6\u6839:"\u5CF6\u6839",\u5CA1\u5C71:"\u5CA1\u5C71",\u5E83\u5CF6:"\u5E83\u5CF6",\u5C71\u53E3:"\u5C71\u53E3",\u9999\u5DDD:"\u9999\u5DDD",\u611B\u5A9B:"\u611B\u5A9B",\u9AD8\u77E5:"\u9AD8\u77E5",\u798F\u5CA1:"\u798F\u5CA1",\u4F50\u8CC0:"\u4F50\u8CC0",\u9577\u5D0E:"\u9577\u5D0E",\u718A\u672C:"\u718A\u672C",\u5927\u5206:"\u5927\u5206",\u5BAE\u5D0E:"\u5BAE\u5D0E",\u6C96\u7E04:"\u6C96\u7E04"},O=e=>Ne[e]||e||"";function S(e,t,u){let n=e.querySelector(".mark");n.textContent=t?"\u2705":`\u2716${u?`(${u})`:""}`,e.classList.toggle("ok",!!t),e.classList.toggle("ng",!t)}var He="https://keirinjingle.github.io/keirin-links/senshuID.json",Je=e=>`https://keirinjingle.github.io/keirin-links/data/keirin_race_list_${e}.json`,N=[],H=[];(function(){try{let e=d+":healthcheck";localStorage.setItem(e,"1"),localStorage.removeItem(e),p=!0}catch(e){console.warn("localStorage \u304C\u4F7F\u3048\u307E\u305B\u3093\uFF08\u30E1\u30E2\u30EA\u306E\u307F\u3067\u7D99\u7D9A\uFF09:",e),p=!1}})();var F=()=>{if(c)return c;try{if(!p)return c=[],c;let e=localStorage.getItem(d);if(!e)return c=[],c;let t=JSON.parse(e);return c=Array.isArray(t)?t:[],c}catch(e){console.warn("\u4FDD\u5B58\u30C7\u30FC\u30BF\u304C\u58CA\u308C\u3066\u3044\u308B\u305F\u3081\u521D\u671F\u5316\u3057\u307E\u3059\uFF08\u30D0\u30C3\u30AF\u30A2\u30C3\u30D7\u3092 :corrupt \u306B\u9000\u907F\uFF09\u3002",e);try{p&&localStorage.setItem(d+":corrupt",localStorage.getItem(d)||"")}catch{}return c=[],p&&localStorage.setItem(d,"[]"),c}},J=e=>{if(c=Array.isArray(e)?e:[],!p)return!1;try{return localStorage.setItem(d,JSON.stringify(c)),!0}catch(t){return console.warn("localStorage \u4FDD\u5B58\u306B\u5931\u6557\uFF08\u30E1\u30E2\u30EA\u306E\u307F\uFF09:",t),!1}};function Pe(e){let t=(e||"").match(/(\d+)æœŸ/);return t?`${t[1]}\u671F`:e||""}async function qe(){try{let e=await fetch(He,{cache:"no-cache"});if(!e.ok)throw new Error(`HTTP ${e.status}`);let t=await e.text(),u;try{u=JSON.parse(t)}catch{throw new Error("JSON parse error")}N=u.map(n=>({id:String(n.\u767B\u9332\u756A\u53F7||"").trim(),name:n.\u9078\u624B\u540D,ki:Pe(n.\u671F),region:n.\u5730\u57DF||"",grade:n.\u7D1A||"",profile:(n.\u30D7\u30ED\u30D5\u30A3\u30FC\u30EBURL||"").replace("https://keirin.netkeiba.comhttps://","https://")})),S(m,!0)}catch(e){console.warn("\u9078\u624BDB\u53D6\u5F97\u5931\u6557:",e),N=[],S(m,!1,e.message||"fetch error")}}async function Ue(){try{let e=Je(I()),t=await fetch(e,{cache:"no-cache"});if(!t.ok)throw new Error(`HTTP ${t.status}`);let u=await t.text(),n;try{n=JSON.parse(u)}catch{throw new Error("JSON parse error")}H=Array.isArray(n)?n:[],S(i,!0)}catch(e){console.warn("\u5F53\u65E5\u30EC\u30FC\u30B9\u53D6\u5F97\u5931\u6557:",e),H=[],S(i,!1,e.message||"fetch error")}}function ce(e,t){let u=e.slice(0,t).match(/(^|\s)\/(\S*)$/);return u?{token:u[2],start:t-u[2].length-1,end:t}:null}function ze(){let e=g.querySelectorAll(".item");e.forEach((u,n)=>u.classList.toggle("is-active",n===C));let t=e[C];if(t){let u=t.getBoundingClientRect(),n=g.getBoundingClientRect();(u.top<n.top||u.bottom>n.bottom)&&t.scrollIntoView({block:"nearest"})}}function de(e){let t=g.querySelectorAll(".item").length;t&&(C<0&&(C=0),C=(C+e+t)%t,ze())}function me(e){let t=ce(o.value,h);if(!t){g.style.display="none",C=-1;return}let u=xe[e];if(!u){g.style.display="none",C=-1;return}let n="";u.type==="tactic"?n="#"+u.t:u.type==="riderDb"?n="@"+u.r.name:u.type==="race"?n=`- ${u.v.venue}${u.r.race_number}R`:u.type==="rider"?n="@"+u.name:n="+"+u.tag;let a=o.value.slice(0,t.start),r=o.value.slice(t.end),l=a&&!/\s$/.test(a),s=r&&!/^\s/.test(r),y=(l?" ":"")+n+(s?" ":"");o.value=a+y+r;let B=(a+y).length;o.setSelectionRange(B,B),h=B,g.style.display="none",C=-1,o.focus()}o.addEventListener("compositionstart",()=>{f=!0}),o.addEventListener("compositionend",()=>{f=!1,h=o.selectionStart,updateDropdown(),k=!0,setTimeout(()=>k=!1,Me)}),o.addEventListener("input",()=>{h=o.selectionStart,updateDropdown()}),o.addEventListener("keyup",e=>{h=o.selectionStart,e.key==="/"&&!f&&updateDropdown()}),o.addEventListener("click",()=>{h=o.selectionStart}),document.addEventListener("selectionchange",()=>{document.activeElement===o&&(h=o.selectionStart)}),o.addEventListener("keydown",e=>{if(!(e.isComposing||(h=o.selectionStart,g.style.display!=="block")||!ce(o.value,h)))if(e.key==="ArrowDown")e.preventDefault(),de(1);else if(e.key==="ArrowUp")e.preventDefault(),de(-1);else if(e.key==="Enter"||e.key==="Tab"){if(k)return;e.preventDefault(),C>=0&&me(C)}else e.key==="Escape"&&(e.preventDefault(),g.style.display="none",C=-1)});var v=null,pe=6;g.addEventListener("pointerdown",e=>{let t=e.target.closest(".item");if(!t){v=null;return}v={idx:parseInt(t.dataset.i,10),x:e.clientX,y:e.clientY,dragged:!1}}),g.addEventListener("pointermove",e=>{v&&(Math.abs(e.clientX-v.x)>pe||Math.abs(e.clientY-v.y)>pe)&&(v.dragged=!0)}),g.addEventListener("scroll",()=>{v&&(v.dragged=!0)}),g.addEventListener("pointerup",e=>{if(!v)return;let t=e.target.closest(".item"),u=t?parseInt(t.dataset.i,10):v.idx,n=v.dragged;v=null,n||(e.preventDefault(),e.stopPropagation(),me(u))}),g.addEventListener("pointercancel",()=>{v=null}),document.getElementById("inlineSlash").addEventListener("click",e=>{e.stopPropagation(),o.focus();let t=o.selectionStart;o.setRangeText("/",t,t,"end"),h=o.selectionStart,updateDropdown()});function Ee(e,t=null){let u={id:Date.now().toString(36)+Math.random().toString(16).slice(2),at:new Date().toISOString(),raw:e};t&&typeof t=="object"&&(u.entities=t);let n=F().slice();n.push(u);let a=J(n);D(n),Y(),a||alert("\u6CE8\u610F\uFF1A\u3053\u306E\u74B0\u5883\u3067\u306F\u4FDD\u5B58\u304C\u5236\u9650\u3055\u308C\u3066\u3044\u308B\u53EF\u80FD\u6027\u304C\u3042\u308A\u307E\u3059\uFF08\u30D7\u30E9\u30A4\u30D9\u30FC\u30C8\u30E2\u30FC\u30C9\u7B49\uFF09\u3002")}function Ve(e,t){let u=F().slice(),n=u.findIndex(r=>r.id===e);if(n<0)return;u[n]={...u[n],raw:t,at:new Date().toISOString()};let a=J(u);D(u),Y(),a||alert("\u6CE8\u610F\uFF1A\u3053\u306E\u74B0\u5883\u3067\u306F\u4FDD\u5B58\u304C\u5236\u9650\u3055\u308C\u3066\u3044\u307E\u3059\u3002")}function Ge(e){let t=F().filter(n=>n.id!==e),u=J(t);D(t),Y(),u||alert("\u6CE8\u610F\uFF1A\u3053\u306E\u74B0\u5883\u3067\u306F\u4FDD\u5B58\u304C\u5236\u9650\u3055\u308C\u3066\u3044\u307E\u3059\u3002")}document.getElementById("addBtn").addEventListener("click",e=>{e.stopPropagation();let t=o.value.trim();if(!t){alert("\u30C6\u30AD\u30B9\u30C8\u304C\u7A7A\u3067\u3059");return}Ee(t),o.value="",g.style.display="none"});function Z(e){let t=(e||"").match(/-\s*([\u3040-\u30ff\u4e00-\u9fafA-Za-z]+)(\d{1,2})R/);if(!t)return null;let u=t[1],n=parseInt(t[2],10),a=(H||[]).find(y=>y.venue===u);if(!a)return{venue:u,raceNo:n,entry:null,result:null,date:M()};let r=(a.races||[]).find(y=>y.race_number===n);if(!r)return{venue:u,raceNo:n,entry:null,result:null,date:M()};let l=r.race_url||r.url||null,s=r.result_url||(l&&l.includes("/entry/")?l.replace("/entry/","/result/"):null);return{venue:u,raceNo:n,entry:l,result:s,date:a.date?`${a.date.slice(0,4)}-${a.date.slice(4,6)}-${a.date.slice(6)}`:M()}}function Ke(e){return e=e.replace(/@([^\s@#\+ï¼ˆï¼‰()]+)/g,(t,u)=>`<a href="#" class="riderLink" data-q="@${u}">@${u}</a>`),e=e.replace(/\+("[^"]+"|[\w\u3040-\u30ff\u4e00-\u9faf]+)/g,t=>`<a href="#" class="tagLink" data-q="${t}">${t}</a>`),e}function D(e){let t=document.getElementById("cards"),u=(e??F()).slice().reverse();t.innerHTML=u.map(n=>{let a=(n.at||"").slice(0,10),r=Z(n.raw||""),l=r&&(r.entry||r.result)?`
      <a href="${r.entry||"#"}" ${r.entry?'target="_blank" rel="noopener"':""}>[\u51FA\u8D70\u8868]</a>
      ${r.result?`<a href="${r.result}" target="_blank" rel="noopener">[\u7D50\u679C]</a>`:""}
    `:"",s=Ke((n.raw||"").replace(/</g,"&lt;")),y=`<div style="margin-left:auto;display:flex;gap:.4rem">
      <button class="linklike editBtn" data-id="${n.id}">\u7DE8\u96C6</button>
      <button class="linklike delBtn" data-id="${n.id}">\u524A\u9664</button></div>`;return`<div class="card" id="card_${n.id}">
      <div class="head"><span class="date">${r?`${r.date} ${r.venue}${r.raceNo}R`:a}</span> ${l} ${y}</div>
      <div class="raw">${s}</div></div>`}).join("")||'<div class="card" style="color:#9ca3af">\uFF08\u307E\u3060\u30E1\u30E2\u304C\u3042\u308A\u307E\u305B\u3093\uFF09</div>'}D(F()),document.body.addEventListener("click",e=>{let t=e.target.closest(".editBtn"),u=e.target.closest(".delBtn"),n=e.target.closest("a.riderLink"),a=e.target.closest("a.tagLink");if(t){let r=t.dataset.id,l=F().find(y=>y.id===r);if(!l)return;let s=prompt("\u30E1\u30E2\u3092\u7DE8\u96C6",l.raw||"");if(s==null)return;Ve(r,s);return}if(u){let r=u.dataset.id;confirm("\u3053\u306E\u30E1\u30E2\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F")&&Ge(r);return}n&&(e.preventDefault(),q(""),_("full"),b.value=n.dataset.q,Q()),a&&(e.preventDefault(),q(""),_("full"),b.value=a.dataset.q,Q())});var P=document.getElementById("searchDlg"),b=document.getElementById("searchInput");document.getElementById("openSearch").addEventListener("click",()=>{q("")}),document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="k"&&(e.preventDefault(),q(""))});function q(e){b.value=e||"",document.getElementById("searchList").innerHTML="",document.getElementById("searchCount").textContent="",_("race"),P.showModal(),we()}document.getElementById("searchClose").addEventListener("click",()=>P.close());var ge=null;b.addEventListener("input",()=>{clearTimeout(ge),ge=setTimeout(Q,200)});function We(e){let t=[...e].sort((n,a)=>a.length-n.length).map(n=>n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"));if(!t.length)return n=>n;let u=new RegExp("("+t.join("|")+")","gi");return n=>n.replace(u,'<span class="hl">$1</span>')}function Ye(e,t){if(!t.length)return e.slice(0,120);let u=t[0],n=e.toLowerCase().indexOf(u.toLowerCase()),a=n>=0?n:0,r=Math.max(0,a-40),l=Math.min(e.length,a+80);return(r>0?"\u2026":"")+e.slice(r,l)+(l<e.length?"\u2026":"")}function Q(){let e=(b.value||"").trim(),t=F(),u=e?t.filter(l=>(l.raw||"").includes(e)):t.slice();u.sort((l,s)=>(s.at||"").localeCompare(l.at||""));let n=e?[e]:[],a=We(n),r=u.slice(0,200).map(l=>{let s=Z(l.raw||""),y=s?`${s.date} ${s.venue}${s.raceNo}R`:(l.at||"").slice(0,10),B=Ye(l.raw,n).replace(/</g,"&lt;");return`<div class="card result-item">
      <div class="head"><span class="date">${y}</span>
        <button class="linklike openCardBtn" data-id="${l.id}">\u8868\u793A</button></div>
      <div class="raw">${a(B)}</div>
    </div>`}).join("")||'<div class="card" style="color:#9ca3af">\uFF08\u8A72\u5F53\u306A\u3057\uFF09</div>';document.getElementById("searchList").innerHTML=r,document.getElementById("searchCount").textContent=`${u.length} \u4EF6`,document.getElementById("searchList").onclick=l=>{let s=l.target.closest(".openCardBtn");if(!s)return;let y=s.dataset.id;P.close();let B=document.getElementById("card_"+y);B&&B.scrollIntoView({behavior:"smooth",block:"center"})}}var ee=document.getElementById("tabFull"),te=document.getElementById("tabRace"),ye=document.getElementById("panelFull"),fe=document.getElementById("panelRace");function _(e){e==="full"?(ee.classList.add("is-active"),te.classList.remove("is-active"),ye.classList.add("is-active"),fe.classList.remove("is-active")):(te.classList.add("is-active"),ee.classList.remove("is-active"),fe.classList.add("is-active"),ye.classList.remove("is-active"))}ee.addEventListener("click",()=>_("full")),te.addEventListener("click",()=>{_("race"),we(),ae()});var U=document.getElementById("raceSearchInput"),z=document.getElementById("raceSuggest"),Xe=document.getElementById("raceSearchClear"),Fe=document.getElementById("raceView"),Ze=document.getElementById("raceHead"),Ce=document.getElementById("raceEntryLink"),ue=document.getElementById("raceResultLink"),ve=document.getElementById("playerList"),Be=document.getElementById("playerNotesWrap"),Qe=document.getElementById("playerNotesHead"),he=document.getElementById("playerNotes"),V=document.getElementById("newMemoWrap"),ne=document.getElementById("newMemoTa"),et=document.getElementById("saveMemoBtn"),tt=document.getElementById("cancelMemoBtn");function we(){setTimeout(()=>U.focus(),0)}function ut(){let e=[];for(let t of H)for(let u of t.races||[])e.push({label:`${t.venue}${u.race_number}R`,venue:t.venue,race_number:u.race_number,date:t.date,jo_code:t.jo_code||"",race_url:u.race_url||u.url||"",result_url:u.result_url||null,start_time:u.start_time||"",closed_at:u.closed_at||"",class_category:u.class_category||"",players:u.players||[]});return e}function ae(){let e=R(U.value||""),t=ut(),u=(e?t.filter(n=>R(n.label).includes(e)||R(n.venue).includes(e)):t).slice(0,100);z.innerHTML=u.map((n,a)=>`
    <div class="row" data-i="${a}">
      <strong>${n.label}</strong>
      <span class="muted small">\uFF08${n.date?`${n.date.slice(0,4)}-${n.date.slice(4,6)}-${n.date.slice(6)}`:"\u2014"}\uFF09</span>
      ${n.class_category?`<span class="pill">${n.class_category}</span>`:""}
    </div>
  `).join("")||'<div class="muted small" style="padding:.5rem">\uFF08\u5F53\u65E5\u306E\u30EC\u30FC\u30B9\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\uFF09</div>',z.dataset.rows=JSON.stringify(u)}U.addEventListener("input",()=>ae()),Xe.addEventListener("click",()=>{U.value="",ae()}),z.addEventListener("click",e=>{let t=e.target.closest(".row");if(!t)return;let u=JSON.parse(z.dataset.rows||"[]")[parseInt(t.dataset.i,10)];u&&at(u)});var re=null,G=null;function nt(e){return`${e.date||I()}-${e.jo_code||"jo"}-${Re(e.race_number)}`}function at(e){re=e,G=null,Fe.style.display="block";let t=e.date?`${e.date.slice(0,4)}-${e.date.slice(4,6)}-${e.date.slice(6)}`:M();Ze.textContent=`${t} ${e.venue}${e.race_number}R`,Ce.href=e.race_url||"#",Ce.style.display=e.race_url?"inline-flex":"none",e.result_url?(ue.href=e.result_url,ue.style.display="inline-flex"):ue.style.display="none";let u=e.players||[];ve.innerHTML=u.map((n,a)=>{let r=O(n.region||""),l=n.term?`${n.term}\u671F`:"";return`<div class="player-item" data-i="${a}">
      <div><strong>@${(n.name||"").trim()}</strong> <span class="muted small">${r} ${l}</span></div>
    </div>`}).join("")||'<div class="muted small">\uFF08\u51FA\u8D70\u8868\u306B\u9078\u624B\u60C5\u5831\u304C\u3042\u308A\u307E\u305B\u3093\uFF09</div>',ve.onclick=n=>{let a=n.target.closest(".player-item");if(!a)return;let r=parseInt(a.dataset.i,10),l=(e.players||[])[r];l&&rt(e,l)},Be.style.display="none",V.style.display="none",Fe.scrollIntoView({behavior:"smooth",block:"start"})}function rt(e,t){G=t;let u=(t.name||"").trim();Qe.textContent=`@${u} \u306E\u904E\u53BB\u30E1\u30E2`;let n=De(t);Ae(n),ne.value=`- ${e.venue}${e.race_number}R  @${u}`,V.style.display="block",Be.style.display="block",V.scrollIntoView({behavior:"smooth",block:"start"})}function De(e){let t=F(),u=$e(e);return t.filter(n=>!!(u&&n.entities?.players&&Array.isArray(n.entities.players)&&n.entities.players.some(a=>a.id&&String(a.id)===String(u))||(n.raw||"").includes("@"+(e.name||"").trim()))).sort((n,a)=>(a.at||"").localeCompare(n.at||""))}function Ae(e){if(!e.length){he.innerHTML='<div class="muted small" style="padding:.3rem .2rem">\u3053\u306E\u9078\u624B\u306B\u95A2\u3059\u308B\u30E1\u30E2\u306F\u3042\u308A\u307E\u305B\u3093</div>';return}he.innerHTML=e.slice(0,20).map(t=>{let u=Z(t.raw||""),n=u?`${u.date} ${u.venue}${u.raceNo}R`:(t.at||"").slice(0,10),a=(t.raw||"").replace(/</g,"&lt;");return`<div class="note">
      <div class="small muted">${n}</div>
      <div class="raw">${a}</div>
    </div>`}).join("")}et.addEventListener("click",()=>{if(!re||!G){alert("\u30EC\u30FC\u30B9\u3068\u9078\u624B\u3092\u9078\u629E\u3057\u3066\u304F\u3060\u3055\u3044");return}let e=ne.value.trim();if(!e){alert("\u30C6\u30AD\u30B9\u30C8\u304C\u7A7A\u3067\u3059");return}let t=re,u=G,n=nt(t),a=$e(u),r={race:{uid:n,date:t.date||I(),venue:t.venue,jo_code:t.jo_code||"",race_number:t.race_number,start_at_iso:Oe(t.date||I(),t.start_time||"00:00")},players:[{id:a||null,name:(u.name||"").trim(),region:O(u.region||""),term:u.term||null}]};Ee(e,r);let l=De(u);Ae(l),ne.value=`- ${t.venue}${t.race_number}R  @${(u.name||"").trim()}`,P.close()}),tt.addEventListener("click",()=>{V.style.display="none"});function $e(e){if(!N.length)return null;let t=oe(e.name||""),u=e.term?`${e.term}\u671F`:null,n=O(e.region||""),a=N.filter(r=>oe(r.name)===t);return u&&(a=a.filter(r=>(r.ki||"")===u)),n&&(a=a.filter(r=>O(r.region)===n)),a.length===1?a[0].id:null}var ke=document.getElementById("settingsBtn"),A=document.getElementById("settingsMenu");ke.addEventListener("click",e=>{e.stopPropagation(),A.style.display=A.style.display==="block"?"none":"block"}),document.addEventListener("click",e=>{!A.contains(e.target)&&e.target!==ke&&(A.style.display="none")}),document.getElementById("loginMi").addEventListener("click",async()=>{A.style.display="none",await ot()&&L.requestAccessToken({prompt:"consent"})}),document.getElementById("importMi").addEventListener("click",()=>{A.style.display="none";let e=Object.assign(document.createElement("input"),{type:"file",accept:".ndjson,.jsonl"});e.onchange=async()=>{let t=(await e.files[0].text()).split(/\r?\n/).filter(Boolean),u=[],n=0;for(let s of t)try{u.push(JSON.parse(s))}catch{n++}let a=F(),r=new Set(a.map(s=>s.id));for(let s of u)s&&!r.has(s.id)&&(a.push(s),r.add(s.id));let l=J(a);D(a),alert(`\u30A4\u30F3\u30DD\u30FC\u30C8\u5B8C\u4E86\uFF08\u65B0\u898F ${u.length-n} \u4EF6\uFF0F\u58CA\u308C\u884C ${n} \u4EF6\uFF09`),Y(),l||alert("\u6CE8\u610F\uFF1A\u3053\u306E\u74B0\u5883\u3067\u306F\u4FDD\u5B58\u304C\u5236\u9650\u3055\u308C\u3066\u3044\u307E\u3059\u3002")},e.click()}),document.getElementById("exportMi").addEventListener("click",()=>{A.style.display="none";let e=F().map(n=>JSON.stringify(n)).join(`
`),t=new Blob([e],{type:"application/x-ndjson"}),u=Object.assign(document.createElement("a"),{href:URL.createObjectURL(t),download:`mofu_${I()}.ndjson`});u.click(),URL.revokeObjectURL(u.href)});var K="mofu_entries.ndjson",L=null,T=null,E=null,Se=!1,Le="https://www.googleapis.com/auth/drive.appdata",lt=1200,Ie=null;function W(){if(!T)throw new Error("no access token");return{Authorization:`Bearer ${T}`}}async function be(){for(let e=0;e<50;e++){if(window.google?.accounts?.oauth2)return;await new Promise(t=>setTimeout(t,100))}throw new Error("GIS load fail")}async function le(e=K){let t=new URLSearchParams({spaces:"appDataFolder",q:`name='${e.replace(/'/g,"\\'")}' and trashed=false`,fields:"files(id,name)",pageSize:"1"}),u=await fetch(`https://www.googleapis.com/drive/v3/files?${t}`,{headers:W()});if(!u.ok)throw new Error(`Drive list failed ${u.status}`);return(await u.json()).files?.[0]?.id||null}async function it(e){let t=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:W()});if(!t.ok)throw new Error(`Drive download failed ${t.status}`);return await t.text()}async function ie(e,t){let u={name:e,parents:["appDataFolder"]},n="mofu_"+Math.random().toString(16).slice(2),a=`--${n}\r
Content-Type: application/json; charset=UTF-8\r
\r
${JSON.stringify(u)}\r
--${n}\r
Content-Type: application/x-ndjson\r
\r
${t}\r
--${n}--`,r=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{...W(),"Content-Type":`multipart/related; boundary=${n}`},body:a});if(!r.ok)throw new Error(`Drive create failed ${r.status}`);return(await r.json()).id}async function j(e,t){let u=await fetch(`https://www.googleapis.com/upload/drive/v3/files/${e}?uploadType=media`,{method:"PATCH",headers:{...W(),"Content-Type":"application/x-ndjson"},body:t});if(!u.ok)throw new Error(`Drive update failed ${u.status}`)}function se(e){return e.map(t=>JSON.stringify(t)).join(`
`)}function st(e){return e?e.split(/\r?\n/).filter(Boolean).map(t=>JSON.parse(t)):[]}function _e(e){return e.reduce((t,u)=>Math.max(t,Date.parse(u.at||0)||0),0)}async function ot(){try{await be()}catch{return alert("Google\u306E\u30E9\u30A4\u30D6\u30E9\u30EA\u304C\u8AAD\u307F\u8FBC\u3081\u307E\u305B\u3093\u3067\u3057\u305F\u3002"),!1}return!w||!w.endsWith(".apps.googleusercontent.com")?(alert("Google\u30AF\u30E9\u30A4\u30A2\u30F3\u30C8ID\u304C\u672A\u8A2D\u5B9A\u304B\u4E0D\u6B63\u3067\u3059\u3002"),!1):X?(L||(L=google.accounts.oauth2.initTokenClient({client_id:w,scope:Le,callback:async e=>{if(e.error){console.error(e),alert("Google\u63A5\u7D9A\u306B\u5931\u6557\u3057\u307E\u3057\u305F");return}T=e.access_token,Se||(Se=!0,await dt())}})),!0):(alert("\u3053\u306E\u30AA\u30EA\u30B8\u30F3\u3067\u306FDrive\u9023\u643A\u3092\u7121\u52B9\u5316\u3057\u3066\u3044\u307E\u3059\u3002"),!1)}async function ct(){return new Promise(async(e,t)=>{try{await be(),L||(L=google.accounts.oauth2.initTokenClient({client_id:w,scope:Le,callback:u=>{u.error?t(u):(T=u.access_token,e(u))}})),L.requestAccessToken({prompt:"none"})}catch(u){t(u)}})}async function dt(){try{E=await le();let e=[],t="";if(E){t=await it(E);try{e=st(t)}catch{e=[]}}let u=F(),n=u.length,a=e.length,r=_e(u),l=_e(e),s=$=>$?new Date($).toISOString().slice(0,19).replace("T"," "):"\u2014",y=`
      <div>\u30ED\u30FC\u30AB\u30EB\uFF1A<strong>${n}</strong> \u4EF6\uFF08\u6700\u7D42 ${s(r)}\uFF09</div>
      <div>\u30B5\u30FC\u30D0\u30FC\uFF1A<strong>${a}</strong> \u4EF6\uFF08\u6700\u7D42 ${s(l)}\uFF09</div>
      <div style="margin-top:6px;color:#6b7280">\u3069\u3061\u3089\u3092<strong>\u6B63</strong>\u3068\u3057\u3066\u53CD\u6620\u3057\u307E\u3059\u304B\uFF1F</div>
    `,B=document.getElementById("syncDlg");document.getElementById("syncSummary").innerHTML=y;let Te=await new Promise($=>{function je(){B.removeEventListener("close",je),$(B.returnValue)}B.addEventListener("close",je),B.showModal()});if(Te==="localToServer"){let $=se(u);E?await j(E,$):E=await ie(K,$),alert("\u30B5\u30FC\u30D0\u30FC\u3078\u4E0A\u66F8\u304D\u3057\u307E\u3057\u305F\u3002\u4EE5\u5F8C\u306F\u81EA\u52D5\u540C\u671F\u3057\u307E\u3059\u3002")}else Te==="serverToLocal"?(localStorage.setItem(d,JSON.stringify(e)),c=e,D(e),alert("\u30ED\u30FC\u30AB\u30EB\u3078\u4E0A\u66F8\u304D\u3057\u307E\u3057\u305F\u3002\u4EE5\u5F8C\u306F\u81EA\u52D5\u540C\u671F\u3057\u307E\u3059\u3002")):alert("\u540C\u671F\u8A2D\u5B9A\u3092\u30AD\u30E3\u30F3\u30BB\u30EB\u3057\u307E\u3057\u305F\u3002\uFF08\u3044\u3064\u3067\u3082\u300C\u8A2D\u5B9A\u2192Google\u30ED\u30B0\u30A4\u30F3\u300D\u304B\u3089\u518D\u8A2D\u5B9A\u3067\u304D\u307E\u3059\uFF09")}catch(e){console.error(e),alert("\u540C\u671F\u521D\u671F\u8A2D\u5B9A\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002\u518D\u5EA6\u304A\u8A66\u3057\u304F\u3060\u3055\u3044\u3002")}}function Y(){T&&(clearTimeout(Ie),Ie=setTimeout(async()=>{try{let e=se(F());E?await j(E,e):(E=await le(),E?await j(E,e):E=await ie(K,e))}catch(e){let t=String(e||"");if(t.includes("401")||t.includes("403"))try{await ct();let u=se(F());E?await j(E,u):(E=await le(),E?await j(E,u):E=await ie(K,u))}catch(u){console.warn("Drive\u4FDD\u5B58\u5931\u6557\uFF08\u518D\u8A66\u884C\u3082\u5931\u6557\uFF09:",u)}else console.warn("Drive\u4FDD\u5B58\u5931\u6557:",e)}},lt))}(async()=>(S(m,!1,"\u2026"),S(i,!1,"\u2026"),D(F()),await Promise.allSettled([qe(),Ue()]),h=o.selectionStart,updateDropdown()))()})();})();
