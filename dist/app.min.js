(()=>{"showModal"in HTMLDialogElement.prototype||(HTMLDialogElement.prototype.showModal=function(){this.setAttribute("open",""),this.style.position="fixed",this.style.inset="10% auto auto 50%",this.style.transform="translateX(-50%)",this.style.zIndex=1e3,document.documentElement.classList.add("mofu-dialog-open")},HTMLDialogElement.prototype.close=function(){this.removeAttribute("open"),this.style.position="",this.style.inset="",this.style.transform="",this.style.zIndex="",document.documentElement.classList.remove("mofu-dialog-open")});var U=(()=>{let e=!1;try{let n=Object.defineProperty({},"passive",{get(){e=!0}});window.addEventListener("test",null,n),window.removeEventListener("test",null,n)}catch{}return e})();window.mofu||(window.mofu={});window.mofu.env="esm";console.info("mofu: shim loaded");var s=(e,n=document)=>n.querySelector(e);var v={key:"mofu:entries",load(){try{let e=localStorage.getItem(this.key);if(!e)return[];let n=JSON.parse(e);return Array.isArray(n)?n:[]}catch(e){return console.warn(e),[]}},save(e){localStorage.setItem(this.key,JSON.stringify(e||[]))}};function T(e){return(e||[]).map(n=>JSON.stringify(n)).join(`
`)}function A(e){let n=[];return(e||"").split(`
`).forEach(a=>{let o=a.trim();if(o)try{n.push(JSON.parse(o))}catch{}}),n}var D=()=>new Date().toISOString(),S={races:e=>`https://keirinjingle.github.io/keirin-links/data/keirin_race_list_${e}.json`,players:"https://keirinjingle.github.io/keirin-links/senshuID.json"},y={races:e=>`mofu:cache:races:${e}`,players:"mofu:cache:players"};function j(e=new Date){let n=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0");return`${n}${a}${o}`}var r={entries:[],activeTab:"race",fullTextKeyword:"",todayRaces:[{id:"demo-27-01",label:"\u4EAC\u738B\u95A3 1R \uFF33\u7D1A\u4E00\u822C",start:"10:40"}],tactics:["\u5148\u884C","\u6372\u308A","\u5DEE\u3057","\u30DE\u30FC\u30AF","\u81EA\u5728"],tags:["#\u91CD\u8981","#TODO","#\u30EC\u30FC\u30B9","#\u30E1\u30E2"],players:["\u65B0\u7530\u7950\u5927","\u8107\u672C\u96C4\u592A","\u53E4\u6027\u512A\u4F5C","\u677E\u6D66\u60A0\u58EB","\u5E73\u539F\u5EB7\u591A"]},t={memoInput:null,entriesList:null,settingsBtn:null,settingsMenu:null,googleLoginBtn:null,exportBtn:null,importBtn:null,howtoLink:null,donateLink:null,slashBtn:null,openSearchBtn:null,addTopBtn:null,dlg:null,closeSearchBtn:null,tabRaceBtn:null,tabFullBtn:null,raceTab:null,fullTab:null,raceSuggestWrap:null,newMemoWrap:null,newMemoTa:null,saveMemoBtn:null,cancelMemoBtn:null,searchInput:null,searchResult:null,clearSearchBtn:null,goTopBtn:null};function N(){t.memoInput=s("#memoInput"),t.entriesList=s("#entriesList"),t.settingsBtn=s("#settingsBtn"),t.settingsMenu=s("#settingsMenu"),t.googleLoginBtn=s("#googleLoginBtn"),t.exportBtn=s("#exportBtn"),t.importBtn=s("#importBtn"),t.howtoLink=s("#howtoLink"),t.donateLink=s("#donateLink"),t.slashBtn=s("#slashBtn"),t.openSearchBtn=s("#openSearchBtn"),t.addTopBtn=s("#addTopBtn"),t.dlg=s("#searchDlg"),t.closeSearchBtn=s("#closeSearchBtn"),t.tabRaceBtn=s("#tabRaceBtn"),t.tabFullBtn=s("#tabFullBtn"),t.raceTab=s("#raceTab"),t.fullTab=s("#fullTab"),t.raceSuggestWrap=s("#raceSuggestWrap"),t.newMemoWrap=s("#newMemoWrap"),t.newMemoTa=s("#newMemoTa"),t.saveMemoBtn=s("#saveMemoBtn"),t.cancelMemoBtn=s("#cancelMemoBtn"),t.searchInput=s("#searchInput"),t.searchResult=s("#searchResult"),t.clearSearchBtn=s("#clearSearchBtn"),t.goTopBtn=s("#goTopBtn"),r.entries=v.load(),b(),G(),C(),_(),O(),m(),z()}function b(){let e=t.entriesList;if(!e)return;if(!r.entries.length){e.innerHTML='<div style="color:#6B7280">\u307E\u3060\u30E1\u30E2\u304C\u3042\u308A\u307E\u305B\u3093\u3002</div>';return}let n=r.entries.slice().sort((a,o)=>(o.created||"").localeCompare(a.created||"")).map(a=>`
        <article style="background:#fff;border:1px solid #E5E7EB;border-radius:10px;padding:.75rem .9rem;box-shadow:0 1px 2px rgba(0,0,0,.04);margin:.6rem 0">
          ${a.race?`<div style="font-size:.85rem;color:#6B7280">${u(a.race.label||"")}</div>`:""}
          <div style="white-space:pre-wrap">${E(u(a.text||""))}</div>
          <div style="font-size:.8rem;color:#9CA3AF;margin-top:.3rem">${M(a.created)}</div>
        </article>`).join("");e.innerHTML=n}var u=e=>String(e).replace(/[&<>"']/g,n=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[n]),E=e=>e.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank">$1</a>');function M(e){if(!e)return"";let n=new Date(e),a=o=>String(o).padStart(2,"0");return`${n.getFullYear()}-${a(n.getMonth()+1)}-${a(n.getDate())} ${a(n.getHours())}:${a(n.getMinutes())}`}function B(e,n=null){let a={id:"e_"+Math.random().toString(16).slice(2),text:e||"",created:D(),race:n?{id:n.id,label:n.label}:null};r.entries.push(a),v.save(r.entries),b()}function C(){t.settingsBtn?.addEventListener("click",e=>{e.preventDefault();let n=t.settingsMenu.style.display==="block";t.settingsMenu.style.display=n?"none":"block"}),document.addEventListener("click",e=>{if(!t.settingsMenu)return;t.settingsMenu.contains(e.target)||t.settingsBtn.contains(e.target)||(t.settingsMenu.style.display="none")}),t.googleLoginBtn?.addEventListener("click",async()=>{if(typeof window.ensureGisReady!="function"){alert("Google\u30ED\u30B0\u30A4\u30F3\u306E\u521D\u671F\u5316\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\uFF08ensureGisReady\uFF09\u3002index.html \u306EGIS\u30B9\u30AF\u30EA\u30D7\u30C8\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002");return}if(!await window.ensureGisReady()){alert("Google\u30ED\u30B0\u30A4\u30F3\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002");return}alert("Google\u30ED\u30B0\u30A4\u30F3\u304C\u5B8C\u4E86\u3057\u307E\u3057\u305F\u3002")}),t.exportBtn?.addEventListener("click",async()=>{try{if(typeof window.driveFindFileIdByName!="function"||typeof window.driveCreateFile!="function"||typeof window.driveUpdateFile!="function"){alert("Drive API \u30D8\u30EB\u30D1\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\uFF08driveFindFileIdByName \u7B49\uFF09\u3002index.html \u306EGIS\u30D8\u30EB\u30D1\u633F\u5165\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002");return}let e="mofu_entries.ndjson",n=T(r.entries),a=await window.driveFindFileIdByName(e);a?await window.driveUpdateFile(a,n):a=await window.driveCreateFile(e,n),alert("Drive \u3078\u30A8\u30AF\u30B9\u30DD\u30FC\u30C8\u3057\u307E\u3057\u305F\u3002")}catch(e){console.error(e),alert("\u30A8\u30AF\u30B9\u30DD\u30FC\u30C8\u5931\u6557: "+(e&&e.message?e.message:e))}}),t.importBtn?.addEventListener("click",async()=>{try{let e=document.createElement("input");e.type="file",e.accept=".ndjson,.txt,application/x-ndjson,text/plain",e.onchange=async()=>{let n=e.files?.[0];if(!n)return;let a=await n.text(),o=A(a);if(!Array.isArray(o))throw new Error("\u4E0D\u6B63\u306ANDJSON\u3067\u3059\u3002");r.entries=o,v.save(r.entries),b(),alert("\u30A4\u30F3\u30DD\u30FC\u30C8\u5B8C\u4E86\uFF1A"+o.length+"\u4EF6")},e.click()}catch(e){console.error(e),alert("\u30A4\u30F3\u30DD\u30FC\u30C8\u5931\u6557: "+(e&&e.message?e.message:e))}})}function _(){t.slashBtn?.addEventListener("click",()=>{g(t.memoInput,"/")}),t.openSearchBtn?.addEventListener("click",w),t.addTopBtn?.addEventListener("click",()=>{let e=(t.memoInput.value||"").trim();if(!e){alert("\u30E1\u30E2\u304C\u7A7A\u3067\u3059");return}B(e,null),t.memoInput.value=""}),document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&(e.key==="k"||e.key==="K")&&(e.preventDefault(),w())})}function g(e,n){if(!e)return;let a=e.selectionStart??e.value.length,o=e.selectionEnd??e.value.length,l=e.value;e.value=l.slice(0,a)+n+l.slice(o);let d=a+n.length;e.setSelectionRange(d,d),e.focus()}function O(){t.closeSearchBtn?.addEventListener("click",p),t.goTopBtn?.addEventListener("click",()=>{p(),window.scrollTo({top:0,behavior:"smooth"})}),t.clearSearchBtn?.addEventListener("click",()=>{t.searchInput.value="",t.searchResult.innerHTML=""}),t.tabRaceBtn?.addEventListener("click",()=>h("race")),t.tabFullBtn?.addEventListener("click",()=>h("full")),t.searchInput?.addEventListener("input",x),t.saveMemoBtn?.addEventListener("click",J),t.cancelMemoBtn?.addEventListener("click",W),document.addEventListener("keydown",e=>{e.key==="Escape"&&t.dlg.open&&p()})}function w(){h("race"),typeof t.dlg.showModal=="function"?t.dlg.showModal():t.dlg.setAttribute("open",""),m()}function p(){t.dlg.open&&t.dlg.close(),t.dlg.removeAttribute("open")}function h(e){r.activeTab=e,e==="race"?(t.tabRaceBtn.classList.add("primary"),t.tabFullBtn.classList.remove("primary"),t.raceTab.style.display="",t.fullTab.style.display="none",m()):(t.tabFullBtn.classList.add("primary"),t.tabRaceBtn.classList.remove("primary"),t.raceTab.style.display="none",t.fullTab.style.display="",t.searchInput.focus())}function m(){let e=t.raceSuggestWrap;if(!e)return;let a=`
    <div style="font-weight:700;margin:.2rem 0">\u5F53\u65E5\u306E\u30EC\u30FC\u30B9</div>
    ${r.todayRaces.map(o=>`
    <div class="race-item" data-id="${o.id}" style="padding:.35rem .5rem;border:1px solid #E5E7EB;border-radius:.5rem;margin:.25rem 0;display:flex;justify-content:space-between;gap:.5rem;align-items:center">
      <div>${u(o.label)} ${o.start?`<span style="color:#9CA3AF;font-size:.85rem">(${o.start})</span>`:""}</div>
      <div>
        <button class="btn ghost" data-act="add-memo" data-id="${o.id}">\u3053\u306E\u30EC\u30FC\u30B9\u306B\u30E1\u30E2</button>
      </div>
    </div>
  `).join("")||'<div style="color:#6B7280">\u5F53\u65E5\u306E\u30EC\u30FC\u30B9\u60C5\u5831\u304C\u3042\u308A\u307E\u305B\u3093\u3002</div>'}
    <hr/>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:.4rem">
      ${[...r.players,...r.tactics,...r.tags].map(o=>`
        <button class="btn" data-act="insert">${u(o)}</button>
      `).join("")}
    </div>
  `;e.innerHTML=a,e.addEventListener("click",o=>{let l=o.target.closest("[data-act]");if(!l)return;let d=l.getAttribute("data-act");if(d==="insert"){let c=l.textContent||"";t.newMemoWrap.style.display!=="none"?g(t.newMemoTa,c):g(t.memoInput,c)}if(d==="add-memo"){let c=l.getAttribute("data-id"),i=r.todayRaces.find(f=>f.id===c);H(`\u3010${i?.label||"\u30EC\u30FC\u30B9"}\u3011
`)}},{once:!0})}function x(){let e=(t.searchInput.value||"").trim();if(!e){t.searchResult.innerHTML="";return}let a=r.entries.filter(o=>(o.text||"").includes(e)||o.race&&(o.race.label||"").includes(e)).slice(0,100).map(o=>`
    <div style="padding:.35rem .5rem;border-bottom:1px solid #E5E7EB">
      <div style="font-size:.85rem;color:#6B7280">${u(o.race?.label||"\uFF08\u7D10\u4ED8\u3051\u306A\u3057\uFF09")}</div>
      <div style="white-space:pre-wrap">${E(u(o.text||""))}</div>
      <div style="font-size:.8rem;color:#9CA3AF">${M(o.created)}</div>
    </div>
  `).join("");t.searchResult.innerHTML=a||'<div style="color:#6B7280">\u8A72\u5F53\u306A\u3057</div>'}function H(e){let n=t.newMemoTa,a=t.newMemoWrap;a&&(a.style.display="block"),n&&(n.value=e||"",n.focus())}function J(){let e=t.newMemoTa,n=t.newMemoWrap;if(!e)return;let a=(e.value||"").trim();if(!a){alert("\u30E1\u30E2\u5185\u5BB9\u304C\u7A7A\u3067\u3059");return}let o=null,l=a.match(/^【(.+?)】/);if(l){let d=l[1],c=r.todayRaces.find(i=>i.label===d);c&&(o={id:c.id,label:c.label})}B(a,o),e.value="",n&&(n.style.display="none"),p()}function W(){let e=t.newMemoTa,n=t.newMemoWrap;e&&(e.value=""),n&&(n.style.display="none")}function G(){t.howtoLink?.addEventListener("click",e=>{e.preventDefault(),window.open("https://keirinjingle.github.io/keirin-links/howto.html","_blank")}),t.donateLink?.addEventListener("click",e=>{e.preventDefault(),window.open("https://www.paypal.com/paypalme/","_blank")})}async function P(){if(typeof window.driveFindFileIdByName!="function"||typeof window.driveCreateFile!="function"||typeof window.driveUpdateFile!="function"){alert("Drive API \u30D8\u30EB\u30D1\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\uFF08driveFindFileIdByName \u7B49\uFF09\u3002index.html \u306EGIS\u30D8\u30EB\u30D1\u633F\u5165\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002");return}let e="mofu_entries.ndjson",n=T(r.entries),a=await window.driveFindFileIdByName(e);a?await window.driveUpdateFile(a,n):a=await window.driveCreateFile(e,n),alert("manualDriveSync \u5B8C\u4E86")}async function z(){let e=j();try{let n=localStorage.getItem(y.races(e));if(n){let o=JSON.parse(n);k(o)}let a=localStorage.getItem(y.players);if(a){let o=JSON.parse(a);L(o)}}catch(n){console.warn("cache parse failed",n)}try{let n=S.races(e),a=await fetch(n,{cache:"no-store"});if(a.ok){let o=await a.json();k(o);try{localStorage.setItem(y.races(e),JSON.stringify(o))}catch{}}else console.warn("races fetch not ok:",a.status)}catch(n){console.warn("races fetch failed",n)}try{let n=await fetch(S.players,{cache:"no-store"});if(n.ok){let a=await n.json();L(a);try{localStorage.setItem(y.players,JSON.stringify(a))}catch{}}else console.warn("players fetch not ok:",n.status)}catch(n){console.warn("players fetch failed",n)}r.activeTab==="race"&&m()}function k(e){let n=Array.isArray(e)?e:[],a=[];for(let o of n){let l=o.jo_code||o.joCode||"",d=o.venue||o.\u4F1A\u5834\u540D||"",c=Array.isArray(o.races)?o.races:[];for(let i of c){let f=Number(i.race_number??i.raceNo??i.no??i.R)||"",I=i.class_category||i.class||i.grade||"",$=i.closed_at||i.closeTime||""||i.start_time||i.startTime||"",F=`${l||"xx"}-${String(f).padStart(2,"0")}`,R=`${d} ${f}R ${I}`.trim();a.push({id:F,label:R,start:$})}}a.length&&(r.todayRaces=a)}function L(e){let a=(Array.isArray(e)?e:[]).map(o=>o.\u9078\u624B\u540D).filter(Boolean);a.length&&(r.players=Array.from(new Set(a)))}window.openSearchDlg=w;window.closeSearchDlg=p;window.updateRaceSuggest=m;window.updateFullText=x;window.addEntry=B;window.manualDriveSync=P;document.addEventListener("DOMContentLoaded",N);console.info("mofu: main loaded");})();
