(()=>{(function(){if(window.updateDropdown)return;let e=["\u4E09\u5206\u6226","\u4E8C\u5206\u6226","\u5358\u9A0E","\u5148\u884C\u4E00\u8ECA","\u307E\u304F\u308A","\u5DEE\u3057","\u30AB\u30DE\u30B7","\u81EA\u5728"];function t(i){return(i||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function o(i,r){let l=i.slice(0,r).match(/(^|\s)\/(\S*)$/);return l?{token:l[2],start:r-l[2].length-1,end:r}:null}function n(i){let r=(i||"").toLowerCase(),l=[],s=!!(r&&r.length>0);try{let a=window.RIDERS;Array.isArray(a)&&a.length&&s&&a.filter(u=>((u.name||"")+" "+(u.region||"")+" "+(u.ki||"")).toLowerCase().includes(r)).slice(0,24).forEach(u=>l.push({type:"rider",text:"@"+(u.name||""),label:u.name||"",payload:u}))}catch{}(r?e.filter(a=>a.toLowerCase().includes(r)):e).forEach(a=>l.push({type:"tactic",text:"#"+a,label:"#"+a})),r&&l.push({type:"tag",text:"+"+i,label:"+"+i});try{let a=window.DAYCARDS;if(Array.isArray(a)&&a.length)for(let u of a){let p=u.venue||"",h=p.toLowerCase();for(let T of u.races||[]){let I=`${p}${T.race_number}R`,C=I.toLowerCase();(r?C.includes(r)||h.includes(r):!0)&&l.push({type:"race",text:"- "+I,label:I})}}}catch{}return window.__shim_items=l.slice(0,80),window.__shim_items}function d(i){let r=document.getElementById("dropdown");if(!r)return;if(!i||!i.length){r.style.display="none",r.innerHTML="";return}r.innerHTML=i.map((c,a)=>`<div class="item" data-i="${a}"><span class="type">${c.type==="race"?"\u30EC\u30FC\u30B9":c.type==="tactic"?"\u6226\u6CD5":c.type==="rider"?"\u9078\u624B":"\u30BF\u30B0"}</span> ${t(c.text||c.label||"")}</div>`).join(""),r.style.display="block";let l=0;for(let c=0;c<i.length;c++)if(i[c].type==="rider"){l=c;break}r.querySelectorAll(".item").forEach((c,a)=>c.classList.toggle("is-active",a===l))}window.__getSlashToken=o,window.updateDropdown=function(){if(window.__isComposing){let c=document.getElementById("dropdown");c&&(c.style.display="none",c.innerHTML="");return}let i=document.getElementById("ta");if(!i)return;let r=i.selectionStart||0,l=o(i.value,r);if(!l){d([]);return}let s=n(l.token);d(s)},window.__shim_items=window.__shim_items||[],console.info("mofu: shim installed (dropdown builder)")})();var A="https://keirinjingle.github.io/keirin-links/senshuID.json",B=e=>`https://keirinjingle.github.io/keirin-links/data/keirin_race_list_${e}.json`,m="mofu:entries:mvp2",f=document.getElementById("ta"),w=document.getElementById("dropdown"),D=document.getElementById("cards"),L=document.getElementById("riderStatus"),_=document.getElementById("raceStatus");window.__isComposing=!1;function b(...e){window.console&&console.log(...e)}function M(){let e=new Date,t=e.getTimezoneOffset()*6e4;return new Date(e.getTime()-t).toISOString().slice(0,10).replace(/-/g,"")}function v(e,t,o){if(!e)return;let n=e.querySelector(".mark");n&&(n.textContent=t?"\u2705":`\u2716${o?`(${o})`:""}`),e.classList.toggle("ok",!!t),e.classList.toggle("ng",!t)}var y=null,S=!0;(function(){try{localStorage.setItem(m+":hc","1"),localStorage.removeItem(m+":hc"),S=!0}catch(e){S=!1,console.warn("localStorage not available",e)}})();function g(){if(y)return y;try{if(!S)return y=[],y;let e=localStorage.getItem(m);return y=e?JSON.parse(e):[],y}catch(e){console.warn("loadEntries error \u2014 reinit",e),y=[];try{S&&localStorage.setItem(m,"[]")}catch{}return y}}function k(e){if(y=Array.isArray(e)?e:[],!S)return!1;try{return localStorage.setItem(m,JSON.stringify(y)),!0}catch(t){return console.warn("saveEntries error",t),!1}}function $(e){return e.replace(/@([^\s@#\+（）()]+)/g,(t,o)=>`<a href="#" class="riderLink" data-q="@${o}">@${o}</a>`).replace(/\+("[^"]+"|[\w\u3040-\u30ff\u4e00-\u9faf]+)/g,t=>`<a href="#" class="tagLink" data-q="${t}">${t}</a>`)}function E(e){if(!D)return;let t=(e??g()).slice().reverse();if(!t.length){D.innerHTML='<div class="card" style="color:#9ca3af">\uFF08\u307E\u3060\u30E1\u30E2\u304C\u3042\u308A\u307E\u305B\u3093\uFF09</div>';return}D.innerHTML=t.map(o=>{let n=(o.at||"").slice(0,10),d=(o.raw||"").replace(/</g,"&lt;");return`<div class="card" id="card_${o.id}">
      <div class="head"><span class="date">${n}</span>
        <div style="margin-left:auto;display:flex;gap:.4rem">
          <button class="linklike editBtn" data-id="${o.id}">\u7DE8\u96C6</button>
          <button class="linklike delBtn" data-id="${o.id}">\u524A\u9664</button>
        </div>
      </div>
      <div class="raw">${$(d)}</div>
    </div>`}).join("")}function j(e,t){let o=g().slice(),n=o.findIndex(i=>i.id===e);if(n<0)return;o[n]={...o[n],raw:t,at:new Date().toISOString()};let d=k(o);E(o),d||alert("\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F")}function O(e){let t=g().filter(n=>n.id!==e),o=k(t);E(t),o||alert("\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F")}async function N(){try{let e=await fetch(A,{cache:"no-cache"});if(!e.ok)throw new Error("HTTP "+e.status);let t=await e.text(),o=JSON.parse(t||"[]");if(window.RIDERS=(o||[]).map(n=>({id:String(n.\u767B\u9332\u756A\u53F7||"").trim(),name:n.\u9078\u624B\u540D||n.name||"",ki:(n.\u671F||n.ki||"")+"",region:n.\u5730\u57DF||n.region||"",grade:n.\u7D1A||n.grade||""})),v(L,!0),typeof window.updateDropdown=="function")try{window.updateDropdown()}catch(n){console.warn("updateDropdown failed after fetchRiders",n)}b("RIDERS loaded:",window.RIDERS.length)}catch(e){window.RIDERS=[],v(L,!1,e.message||"fetch error"),console.warn("fetchRiders error",e)}}async function q(){try{let e=B(M()),t=await fetch(e,{cache:"no-cache"});if(!t.ok)throw new Error("HTTP "+t.status);let o=await t.json();if(window.DAYCARDS=Array.isArray(o)?o:[],v(_,!0),typeof window.updateDropdown=="function")try{window.updateDropdown()}catch(n){console.warn("updateDropdown failed after fetchRaces",n)}b("DAYCARDS loaded:",window.DAYCARDS.length)}catch(e){window.DAYCARDS=[],v(_,!1,e.message||"fetch error"),console.warn("fetchRaces error",e)}}function G(e,t){let o=e.slice(0,t).match(/(^|\s)\/(\S*)$/);return o?{token:o[2],start:t-o[2].length-1,end:t}:null}function x(e){let t=window.__shim_items||[];if(!t.length)return;let o=t[e];if(!o&&(e=0,o=t[0],!o))return;let n=typeof window.__getSlashToken=="function"?window.__getSlashToken(f.value,f.selectionStart):G(f.value,f.selectionStart);if(n&&n.token&&n.token.length>0&&o.type!=="rider"){let u=t.find(p=>p.type==="rider");u&&(o=u)}let d=o.text||o.label||"";if(!d)return;let i=n?f.value.slice(0,n.start):f.value.slice(0,f.selectionStart),r=n?f.value.slice(n.end):f.value.slice(f.selectionEnd),l=i&&!/\s$/.test(i),s=r&&!/^\s/.test(r),c=(l?" ":"")+d+(s?" ":"");f.value=i+c+r;let a=(i+c).length;f.setSelectionRange(a,a),w&&(w.style.display="none"),f.focus()}function R(e){if(!w)return;let t=Array.from(w.querySelectorAll(".item"));if(!t.length)return;let o=t.findIndex(i=>i.classList.contains("is-active"));o<0&&(o=0);let n=(o+e+t.length)%t.length;t.forEach((i,r)=>i.classList.toggle("is-active",r===n));let d=t[n];d&&d.scrollIntoView({block:"nearest"})}if(w){let e=null;w.addEventListener("pointerdown",t=>{let o=t.target.closest&&t.target.closest(".item");o&&(e={idx:parseInt(o.dataset.i,10),x:t.clientX,y:t.clientY,dragged:!1})}),w.addEventListener("pointermove",t=>{e&&(Math.abs(t.clientX-e.x)>6||Math.abs(t.clientY-e.y)>6)&&(e.dragged=!0)}),w.addEventListener("pointerup",t=>{if(!e)return;let o=t.target.closest&&t.target.closest(".item"),n=o?parseInt(o.dataset.i,10):e.idx,d=e.dragged;e=null,d||x(n)}),w.addEventListener("pointercancel",()=>{e=null})}f&&(f.addEventListener("compositionstart",()=>{window.__isComposing=!0}),f.addEventListener("compositionend",()=>{window.__isComposing=!1,setTimeout(()=>{typeof window.updateDropdown=="function"&&window.updateDropdown()},30)}),f.addEventListener("input",()=>{window.__isComposing||typeof window.updateDropdown=="function"&&window.updateDropdown()}),f.addEventListener("keyup",e=>{e.key==="/"&&!window.__isComposing&&typeof window.updateDropdown=="function"&&window.updateDropdown()}),f.addEventListener("keydown",e=>{if(!window.__isComposing&&!(!w||w.style.display!=="block")){if(e.key==="ArrowDown"){e.preventDefault(),R(1);return}if(e.key==="ArrowUp"){e.preventDefault(),R(-1);return}if(e.key==="Enter"||e.key==="Tab"){let t=w.querySelector(".item.is-active")||w.querySelector('.item[data-i="0"]');if(t){e.preventDefault();let o=parseInt(t.dataset.i,10);x(o)}}e.key==="Escape"&&(w.style.display="none")}}));(function(){let t=()=>{let o=document.getElementById("settingsBtn"),n=document.getElementById("settingsMenu");if(!o||!n){setTimeout(t,120);return}n.style.display=n.style.display||"none",n.style.zIndex=n.style.zIndex||999,o.addEventListener("click",d=>{d.stopPropagation(),n.style.display=n.style.display==="block"?"none":"block"}),document.addEventListener("click",d=>{!n.contains(d.target)&&d.target!==o&&(n.style.display="none")}),document.addEventListener("keydown",d=>{d.key==="Escape"&&(n.style.display="none")}),window.addEventListener("scroll",()=>{n&&n.style.display==="block"&&(n.style.display="none")},{passive:!0})};document.readyState==="complete"||document.readyState==="interactive"?t():document.addEventListener("DOMContentLoaded",t)})();document.body.addEventListener("click",e=>{let t=e.target.closest&&e.target.closest(".editBtn"),o=e.target.closest&&e.target.closest(".delBtn");if(t){let i=t.dataset.id,r=g().find(s=>s.id===i);if(!r)return;let l=prompt("\u30E1\u30E2\u3092\u7DE8\u96C6",r.raw||"");if(l==null)return;j(i,l);return}if(o){let i=o.dataset.id;confirm("\u3053\u306E\u30E1\u30E2\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F")&&O(i);return}let n=e.target.closest&&e.target.closest("a.riderLink"),d=e.target.closest&&e.target.closest("a.tagLink");if(n){e.preventDefault();let i=n.dataset.q,r=document.getElementById("searchInput");r&&(r.value=i);let l=document.getElementById("searchDlg");l&&l.showModal();return}if(d){e.preventDefault();let i=d.dataset.q,r=document.getElementById("searchInput");r&&(r.value=i);let l=document.getElementById("searchDlg");l&&l.showModal();return}});(function(){E(g()),N(),q()})();(()=>{let e=typeof m<"u"?m:"mofu:entries:mvp2",t=s=>document.querySelector(s),o=document.getElementById("dropdown");function n(){let s=t("#settingsMenu");s&&(s.style.display="none")}async function d(){try{if(typeof window.ensureGisReady!="function"){alert("Google\u30ED\u30B0\u30A4\u30F3\u306E\u6E96\u5099\u95A2\u6570(ensureGisReady)\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3002index.html \u306EGIS\u30D8\u30EB\u30D1\u633F\u5165\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002");return}if(!await window.ensureGisReady())return;window.tokenClient?(window.accessToken=null,window.tokenClient.requestAccessToken({prompt:"consent"}),alert("Google\u30ED\u30B0\u30A4\u30F3\u3092\u958B\u59CB\u3057\u307E\u3057\u305F\u3002\u8A31\u53EF\u30D5\u30ED\u30FC\u3092\u5B8C\u4E86\u3057\u3066\u304F\u3060\u3055\u3044\u3002")):alert("tokenClient \u304C\u672A\u521D\u671F\u5316\u3067\u3059\u3002\u30DA\u30FC\u30B8\u3092\u518D\u8AAD\u307F\u8FBC\u307F\u3057\u3066\u518D\u8A66\u884C\u3057\u3066\u304F\u3060\u3055\u3044\u3002")}catch(s){console.error(s),alert("Google\u30ED\u30B0\u30A4\u30F3\u4E2D\u306B\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F\u3002")}finally{n()}}function i(){try{let c=((typeof g=="function"?g():JSON.parse(localStorage.getItem(e)||"[]"))||[]).map(h=>JSON.stringify(h)).join(`
`),a=new Blob([c],{type:"application/x-ndjson"}),u=document.createElement("a"),p=new Date().toISOString().slice(0,10).replace(/-/g,"");u.href=URL.createObjectURL(a),u.download=`mofu_entries_${p}.ndjson`,document.body.appendChild(u),u.click(),u.remove()}catch(s){console.error(s),alert("\u30A8\u30AF\u30B9\u30DD\u30FC\u30C8\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002")}finally{n()}}function r(){let s=document.createElement("input");s.type="file",s.accept=".ndjson,text/plain,application/x-ndjson",s.onchange=async()=>{let c=s.files&&s.files[0];if(!c){n();return}try{let u=(await c.text()).split(/\r?\n/).filter(Boolean),p=[];for(let h of u)try{p.push(JSON.parse(h))}catch{}if(!p.length){alert("\u6709\u52B9\u306ANDJSON\u304C\u8AAD\u307F\u53D6\u308C\u307E\u305B\u3093\u3067\u3057\u305F\u3002"),n();return}typeof k=="function"?(k(p),E(p)):(localStorage.setItem(e,JSON.stringify(p)),location.reload()),alert("\u30A4\u30F3\u30DD\u30FC\u30C8\u304C\u5B8C\u4E86\u3057\u307E\u3057\u305F\u3002")}catch(a){console.error(a),alert("\u30A4\u30F3\u30DD\u30FC\u30C8\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002")}finally{n()}},s.click()}window.manualDriveSync=async function(){try{!window.accessToken&&typeof window.refreshAccessTokenSilent=="function"&&await window.refreshAccessTokenSilent();let c=((typeof g=="function"?g():JSON.parse(localStorage.getItem(e)||"[]"))||[]).map(u=>JSON.stringify(u)).join(`
`);if(typeof window.driveFindFileIdByName!="function"){alert("Drive API \u30D8\u30EB\u30D1\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\uFF08driveFindFileIdByName \u7B49\uFF09\u3002index.html \u306EGIS\u30D8\u30EB\u30D1\u633F\u5165\u3092\u3054\u78BA\u8A8D\u304F\u3060\u3055\u3044\u3002");return}let a=await window.driveFindFileIdByName("mofu_entries.ndjson");a?await window.driveUpdateFile(a,c):a=await window.driveCreateFile("mofu_entries.ndjson",c),alert("Google Drive \u540C\u671F\u304C\u5B8C\u4E86\u3057\u307E\u3057\u305F\u3002")}catch(s){console.error(s),alert("Drive \u540C\u671F\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002\u5148\u306B Google\u30ED\u30B0\u30A4\u30F3 \u3092\u5B9F\u884C\u3057\u3066\u304F\u3060\u3055\u3044\u3002")}};function l(){let s=t("#loginMi"),c="#importMi",a="#exportMi",u=document.querySelector(c),p=document.querySelector(a);s&&s.addEventListener("click",d),u&&u.addEventListener("click",r),p&&p.addEventListener("click",i)}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",l):l()})();})();
