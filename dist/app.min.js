(()=>{(function(){if(window.updateDropdown)return;let t=["\u4E09\u5206\u6226","\u4E8C\u5206\u6226","\u5358\u9A0E","\u5148\u884C\u4E00\u8ECA","\u307E\u304F\u308A","\u5DEE\u3057","\u30AB\u30DE\u30B7","\u81EA\u5728"];function e(o){return(o||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function n(o,r){let s=o.slice(0,r).match(/(^|\s)\/(\S*)$/);return s?{token:s[2],start:r-s[2].length-1,end:r}:null}function a(o){let r=(o||"").toLowerCase(),s=[];try{let i=window.DAYCARDS;if(Array.isArray(i)&&r.length>=0)for(let c of i)for(let k of c.races||[]){let E=`${c.venue}${k.race_number}R`;(!r||E.toLowerCase().includes(r)||(c.venue||"").toLowerCase().includes(r))&&s.push({type:"race",label:E,text:`- ${c.venue}${k.race_number}R`})}}catch{}(r?t.filter(i=>i.toLowerCase().includes(r)):t).forEach(i=>s.push({type:"tactic",text:"#"+i,label:"#"+i}));try{let i=window.RIDERS;Array.isArray(i)&&i.length&&r?i.filter(c=>((c.name||"")+" "+(c.region||"")+" "+(c.ki||"")).toLowerCase().includes(r)).slice(0,12).forEach(c=>s.push({type:"rider",text:"@"+c.name,label:c.name,payload:c})):r&&s.push({type:"rider",text:"@"+o,label:o})}catch{r&&s.push({type:"rider",text:"@"+o,label:o})}return r&&s.push({type:"tag",text:"+"+o,label:"+"+o}),window.__shim_items=s.slice(0,80),window.__shim_items}function u(o){let r=document.getElementById("dropdown");if(!r)return;if(!o||!o.length){r.style.display="none",r.innerHTML="";return}r.innerHTML=o.map((l,i)=>`<div class="item" data-i="${i}"><span class="type">${l.type==="race"?"\u30EC\u30FC\u30B9":l.type==="tactic"?"\u6226\u6CD5":l.type==="rider"?"\u9078\u624B":"\u30BF\u30B0"}</span> ${e(l.text||l.label||"")}</div>`).join(""),r.style.display="block",r.querySelectorAll(".item").forEach((l,i)=>l.classList.toggle("is-active",i===0))}window.updateDropdown=function(){let o=document.getElementById("ta");if(!o)return;let r=o.selectionStart||0,s=n(o.value,r);if(!s){u([]);return}let l=a(s.token);u(l)},window.__getSlashToken=n,console.info("mofu: shim installed (src/shim.js)")})();var L="https://keirinjingle.github.io/keirin-links/senshuID.json",_=t=>`https://keirinjingle.github.io/keirin-links/data/keirin_race_list_${t}.json`,m="mofu:entries:mvp2",f=null,p=!0,d=document.getElementById("ta"),w=document.getElementById("dropdown"),y=document.getElementById("cards"),v=document.getElementById("riderStatus"),D=document.getElementById("raceStatus");function h(t,e,n){let a=t.querySelector(".mark");a&&(a.textContent=e?"\u2705":`\u2716${n?`(${n})`:""}`),t.classList.toggle("ok",!!e),t.classList.toggle("ng",!e)}(function(){try{let e=m+":healthcheck";localStorage.setItem(e,"1"),localStorage.removeItem(e),p=!0}catch(e){p=!1,console.warn("localStorage unavailable",e)}})();function g(){if(f)return f;try{if(!p)return f=[],f;let t=localStorage.getItem(m);return f=t?JSON.parse(t):[],f}catch(t){console.warn("loadEntries error",t),f=[];try{p&&localStorage.setItem(m,"[]")}catch{}return f}}function I(t){if(f=Array.isArray(t)?t:[],!p)return!1;try{return localStorage.setItem(m,JSON.stringify(f)),!0}catch(e){return console.warn("saveEntries error",e),!1}}function b(t){return t.replace(/@([^\s@#\+（）()]+)/g,(e,n)=>`<a href="#" class="riderLink" data-q="@${n}">@${n}</a>`).replace(/\+("[^"]+"|[\w\u3040-\u30ff\u4e00-\u9faf]+)/g,e=>`<a href="#" class="tagLink" data-q="${e}">${e}</a>`)}function S(t){let e=(t??g()).slice().reverse();if(y){if(!e.length){y.innerHTML='<div class="card" style="color:#9ca3af">\uFF08\u307E\u3060\u30E1\u30E2\u304C\u3042\u308A\u307E\u305B\u3093\uFF09</div>';return}y.innerHTML=e.map(n=>{let a=(n.at||"").slice(0,10),u=(n.raw||"").replace(/</g,"&lt;"),o=b(u);return`<div class="card" id="card_${n.id}">
      <div class="head"><span class="date">${a}</span>
        <div style="margin-left:auto;display:flex;gap:.4rem">
          <button class="linklike editBtn" data-id="${n.id}">\u7DE8\u96C6</button>
          <button class="linklike delBtn" data-id="${n.id}">\u524A\u9664</button>
        </div>
      </div>
      <div class="raw">${o}</div>
    </div>`}).join("")}}function T(t,e){let n=g().slice(),a=n.findIndex(o=>o.id===t);if(a<0)return;n[a]={...n[a],raw:e,at:new Date().toISOString()};let u=I(n);S(n),u||alert("\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F")}function A(t){let e=g().filter(a=>a.id!==t),n=I(e);S(e),n||alert("\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F")}function $(){let t=new Date,e=t.getTimezoneOffset()*6e4;return new Date(t.getTime()-e).toISOString().slice(0,10).replace(/-/g,"")}async function B(){try{let t=await fetch(L,{cache:"no-cache"});if(!t.ok)throw new Error("HTTP "+t.status);let e=await t.text(),n=JSON.parse(e||"[]");if(window.RIDERS=(n||[]).map(a=>({id:String(a.\u767B\u9332\u756A\u53F7||"").trim(),name:a.\u9078\u624B\u540D||a.name||"",ki:(a.\u671F||a.ki||"").toString(),region:a.\u5730\u57DF||a.region||"",grade:a.\u7D1A||a.grade||"",profile:(a.\u30D7\u30ED\u30D5\u30A3\u30FC\u30EBURL||a.profile||"").replace("https://keirin.netkeiba.comhttps://","https://")})),h(v,!0),typeof window.updateDropdown=="function")try{window.updateDropdown()}catch(a){console.warn(a)}console.log("RIDERS loaded:",window.RIDERS.length)}catch(t){window.RIDERS=[],h(v,!1,t.message||"fetch error"),console.warn("loadRiders error",t)}}async function C(){try{let t=_($()),e=await fetch(t,{cache:"no-cache"});if(!e.ok)throw new Error("HTTP "+e.status);let n=await e.json();if(window.DAYCARDS=Array.isArray(n)?n:[],h(D,!0),typeof window.updateDropdown=="function")try{window.updateDropdown()}catch(a){console.warn(a)}console.log("DAYCARDS loaded:",window.DAYCARDS.length)}catch(t){window.DAYCARDS=[],h(D,!1,t.message||"fetch error"),console.warn("loadRaces error",t)}}function x(t,e){let n=t.slice(0,e).match(/(^|\s)\/(\S*)$/);return n?{token:n[2],start:e-n[2].length-1,end:e}:null}function R(t){let n=(window.__shim_items||[])[t];if(!n)return;let a=window.__getSlashToken?window.__getSlashToken(d.value,d.selectionStart):x(d.value,d.selectionStart);if(!a)return;let u=n.text||n.label||"",o=d.value.slice(0,a.start),r=d.value.slice(a.end),s=o&&!/\s$/.test(o),l=r&&!/^\s/.test(r),i=(s?" ":"")+u+(l?" ":"");d.value=o+i+r;let c=(o+i).length;d.setSelectionRange(c,c),w.style.display="none",d.focus()}w.addEventListener("pointerdown",t=>{let e=t.target.closest&&t.target.closest(".item");e&&(e.dataset._pointer="down")});w.addEventListener("pointerup",t=>{let e=t.target.closest&&t.target.closest(".item");if(!e)return;let n=parseInt(e.dataset.i,10);R(n)});d.addEventListener("keydown",t=>{if(w.style.display==="block"&&(t.key==="Enter"||t.key==="Tab")){let e=w.querySelector(".item.is-active")||w.querySelector('.item[data-i="0"]');e&&(t.preventDefault(),R(parseInt(e.dataset.i,10)))}});d.addEventListener("input",()=>{typeof window.updateDropdown=="function"&&window.updateDropdown()});d.addEventListener("keyup",t=>{t.key==="/"&&typeof window.updateDropdown=="function"&&window.updateDropdown()});d.addEventListener("click",()=>{typeof window.updateDropdown=="function"&&window.updateDropdown()});document.body.addEventListener("click",t=>{let e=t.target.closest&&t.target.closest(".editBtn"),n=t.target.closest&&t.target.closest(".delBtn");if(e){let o=e.dataset.id,r=g().find(l=>l.id===o);if(!r)return;let s=prompt("\u30E1\u30E2\u3092\u7DE8\u96C6",r.raw||"");if(s==null)return;T(o,s)}if(n){let o=n.dataset.id;confirm("\u3053\u306E\u30E1\u30E2\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F")&&A(o)}let a=t.target.closest&&t.target.closest("a.riderLink"),u=t.target.closest&&t.target.closest("a.tagLink");if(a){t.preventDefault();let o=a.dataset.q;document.getElementById("searchInput").value=o,document.getElementById("searchDlg").showModal()}if(u){t.preventDefault();let o=u.dataset.q;document.getElementById("searchInput").value=o,document.getElementById("searchDlg").showModal()}});(function(){S(g()),B(),C()})();})();
