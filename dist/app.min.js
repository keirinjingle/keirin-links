(()=>{(function(){if(window.updateDropdown)return;let t=["\u4E09\u5206\u6226","\u4E8C\u5206\u6226","\u5358\u9A0E","\u5148\u884C\u4E00\u8ECA","\u307E\u304F\u308A","\u5DEE\u3057","\u30AB\u30DE\u30B7","\u81EA\u5728"];function e(i){return(i||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function n(i,s){let r=i.slice(0,s).match(/(^|\s)\/(\S*)$/);return r?{token:r[2],start:s-r[2].length-1,end:s}:null}function o(i){let s=(i||"").toLowerCase(),r=[],p=!!(s&&s.length>0);try{let c=window.RIDERS;Array.isArray(c)&&c.length&&p&&c.filter(f=>((f.name||"")+" "+(f.region||"")+" "+(f.ki||"")).toLowerCase().includes(s)).slice(0,24).forEach(f=>r.push({type:"rider",text:"@"+(f.name||""),label:f.name||"",payload:f}))}catch{}(s?t.filter(c=>c.toLowerCase().includes(s)):t).forEach(c=>r.push({type:"tactic",text:"#"+c,label:"#"+c})),s&&r.push({type:"tag",text:"+"+i,label:"+"+i});try{let c=window.DAYCARDS;if(Array.isArray(c)&&c.length)for(let f of c){let g=f.venue||"",T=g.toLowerCase();for(let A of f.races||[]){let v=`${g}${A.race_number}R`,C=v.toLowerCase();(s?C.includes(s)||T.includes(s):!0)&&r.push({type:"race",text:"- "+v,label:v})}}}catch{}return window.__shim_items=r.slice(0,80),window.__shim_items}function a(i){let s=document.getElementById("dropdown");if(!s)return;if(!i||!i.length){s.style.display="none",s.innerHTML="";return}s.innerHTML=i.map((d,c)=>`<div class="item" data-i="${c}"><span class="type">${d.type==="race"?"\u30EC\u30FC\u30B9":d.type==="tactic"?"\u6226\u6CD5":d.type==="rider"?"\u9078\u624B":"\u30BF\u30B0"}</span> ${e(d.text||d.label||"")}</div>`).join(""),s.style.display="block";let r=0;for(let d=0;d<i.length;d++)if(i[d].type==="rider"){r=d;break}s.querySelectorAll(".item").forEach((d,c)=>d.classList.toggle("is-active",c===r))}window.__getSlashToken=n,window.updateDropdown=function(){if(window.__isComposing){let d=document.getElementById("dropdown");d&&(d.style.display="none",d.innerHTML="");return}let i=document.getElementById("ta");if(!i)return;let s=i.selectionStart||0,r=n(i.value,s);if(!r){a([]);return}let p=o(r.token);a(p)},window.__shim_items=window.__shim_items||[],console.info("mofu: shim installed (dropdown builder)")})();var x="https://keirinjingle.github.io/keirin-links/senshuID.json",B=t=>`https://keirinjingle.github.io/keirin-links/data/keirin_race_list_${t}.json`,y="mofu:entries:mvp2",l=document.getElementById("ta"),u=document.getElementById("dropdown"),E=document.getElementById("cards"),D=document.getElementById("riderStatus"),_=document.getElementById("raceStatus");window.__isComposing=!1;function L(...t){window.console&&console.log(...t)}function $(){let t=new Date,e=t.getTimezoneOffset()*6e4;return new Date(t.getTime()-e).toISOString().slice(0,10).replace(/-/g,"")}function S(t,e,n){if(!t)return;let o=t.querySelector(".mark");o&&(o.textContent=e?"\u2705":`\u2716${n?`(${n})`:""}`),t.classList.toggle("ok",!!e),t.classList.toggle("ng",!e)}var w=null,m=!0;(function(){try{localStorage.setItem(y+":hc","1"),localStorage.removeItem(y+":hc"),m=!0}catch(t){m=!1,console.warn("localStorage not available",t)}})();function h(){if(w)return w;try{if(!m)return w=[],w;let t=localStorage.getItem(y);return w=t?JSON.parse(t):[],w}catch(t){console.warn("loadEntries error \u2014 reinit",t),w=[];try{m&&localStorage.setItem(y,"[]")}catch{}return w}}function R(t){if(w=Array.isArray(t)?t:[],!m)return!1;try{return localStorage.setItem(y,JSON.stringify(w)),!0}catch(e){return console.warn("saveEntries error",e),!1}}function M(t){return t.replace(/@([^\s@#\+（）()]+)/g,(e,n)=>`<a href="#" class="riderLink" data-q="@${n}">@${n}</a>`).replace(/\+("[^"]+"|[\w\u3040-\u30ff\u4e00-\u9faf]+)/g,e=>`<a href="#" class="tagLink" data-q="${e}">${e}</a>`)}function k(t){if(!E)return;let e=(t??h()).slice().reverse();if(!e.length){E.innerHTML='<div class="card" style="color:#9ca3af">\uFF08\u307E\u3060\u30E1\u30E2\u304C\u3042\u308A\u307E\u305B\u3093\uFF09</div>';return}E.innerHTML=e.map(n=>{let o=(n.at||"").slice(0,10),a=(n.raw||"").replace(/</g,"&lt;");return`<div class="card" id="card_${n.id}">
      <div class="head"><span class="date">${o}</span>
        <div style="margin-left:auto;display:flex;gap:.4rem">
          <button class="linklike editBtn" data-id="${n.id}">\u7DE8\u96C6</button>
          <button class="linklike delBtn" data-id="${n.id}">\u524A\u9664</button>
        </div>
      </div>
      <div class="raw">${M(a)}</div>
    </div>`}).join("")}function O(t,e){let n=h().slice(),o=n.findIndex(i=>i.id===t);if(o<0)return;n[o]={...n[o],raw:e,at:new Date().toISOString()};let a=R(n);k(n),a||alert("\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F")}function q(t){let e=h().filter(o=>o.id!==t),n=R(e);k(e),n||alert("\u4FDD\u5B58\u306B\u5931\u6557\u3057\u307E\u3057\u305F")}async function H(){try{let t=await fetch(x,{cache:"no-cache"});if(!t.ok)throw new Error("HTTP "+t.status);let e=await t.text(),n=JSON.parse(e||"[]");if(window.RIDERS=(n||[]).map(o=>({id:String(o.\u767B\u9332\u756A\u53F7||"").trim(),name:o.\u9078\u624B\u540D||o.name||"",ki:(o.\u671F||o.ki||"")+"",region:o.\u5730\u57DF||o.region||"",grade:o.\u7D1A||o.grade||""})),S(D,!0),typeof window.updateDropdown=="function")try{window.updateDropdown()}catch(o){console.warn("updateDropdown failed after fetchRiders",o)}L("RIDERS loaded:",window.RIDERS.length)}catch(t){window.RIDERS=[],S(D,!1,t.message||"fetch error"),console.warn("fetchRiders error",t)}}async function Y(){try{let t=B($()),e=await fetch(t,{cache:"no-cache"});if(!e.ok)throw new Error("HTTP "+e.status);let n=await e.json();if(window.DAYCARDS=Array.isArray(n)?n:[],S(_,!0),typeof window.updateDropdown=="function")try{window.updateDropdown()}catch(o){console.warn("updateDropdown failed after fetchRaces",o)}L("DAYCARDS loaded:",window.DAYCARDS.length)}catch(t){window.DAYCARDS=[],S(_,!1,t.message||"fetch error"),console.warn("fetchRaces error",t)}}function j(t,e){let n=t.slice(0,e).match(/(^|\s)\/(\S*)$/);return n?{token:n[2],start:e-n[2].length-1,end:e}:null}function b(t){let e=window.__shim_items||[];if(!e.length)return;let n=e[t];if(!n&&(t=0,n=e[0],!n))return;let o=typeof window.__getSlashToken=="function"?window.__getSlashToken(l.value,l.selectionStart):j(l.value,l.selectionStart);if(o&&o.token&&o.token.length>0&&n.type!=="rider"){let f=e.find(g=>g.type==="rider");f&&(n=f)}let a=n.text||n.label||"";if(!a)return;let i=o?l.value.slice(0,o.start):l.value.slice(0,l.selectionStart),s=o?l.value.slice(o.end):l.value.slice(l.selectionEnd),r=i&&!/\s$/.test(i),p=s&&!/^\s/.test(s),d=(r?" ":"")+a+(p?" ":"");l.value=i+d+s;let c=(i+d).length;l.setSelectionRange(c,c),u&&(u.style.display="none"),l.focus()}function I(t){if(!u)return;let e=Array.from(u.querySelectorAll(".item"));if(!e.length)return;let n=e.findIndex(i=>i.classList.contains("is-active"));n<0&&(n=0);let o=(n+t+e.length)%e.length;e.forEach((i,s)=>i.classList.toggle("is-active",s===o));let a=e[o];a&&a.scrollIntoView({block:"nearest"})}if(u){let t=null;u.addEventListener("pointerdown",e=>{let n=e.target.closest&&e.target.closest(".item");n&&(t={idx:parseInt(n.dataset.i,10),x:e.clientX,y:e.clientY,dragged:!1})}),u.addEventListener("pointermove",e=>{t&&(Math.abs(e.clientX-t.x)>6||Math.abs(e.clientY-t.y)>6)&&(t.dragged=!0)}),u.addEventListener("pointerup",e=>{if(!t)return;let n=e.target.closest&&e.target.closest(".item"),o=n?parseInt(n.dataset.i,10):t.idx,a=t.dragged;t=null,a||b(o)}),u.addEventListener("pointercancel",()=>{t=null})}l&&(l.addEventListener("compositionstart",()=>{window.__isComposing=!0}),l.addEventListener("compositionend",()=>{window.__isComposing=!1,setTimeout(()=>{typeof window.updateDropdown=="function"&&window.updateDropdown()},30)}),l.addEventListener("input",()=>{window.__isComposing||typeof window.updateDropdown=="function"&&window.updateDropdown()}),l.addEventListener("keyup",t=>{t.key==="/"&&!window.__isComposing&&typeof window.updateDropdown=="function"&&window.updateDropdown()}),l.addEventListener("keydown",t=>{if(!window.__isComposing&&!(!u||u.style.display!=="block")){if(t.key==="ArrowDown"){t.preventDefault(),I(1);return}if(t.key==="ArrowUp"){t.preventDefault(),I(-1);return}if(t.key==="Enter"||t.key==="Tab"){let e=u.querySelector(".item.is-active")||u.querySelector('.item[data-i="0"]');if(e){t.preventDefault();let n=parseInt(e.dataset.i,10);b(n)}}t.key==="Escape"&&(u.style.display="none")}}));(function(){let e=()=>{let n=document.getElementById("settingsBtn"),o=document.getElementById("settingsMenu");if(!n||!o){setTimeout(e,120);return}o.style.display=o.style.display||"none",o.style.zIndex=o.style.zIndex||999,n.addEventListener("click",a=>{a.stopPropagation(),o.style.display=o.style.display==="block"?"none":"block"}),document.addEventListener("click",a=>{!o.contains(a.target)&&a.target!==n&&(o.style.display="none")}),document.addEventListener("keydown",a=>{a.key==="Escape"&&(o.style.display="none")}),window.addEventListener("scroll",()=>{o&&o.style.display==="block"&&(o.style.display="none")},{passive:!0})};document.readyState==="complete"||document.readyState==="interactive"?e():document.addEventListener("DOMContentLoaded",e)})();document.body.addEventListener("click",t=>{let e=t.target.closest&&t.target.closest(".editBtn"),n=t.target.closest&&t.target.closest(".delBtn");if(e){let i=e.dataset.id,s=h().find(p=>p.id===i);if(!s)return;let r=prompt("\u30E1\u30E2\u3092\u7DE8\u96C6",s.raw||"");if(r==null)return;O(i,r);return}if(n){let i=n.dataset.id;confirm("\u3053\u306E\u30E1\u30E2\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F")&&q(i);return}let o=t.target.closest&&t.target.closest("a.riderLink"),a=t.target.closest&&t.target.closest("a.tagLink");if(o){t.preventDefault();let i=o.dataset.q,s=document.getElementById("searchInput");s&&(s.value=i);let r=document.getElementById("searchDlg");r&&r.showModal();return}if(a){t.preventDefault();let i=a.dataset.q,s=document.getElementById("searchInput");s&&(s.value=i);let r=document.getElementById("searchDlg");r&&r.showModal();return}});(function(){k(h()),H(),Y()})();})();
