<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‚‚ãµãƒ¡ãƒ¢ | Riders/Races + Drive Sync (robust + race search)</title>
<meta name="description" content="ç«¶è¼ªãƒ¡ãƒ¢ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‹/ã‚µã‚¸ã‚§ã‚¹ãƒˆï¼ˆæˆ¦æ³•ãƒ»é¸æ‰‹ãƒ»ãƒ¬ãƒ¼ã‚¹ãƒ»ã‚¿ã‚°ï¼‰ï¼‹ç´ æœ´æ¤œç´¢ï¼‹DriveåŒæœŸï¼‹ãƒ¬ãƒ¼ã‚¹æ¤œç´¢ã€‚" />

<!-- â–¼ ã‚ãªãŸã® Client IDï¼ˆ.apps.googleusercontent.com ã§çµ‚ã‚ã‚‹ï¼‰ -->
<meta name="mofu:google-client-id" content="451004577569-euhu5f661onevj9a0tlsfr9i4jntm6jm.apps.googleusercontent.com">
<!-- â–¼ è¨±å¯ã‚ªãƒªã‚¸ãƒ³ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ ï¼‰ -->
<meta name="mofu:allowed-origins" content="https://keirinjingle.github.io, http://localhost:3000, https://qui2.net">

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
html{ color-scheme: light; }  /* å¸¸ã«ãƒ©ã‚¤ãƒˆæ‰±ã„ã«ã™ã‚‹ */
:root{
  /* åŸºèª¿ã‚«ãƒ©ãƒ¼ */
  --bg:#fafaf9;        /* èƒŒæ™¯ */
  --card:#ffffff;      /* ã‚«ãƒ¼ãƒ‰èƒŒæ™¯ */
  --fg:#0f172a;        /* æ–‡å­— */
  --muted:#6b7280;     /* è£œåŠ©æ–‡å­— */
  --line:#e5e7eb;      /* æ ç·š */
  --brand:#2563eb;     /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ */
  --brand-weak:#eff6ff;
  --success:#10b981;
  --danger:#ef4444;
  --warn:#f59e0b;
  --hl:#fff7cc;

  /* å½±ãƒ»ä¸¸ã¿ */
  --radius:14px;
  --radius-sm:10px;
  --shadow-sm:0 2px 6px rgba(15,23,42,.06);
  --shadow-md:0 8px 24px rgba(15,23,42,.08);
  --shadow-lg:0 20px 40px rgba(15,23,42,.10);
}



/* ãƒ™ãƒ¼ã‚¹ */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,
               "Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
  color:var(--fg);
  background:radial-gradient(1200px 600px at 20% -10%, rgba(37,99,235,.06), transparent 60%),
             radial-gradient(900px 500px at 100% -10%, rgba(16,185,129,.06), transparent 55%),
             var(--bg);
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
header{
  position:sticky; top:0; z-index:40;
  backdrop-filter: saturate(120%) blur(8px);
  background:color-mix(in oklab, var(--card) 92%, transparent);
  border-bottom:1px solid var(--line);
}
.bar{
  display:flex; align-items:center; gap:.6rem;
  padding:.65rem .9rem; flex-wrap:wrap;
  max-width:1000px; margin:0 auto;
}
.title{
  font-weight:800; letter-spacing:.2px; margin-right:auto;
  display:flex; align-items:center; gap:.4rem;
}
.title::after{
  content:"beta";
  font-size:.65rem; color:var(--brand);
  border:1px solid color-mix(in oklab, var(--brand) 60%, var(--line));
  border-radius:999px; padding:.05rem .4rem;
}

/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
.wrap{max-width:900px;margin:16px auto;padding:0 12px}

/* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
textarea{
  width:100%; min-height:132px; font-size:16px; line-height:1.65;
  padding:14px 14px 48px; resize:vertical;
  color:var(--fg);
  background:linear-gradient(180deg, color-mix(in oklab, var(--card) 98%, transparent) 0%,
                                     color-mix(in oklab, var(--card) 92%, transparent) 100%);
  border:1px solid var(--line); border-radius:var(--radius);
  box-shadow:var(--shadow-sm);
  transition:border-color .18s ease, box-shadow .18s ease, background .18s ease;
}
textarea:focus-visible{
  outline:none;
  border-color:color-mix(in oklab, var(--brand) 55%, var(--line));
  box-shadow:0 0 0 3px color-mix(in oklab, var(--brand) 20%, transparent);
}

/* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
.toolbar{display:flex; gap:.55rem; align-items:center; flex-wrap:wrap; margin:.5rem 0 .6rem}
.btn{
  appearance:none; cursor:pointer;
  border:1px solid var(--line);
  background:linear-gradient(180deg, var(--card), color-mix(in oklab, var(--card) 92%, transparent));
  color:var(--fg);
  padding:.55rem .9rem; font-size:.95rem; border-radius:12px;
  box-shadow:var(--shadow-sm);
  transition:transform .06s ease, box-shadow .18s ease, border-color .18s ease, background .18s ease;
}
.btn:hover{ box-shadow:var(--shadow-md) }
.btn:active{ transform:translateY(1px) }
.btn:focus-visible{ outline:none; box-shadow:0 0 0 3px color-mix(in oklab, var(--brand) 20%, transparent) }

.btn-primary{
  background:linear-gradient(180deg, color-mix(in oklab, var(--brand) 16%, var(--card)),
                                     color-mix(in oklab, var(--brand) 8%, var(--card)));
  border-color:color-mix(in oklab, var(--brand) 45%, var(--line));
}
.btn-primary:hover{
  background:linear-gradient(180deg, color-mix(in oklab, var(--brand) 22%, var(--card)),
                                     color-mix(in oklab, var(--brand) 12%, var(--card)));
}
.btn-link{
  color:var(--brand); text-decoration:none;
  border:1px solid var(--line); background:var(--card);
  padding:.45rem .7rem; border-radius:12px;
  transition:background .18s ease, color .18s ease, border-color .18s ease;
}
.btn-link:hover{ background:var(--brand-weak); border-color:color-mix(in oklab, var(--brand) 30%, var(--line)) }

.linklike{
  color:var(--brand); background:transparent; border:none;
  padding:.25rem .35rem; cursor:pointer; border-radius:8px;
}
.linklike:hover{ background:var(--brand-weak) }

/* ã‚«ãƒ¼ãƒ‰ */
.cards{margin-top:14px}
.card{
  padding:12px 14px; border:1px solid var(--line); border-radius:var(--radius);
  background:var(--card); margin-bottom:12px; box-shadow:var(--shadow-sm);
}
.card:hover{ box-shadow:var(--shadow-md) }
.head{
  font-size:.95rem; margin-bottom:6px; display:flex; gap:.5rem; flex-wrap:wrap; align-items:center
}
.head .date{ font-weight:700 }
.raw{ white-space:pre-wrap; word-break:break-word; font-family: ui-sans-serif, "Noto Sans JP", sans-serif; }
.footer{ color:var(--muted); font-size:.85rem; text-align:center; padding:22px 8px }

/* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ä¸‹ãƒ»ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰ */
#taWrap{ position:relative }
.dropdown{
  position:absolute; left:0; right:0; top:100%; margin-top:8px;
  border:1px solid var(--line); border-radius:var(--radius);
  background:var(--card); display:none; overflow:auto; max-height:320px; z-index:50;
  box-shadow:var(--shadow-lg);
  padding:6px;
  overscroll-behavior: contain; -webkit-overflow-scrolling: touch; touch-action: pan-y;
}
.item{
  padding:.6rem .7rem; cursor:pointer; font-size:.95rem;
  display:flex; gap:.6rem; align-items:center; border-radius:10px;
  transition:background .12s ease;
}
.item:hover{ background:color-mix(in oklab, var(--brand) 8%, transparent) }
.item.is-active{ background:color-mix(in oklab, var(--brand) 14%, transparent) }
.type{
  font-size:.7rem; color:var(--brand);
  border:1px solid color-mix(in oklab, var(--brand) 50%, var(--line));
  background:var(--brand-weak);
  border-radius:999px; padding:0 .45rem
}

/* ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
dialog{
  border:none; border-radius:var(--radius); max-width:860px; width:96%;
  background:var(--card); color:var(--fg); box-shadow:var(--shadow-lg);
}
dialog::backdrop{ background:rgba(0,0,0,.35) }
.hl{ background:var(--hl); font-weight:700; padding:.05em .15em; border-radius:.25em }

/* ãƒãƒƒã‚¸ */
.badge{
  display:inline-flex; align-items:center; gap:.35rem;
  padding:.22rem .55rem; border:1px solid var(--line); border-radius:999px;
  font-size:.8rem; background:var(--card);
}
.ok{ color:var(--success) } .ng{ color:var(--danger) }

/* è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
.settings{ position:relative }
.settings-menu{
  position:absolute; right:0; top:calc(100% + 8px); z-index:60;
  min-width:240px; background:var(--card); border:1px solid var(--line);
  border-radius:12px; box-shadow:var(--shadow-lg); display:none; overflow:hidden;
}
.settings-menu .mi{
  padding:.7rem .9rem; cursor:pointer; border-bottom:1px solid color-mix(in oklab, var(--line) 80%, transparent);
  transition:background .12s ease;
}
.settings-menu .mi:last-child{ border-bottom:none }
.settings-menu .mi:hover{ background:var(--brand-weak) }


/* æ¤œç´¢ã‚¿ãƒ– */
.tabs{
  display:flex; gap:.4rem; border-bottom:1px solid var(--line); padding:0 .2rem; margin-top:.25rem
}
.tab{
  appearance:none; background:transparent; border:none; cursor:pointer;
  padding:.75rem .9rem; border-bottom:2px solid transparent; border-radius:8px 8px 0 0;
  color:var(--muted); font-weight:600; transition:color .18s ease, border-color .18s ease, background .18s ease;
}
.tab:hover{ background:color-mix(in oklab, var(--brand) 8%, transparent) }
.tab.is-active{ border-color:var(--brand); color:var(--fg) }
.tabpanel{ display:none; padding:.9rem 0 }
.tabpanel.is-active{ display:block }

/* å…¥åŠ›ã‚„ãƒ©ãƒ™ãƒ« */
.list{ display:grid; gap:.6rem }
.pill{
  display:inline-flex; align-items:center; gap:.35rem;
  border:1px solid var(--line); border-radius:999px; padding:.25rem .6rem; font-size:.85rem;
  background:color-mix(in oklab, var(--brand) 6%, transparent);
}
.muted{ color:var(--muted) }
.small{ font-size:.86rem }
.kbd{
  font-family:ui-monospace, Menlo, monospace; padding:0 .35rem;
  border:1px solid var(--line); border-radius:.35rem; background:color-mix(in oklab, var(--card) 88%, transparent)
}

/* ãƒ¬ãƒ¼ã‚¹å€™è£œ */
.race-suggest{
  max-height:42vh; overflow:auto; border:1px solid var(--line);
  border-radius:var(--radius-sm); padding:.35rem; background:var(--card);
  box-shadow:var(--shadow-sm);
}
.race-suggest .row{
  padding:.55rem .65rem; border-radius:10px; cursor:pointer;
  transition:background .12s ease, transform .06s ease;
}
.race-suggest .row:hover{ background:color-mix(in oklab, var(--brand) 8%, transparent) }
.race-suggest .row:active{ transform:translateY(1px) }

/* é¸æ‰‹ãƒªã‚¹ãƒˆ & ãƒãƒ¼ãƒˆ */
.player-list{ display:grid; gap:.5rem }
.player-item{
  padding:.55rem .65rem; border:1px solid var(--line); border-radius:10px; cursor:pointer;
  background:var(--card); transition:background .12s ease, transform .06s ease, box-shadow .18s ease;
  box-shadow:var(--shadow-sm);
}
.player-item:hover{ background:var(--brand-weak); box-shadow:var(--shadow-md) }
.note-list .note{
  padding:.55rem .65rem; border:1px solid var(--line); border-radius:10px;
  background:var(--card); box-shadow:var(--shadow-sm);
}

/* ã‚¤ãƒ³ãƒ—ãƒƒãƒˆ */
input[type="text"]{
  background:var(--card); color:var(--fg);
  border:1px solid var(--line); border-radius:.6rem;
  padding:.5rem .65rem; outline:none;
  transition:border-color .18s ease, box-shadow .18s ease, background .18s ease;
}
input[type="text"]:focus{
  border-color:color-mix(in oklab, var(--brand) 45%, var(--line));
  box-shadow:0 0 0 3px color-mix(in oklab, var(--brand) 20%, transparent);
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆWebKitï¼‰ */
.dropdown::-webkit-scrollbar,
.race-suggest::-webkit-scrollbar{ width:10px; height:10px }
.dropdown::-webkit-scrollbar-thumb,
.race-suggest::-webkit-scrollbar-thumb{
  background:color-mix(in oklab, var(--fg) 12%, transparent);
  border-radius:999px;
}
.dropdown::-webkit-scrollbar-track,
.race-suggest::-webkit-scrollbar-track{ background:transparent }

/* ä½ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒ */
@media (prefers-reduced-motion: reduce){
  *{ transition:none !important; animation:none !important }
}

/* ä½™ç™½å¾®èª¿æ•´ï¼ˆå°ç”»é¢ï¼‰ */
@media (max-width: 480px){
  .bar{ padding:.55rem .7rem }
  .toolbar{ gap:.45rem }
  .btn, .btn-link{ padding:.5rem .75rem; border-radius:10px }
}

/* ========== ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ ========== */
.sel{
  background:var(--card); color:var(--fg);
  border:1px solid var(--line); border-radius:.6rem;
  padding:.45rem .6rem; outline:none;
  transition:border-color .18s ease, box-shadow .18s ease;
}
.sel:focus{
  border-color:color-mix(in oklab, var(--brand) 45%, var(--line));
  box-shadow:0 0 0 3px color-mix(in oklab, var(--brand) 20%, transparent);
}

.pager{
  display:flex; gap:.35rem; justify-content:center; align-items:center;
  flex-wrap:wrap; margin:14px 0 20px;
}
.pager .pp{
  appearance:none; cursor:pointer; user-select:none;
  border:1px solid var(--line); background:var(--card); color:var(--fg);
  padding:.45rem .7rem; border-radius:10px; font-size:.95rem;
  box-shadow:var(--shadow-sm);
}
.pager .pp[disabled]{ opacity:.5; cursor:default }
.pager .pp.is-current{
  border-color:color-mix(in oklab, var(--brand) 45%, var(--line));
  background:color-mix(in oklab, var(--brand) 10%, var(--card));
  font-weight:700;
}
.pager .dots{ padding:.45rem .4rem; color:var(--muted) }


</style>
</head>
<body>
<header>
  <!-- ä¸Šæ®µï¼šã‚¿ã‚¤ãƒˆãƒ«ï¼‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
  <div class="bar">
    <div class="title">ğŸ¾ ã‚‚ãµãƒ¡ãƒ¢</div>
    <span id="riderStatus" class="badge">é¸æ‰‹DB <span class="mark">â€¦</span></span>
    <span id="raceStatus" class="badge">ãƒ¬ãƒ¼ã‚¹æƒ…å ± <span class="mark">â€¦</span></span>
    <span id="syncStatus" class="badge" style="display:none">åŒæœŸ<span class="mark">â€”</span>
</span>
  </div>
  <!-- ä¸‹æ®µï¼šå³å¯„ã›ã®ãƒªãƒ³ã‚¯ç¾¤ï¼ˆä½¿ã„æ–¹ï¼è¨­å®šï¼å¯„ä»˜ï¼‰ -->
  <div class="bar">
    <div style="flex:1"></div>
    <a class="btn-link" href="https://keirinjingle.github.io/keirin-links/howto.html" target="_blank" rel="noopener">ä½¿ã„æ–¹</a>
    <div class="settings">
      <button id="settingsBtn" class="btn">è¨­å®š â–¾</button>
      <div id="settingsMenu" class="settings-menu">
        <div id="loginMi" class="mi">Googleãƒ­ã‚°ã‚¤ãƒ³</div>
        <div id="logoutMi" class="mi">Googleãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</div> 
        <div id="importMi" class="mi">ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆNDJSONï¼‰</div>
        <div id="exportMi" class="mi">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆNDJSONï¼‰</div>
      </div>
    </div>
    <a class="btn-link" href="https://keirinjingle.github.io/keirin-links/donation.html" target="_blank" rel="noopener">å¯„ä»˜</a>
  </div>
</header>

<main id="homeView" class="wrap">
  <div class="toolbar">
    <button id="inlineSlash" class="btn" title="/ ã‚’æŒ¿å…¥">/</button>
    <button id="openSearch" class="btn" title="Ctrl/Cmd+K ã§ã‚‚é–‹ã‘ã¾ã™">ãƒ¬ãƒ¼ã‚¹æ¤œç´¢</button>
    <button id="addBtn" class="btn btn-primary">ç™»éŒ²</button>
      <div style="margin-left:auto;display:flex;align-items:center;gap:.5rem">
    <label for="pageSize" class="small muted">è¡¨ç¤º</label>
    <select id="pageSize" class="sel">
      <option value="10">10ä»¶</option>
      <option value="20" selected>20ä»¶</option>
      <option value="50">50ä»¶</option>
      <option value="100">100ä»¶</option>
    </select>
  </div>

  </div>

  <div id="taWrap" style="position:relative">
    <textarea id="ta" placeholder="ä¾‹ï¼‰- å‡½é¤¨6R å…ˆè¡Œæ³¨æ„ /ã¾ãã‚Š +å±•é–‹ @å±±ç”°å¤ªéƒ"></textarea>
    <div id="dropdown" class="dropdown"></div>
  </div>

  <section id="cards" class="cards"></section>
    <div id="pager" class="pager" style="display:none"></div>


  <div class="footer">ãƒ‡ãƒ¼ã‚¿ã¯ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã€‚Googleæ¥ç¶šã§ Drive(App Folder) åŒæœŸãŒä½¿ãˆã¾ã™ã€‚</div>
</main>

<section id="editView" class="wrap" style="display:none">
  <div class="toolbar" style="justify-content:space-between">
    <div><strong>ç·¨é›†</strong> <span id="editMeta" class="muted small"></span></div>
    <div>
        <button id="eInlineSlash" class="btn" title="/ ã‚’æŒ¿å…¥">/</button>
        <button id="eOpenSearch" class="btn" title="Ctrl/Cmd+K ã§ã‚‚é–‹ã‘ã¾ã™">ãƒ¬ãƒ¼ã‚¹æ¤œç´¢</button>
      <button id="saveEditBtn" class="btn btn-primary">ä¿å­˜</button>
      <button id="cancelEditBtn" class="btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  <!-- ã“ã“ã«æ—¢å­˜ã® #taWrapï¼ˆã‚µã‚¸ã‚§ã‚¹ãƒˆä»˜ããƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼‰ã‚’â€œç§»å‹•â€ã—ã¦ä½¿ã† -->
  <div id="editMount"></div>
</section>


<!-- æ¤œç´¢ -->
<dialog id="searchDlg">
  <div style="padding:12px 14px; display:grid; gap:10px;">
    <div style="display:flex;align-items:center;gap:.5rem;justify-content:space-between">
      <strong>æ¤œç´¢</strong>
      <button id="searchClose" class="btn">é–‰ã˜ã‚‹</button>
    </div>

    <div class="tabs">
      <button id="tabRace"  class="tab is-active">ãƒ¬ãƒ¼ã‚¹å†…æ¤œç´¢</button>
      <button id="tabFull"  class="tab">å…¨æ–‡æ¤œç´¢</button>
    </div>

    <!-- â–¼ ãƒ¬ãƒ¼ã‚¹å†…æ¤œç´¢ -->
    <div id="panelRace" class="tabpanel is-active">
      <div class="list">
        <div style="display:flex; gap:.6rem; align-items:center; flex-wrap:wrap;">
          <input id="raceSearchInput" type="text" placeholder="ä¾‹ï¼šå‡½é¤¨ 6R / ç«‹å·6R" style="width:32ch;max-width:60vw;padding:.4rem .6rem;border:1px solid var(--line);border-radius:.6rem">
          <button id="raceSearchClear" class="btn">ã‚¯ãƒªã‚¢</button>
          <span class="muted small">å½“æ—¥ã®ä¼šå ´ã¨Rç•ªå·ã‹ã‚‰æ¤œç´¢</span>
        </div>
        <div id="raceSuggest" class="race-suggest"></div>

        <div id="raceView" class="card" style="display:none">
          <div class="head">
            <span class="date" id="raceHead"></span>
            <a id="raceEntryLink" class="btn-link" href="#" target="_blank" rel="noopener">å‡ºèµ°è¡¨</a>
            <a id="raceResultLink" class="btn-link" href="#" target="_blank" rel="noopener" style="display:none">çµæœ</a>
          </div>
          <div class="player-list" id="playerList"></div>
        </div>

        <div id="playerNotesWrap" class="card" style="display:none">
          <div class="head"><strong id="playerNotesHead">@é¸æ‰‹ ã®éå»ãƒ¡ãƒ¢</strong></div>
          <div id="playerNotes" class="note-list"></div>
        </div>

        <div id="newMemoWrap" class="card" style="display:none">
          <div class="head"><strong>ãƒ¡ãƒ¢ã‚’è¿½åŠ </strong></div>
          <textarea id="newMemoTa" placeholder="- å‡½é¤¨6R â€¦ @é¸æ‰‹å"></textarea>
          <div style="display:flex; gap:.5rem; margin-top:.5rem;">
            <button id="saveMemoBtn" class="btn btn-primary">ç™»éŒ²</button>
            <button id="cancelMemoBtn" class="btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
          <div id="newMemoTip" class="muted small" style="margin-top:.25rem">â€» ç™»éŒ²ã™ã‚‹ã¨ä¸€è¦§ã«å³åæ˜ ã•ã‚Œã¾ã™</div>
        </div>
      </div>
    </div>

    <!-- â–¼ å…¨æ–‡æ¤œç´¢ -->
    <div id="panelFull" class="tabpanel">
      <div style="display:flex; gap:.6rem; align-items:center; flex-wrap:wrap;">
        <input id="searchInput" type="text" placeholder="èªå¥ã‚’å…¥åŠ›ï¼ˆraw.includesï¼‰" style="width:46ch;max-width:68vw;padding:.4rem .6rem;border:1px solid var(--line);border-radius:.6rem">
        <span class="muted small">ãƒ’ãƒ³ãƒˆï¼š<span class="kbd">@åå‰</span> ã‚„ <span class="kbd">+ã‚¿ã‚°</span> ã§ã‚‚æ¤œç´¢ã§ãã¾ã™</span>
      </div>
      <div id="searchCount" style="color:#6b7280;margin-top:.4rem"></div>
      <div id="searchList" style="margin-top:.25rem; max-height:60vh; overflow:auto;"></div>
    </div>
  </div>
</dialog>

<!-- åˆå›åŒæœŸã®å‘ãç¢ºèª -->
<dialog id="syncDlg">
  <form method="dialog" style="padding:14px 16px; display:grid; gap:12px; max-width:720px;">
    <h3 style="margin:0;">Google åŒæœŸã®åˆæœŸè¨­å®š</h3>
    <div id="syncSummary" style="color:#374151; line-height:1.6"></div>
    <div style="background:#fff7ed;border:1px solid #fde68a;border-radius:10px;padding:10px 12px;color:#9a3412;font-size:.9rem">
      â€» ã©ã¡ã‚‰ã‹ä¸€æ–¹ã«<strong>ä¸Šæ›¸ã</strong>ã—ã¾ã™ã€‚å¿…è¦ãªã‚‰å…ˆã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚
    </div>
    <div style="display:flex; gap:.5rem; justify-content:flex-end">
      <button value="localToServer" class="btn btn-primary">ãƒ­ãƒ¼ã‚«ãƒ«â†’ã‚µãƒ¼ãƒãƒ¼ã«ä¸Šæ›¸ã</button>
      <button value="serverToLocal" class="btn">ã‚µãƒ¼ãƒãƒ¼â†’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¸Šæ›¸ã</button>
      <button value="cancel" class="btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </form>
</dialog>

<script>
// â–¼ ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
const KEY_PAGE_SIZE = 'mofu:list:pageSize';
let pageSize = Number(localStorage.getItem(KEY_PAGE_SIZE)) || 20;
let currentPage = 1;
const pagerEl = document.getElementById('pager');
const pageSizeSel = document.getElementById('pageSize');
if (pageSizeSel) pageSizeSel.value = String(pageSize);
if (pageSizeSel) pageSizeSel.addEventListener('change', ()=>{
  const v = parseInt(pageSizeSel.value, 10);
  if (!Number.isFinite(v) || v <= 0) return;
  pageSize = v;
  localStorage.setItem(KEY_PAGE_SIZE, String(pageSize));
  currentPage = 1;                       // ä»¶æ•°å¤‰æ›´æ™‚ã¯å…ˆé ­ãƒšãƒ¼ã‚¸ã¸
  renderList();
});

function makePageWindow(totalPages, cur){
  const pages = [];
  const around = 2;
  pages.push(1);
  let s = Math.max(2, cur - around);
  let e = Math.min(totalPages - 1, cur + around);
  if (s > 2) pages.push('...');
  for (let p = s; p <= e; p++) pages.push(p);
  if (e < totalPages - 1) pages.push('...');
  if (totalPages > 1) pages.push(totalPages);
  return pages;
}

function renderPager(totalItems, totalPages){
  if (!pagerEl) return;
  if (totalPages <= 1){
    pagerEl.style.display = 'none';
    pagerEl.innerHTML = '';
    return;
  }
  pagerEl.style.display = 'flex';
  const win = makePageWindow(totalPages, currentPage);
  const prevDis = currentPage === 1 ? 'disabled' : '';
  const nextDis = currentPage === totalPages ? 'disabled' : '';
  const parts = [];
  parts.push(`<button class="pp" data-p="${currentPage-1}" ${prevDis}>â† å‰ã¸</button>`);
  for (const x of win){
    if (x === '...'){ parts.push(`<span class="dots">â€¦</span>`); continue; }
    const cur = (x === currentPage) ? 'is-current' : '';
    parts.push(`<button class="pp ${cur}" data-p="${x}">${x}</button>`);
  }
  parts.push(`<button class="pp" data-p="${currentPage+1}" ${nextDis}>æ¬¡ã¸ â†’</button>`);
  pagerEl.innerHTML = parts.join('');

  pagerEl.onclick = (e)=>{
    const b = e.target.closest('button.pp'); if(!b || b.disabled) return;
    const p = parseInt(b.dataset.p, 10);
    if (!Number.isFinite(p)) return;
    currentPage = Math.max(1, Math.min(totalPages, p));
    renderList();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };
}


const DRIVE_FILENAME='mofu_entries.ndjson';
let tokenClient=null, accessToken=null, driveFileId=null;

/* ========== meta / config ========== */
const CLIENT_ID = (document.querySelector('meta[name="mofu:google-client-id"]')?.content||'').trim();
const ALLOWED_ORIGINS = (document.querySelector('meta[name="mofu:allowed-origins"]')?.content||'')
  .split(',').map(s=>s.trim()).filter(Boolean);
const ORIGIN_ALLOWED = !ALLOWED_ORIGINS.length || ALLOWED_ORIGINS.includes(location.origin);

/* ========== åŸºæœ¬çŠ¶æ…‹ & å®šæ•° ========== */
const ta = document.getElementById('ta');
const dropdown = document.getElementById('dropdown');
const riderStatus = document.getElementById('riderStatus');
const raceStatus  = document.getElementById('raceStatus');

const KEY_ENTRIES = 'mofu:entries:mvp2'; // â† ãƒãƒ¼ã‚¸ãƒ§ãƒ³
let MEM_ENTRIES = null;                  // ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥
let STORAGE_OK = true;                   // localStorage ãŒä½¿ãˆã‚‹ã‹
let composing=false, imeJustEnded=false, ddSel=-1, curItems=[], lastCaret=0;
const IME_SUPPRESS_MS=200;

// ç«¯æœ«åˆ¤å®šã¨ã‚µã‚¤ãƒ¬ãƒ³ãƒˆæ›´æ–°ã®æŠ‘æ­¢ãƒ•ãƒ©ã‚°ï¼ˆAndroidã®ãƒãƒƒã‚¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å¯¾ç­–ï¼‰
const IS_ANDROID = /Android/i.test(navigator.userAgent);
let authRefreshing = false;
let silentDenied = false;  // ä¸€åº¦ã‚µã‚¤ãƒ¬ãƒ³ãƒˆæ›´æ–°ãŒæ‹’å¦/å¤±æ•—ã—ãŸã‚‰ã€ãã®å¾Œã¯è‡ªå‹•å®Ÿè¡Œã—ãªã„


// â–¼ åŒæœŸè¡¨ç¤º
const syncStatus = document.getElementById('syncStatus');
const KEY_LAST_SYNC = 'mofu:drive:lastSyncAtISO';

// åŒæœŸãƒãƒƒã‚¸ã®å†æç”»ï¼šã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã€ã‹ã¤å‰å›åŒæœŸæ™‚åˆ»ãŒã‚ã‚Œã°è¡¨ç¤º
function renderSyncStatus(){
  try{
    const last = localStorage.getItem(KEY_LAST_SYNC);
    const shouldShow = !!(accessToken && last);
    syncStatus.style.display = shouldShow ? 'inline-flex' : 'none';
    if (shouldShow){
      const mark = syncStatus.querySelector('.mark');
      mark.textContent = fmtJst(last);
    }
  }catch{
    // localStorage ä¸å¯ç’°å¢ƒã§ã‚‚å£Šã‚Œãªã„ã‚ˆã†ã«ï¼ˆéè¡¨ç¤ºï¼‰
    syncStatus.style.display = 'none';
  }
}

// åŒæœŸå®Œäº†æ™‚ã«å‘¼ã¶ï¼šæ™‚åˆ»ã‚’ä¿å­˜ã—ã¦ãƒãƒƒã‚¸æ›´æ–°
function setSyncTimeNow(){
  try{ localStorage.setItem(KEY_LAST_SYNC, new Date().toISOString()); }catch{}
  renderSyncStatus();
}


// â–¼ ã‚µã‚¸ã‚§ã‚¹ãƒˆä¸Šé™
const MAX_TOTAL_ITEMS = 60;
const MAX_RACE_ITEMS  = 20;

/* ========== utilï¼ˆJSTæ—¥ä»˜ãƒ»æ­£è¦åŒ–ãªã©ï¼‰ ========== */
const tzJst = 'Asia/Tokyo';

const fmtJst = (d) => {
  const dt = (d instanceof Date) ? d : new Date(d);
  const f = new Intl.DateTimeFormat('ja-JP', {
    timeZone: tzJst, year:'numeric', month:'2-digit', day:'2-digit',
    hour:'2-digit', minute:'2-digit', hour12:false
  });
  const p = f.formatToParts(dt).reduce((o,pp)=>(o[pp.type]=pp.value,o),{});
  return `${p.year}-${p.month}-${p.day} ${p.hour}:${p.minute}`;
};

const ymdJST = () => {
  const f = new Intl.DateTimeFormat('ja-JP', { timeZone: tzJst, year:'numeric', month:'2-digit', day:'2-digit' });
  const p = f.formatToParts(new Date()).reduce((o,pp)=>(o[pp.type]=pp.value,o),{});
  return `${p.year}${p.month}${p.day}`;
};

const ymd_dash = () => {
  const f = new Intl.DateTimeFormat('ja-JP', { timeZone: tzJst, year:'numeric', month:'2-digit', day:'2-digit' });
  const p = f.formatToParts(new Date()).reduce((o,pp)=>(o[pp.type]=pp.value,o),{});
  return `${p.year}-${p.month}-${p.day}`;
};
const pad2 = (n)=> String(n).padStart(2,'0');
const toJstIso = (yyyymmdd, hhmm) => {
  if(!/^\d{8}$/.test(yyyymmdd)||!/^\d{2}:\d{2}$/.test(hhmm)) return null;
  return `${yyyymmdd.slice(0,4)}-${yyyymmdd.slice(4,6)}-${yyyymmdd.slice(6)}T${hhmm}:00+09:00`;
};
const normStr = (s)=> (s||'').normalize('NFKC').replace(/\s+/g,' ').trim();
const normNameKey = (name)=> normStr(name).replace(/\s+/g,''); // æ°åã¯ã‚¹ãƒšãƒ¼ã‚¹é™¤å»ã§ã‚­ãƒ¼åŒ–
const REGION_MAP = {
  'ç¥å¥ˆ':'ç¥å¥ˆå·','åŒ—æµ·':'åŒ—æµ·é“','é¹¿å…':'é¹¿å…å³¶','å¾³å³¶':'å¾³å³¶','ç¾¤é¦¬':'ç¾¤é¦¬','åƒè‘‰':'åƒè‘‰','åŸ¼ç‰':'åŸ¼ç‰','æ±äº¬':'æ±äº¬','ç¦å³¶':'ç¦å³¶','é’æ£®':'é’æ£®','å²©æ‰‹':'å²©æ‰‹','å®®åŸ':'å®®åŸ','ç§‹ç”°':'ç§‹ç”°','å±±å½¢':'å±±å½¢','èŒ¨åŸ':'èŒ¨åŸ','æ ƒæœ¨':'æ ƒæœ¨','æ–°æ½Ÿ':'æ–°æ½Ÿ','å¯Œå±±':'å¯Œå±±','çŸ³å·':'çŸ³å·','ç¦äº•':'ç¦äº•','å±±æ¢¨':'å±±æ¢¨','é•·é‡':'é•·é‡','å²é˜œ':'å²é˜œ','é™å²¡':'é™å²¡','æ„›çŸ¥':'æ„›çŸ¥','ä¸‰é‡':'ä¸‰é‡','æ»‹è³€':'æ»‹è³€','äº¬éƒ½':'äº¬éƒ½','å¤§é˜ª':'å¤§é˜ª','å…µåº«':'å…µåº«','å¥ˆè‰¯':'å¥ˆè‰¯','å’Œæ­Œå±±':'å’Œæ­Œå±±','é³¥å–':'é³¥å–','å³¶æ ¹':'å³¶æ ¹','å²¡å±±':'å²¡å±±','åºƒå³¶':'åºƒå³¶','å±±å£':'å±±å£','é¦™å·':'é¦™å·','æ„›åª›':'æ„›åª›','é«˜çŸ¥':'é«˜çŸ¥','ç¦å²¡':'ç¦å²¡','ä½è³€':'ä½è³€','é•·å´':'é•·å´','ç†Šæœ¬':'ç†Šæœ¬','å¤§åˆ†':'å¤§åˆ†','å®®å´':'å®®å´','æ²–ç¸„':'æ²–ç¸„'
};
const normRegion = (r)=> REGION_MAP[r] || r || '';

/* ========== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º ========== */
function setStatus(el, ok, msg){
  const mark = el.querySelector('.mark');
  mark.textContent = ok ? 'âœ…' : `âœ–${msg?`(${msg})`:''}`;
  el.classList.toggle('ok', !!ok);
  el.classList.toggle('ng', !ok);
}

/* ========== å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ï¼ˆé¸æ‰‹DBãƒ»å½“æ—¥ãƒ¬ãƒ¼ã‚¹ï¼‰ ========== */
const RIDERS_URL = 'https://keirinjingle.github.io/keirin-links/senshuID.json';
const RACES_URL  = (ymd) => `https://keirinjingle.github.io/keirin-links/data/keirin_race_list_${ymd}.json`;

let RIDERS = [];   // {id,name,region,ki,grade,profile}
let DAYCARDS = []; // [{date, venue, jo_code, races:[{race_number, start_time, closed_at, class_category, race_url, result_url?, players:[{no,name,region,term}]}]}]

/* ========== localStorage å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯ ========== */
(function storageHealthCheck(){
  try{
    const k = KEY_ENTRIES + ':healthcheck';
    localStorage.setItem(k, '1');
    localStorage.removeItem(k);
    STORAGE_OK = true;
  }catch(e){
    console.warn('localStorage ãŒä½¿ãˆã¾ã›ã‚“ï¼ˆãƒ¡ãƒ¢ãƒªã®ã¿ã§ç¶™ç¶šï¼‰:', e);
    STORAGE_OK = false;
  }
})();

/* ========== æ°¸ç¶š I/Oï¼ˆå …ç‰¢ç‰ˆï¼‰ ========== */
const loadEntries = () => {
  if (MEM_ENTRIES) return MEM_ENTRIES;
  try {
    if (!STORAGE_OK) { MEM_ENTRIES = []; return MEM_ENTRIES; }
    const raw = localStorage.getItem(KEY_ENTRIES);
    if (!raw) { MEM_ENTRIES = []; return MEM_ENTRIES; }
    const parsed = JSON.parse(raw);
    MEM_ENTRIES = Array.isArray(parsed) ? parsed : [];
    return MEM_ENTRIES;
  } catch (e) {
    console.warn('ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒå£Šã‚Œã¦ã„ã‚‹ãŸã‚åˆæœŸåŒ–ã—ã¾ã™ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ :corrupt ã«é€€é¿ï¼‰ã€‚', e);
    try { if (STORAGE_OK) localStorage.setItem(KEY_ENTRIES + ':corrupt', localStorage.getItem(KEY_ENTRIES) || ''); } catch {}
    MEM_ENTRIES = [];
    if (STORAGE_OK) localStorage.setItem(KEY_ENTRIES, '[]');
    return MEM_ENTRIES;
  }
};

const saveEntries = (arr) => {
  MEM_ENTRIES = Array.isArray(arr) ? arr : [];
  if (!STORAGE_OK) return false;
  try{
    localStorage.setItem(KEY_ENTRIES, JSON.stringify(MEM_ENTRIES));
    return true;
  }catch(e){
    console.warn('localStorage ä¿å­˜ã«å¤±æ•—ï¼ˆãƒ¡ãƒ¢ãƒªã®ã¿ï¼‰:', e);
    return false;
  }
};

/* ========== é¸æ‰‹ãƒ»ãƒ¬ãƒ¼ã‚¹å–å¾— ========== */
function extractKi(kiText){ const m=(kiText||'').match(/(\d+)æœŸ/); return m ? `${m[1]}æœŸ` : (kiText||''); }

async function fetchRiders(){
  try{
    const res = await fetch(RIDERS_URL, { cache:'no-cache' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const raw = await res.text();
    let arr; try{ arr = JSON.parse(raw); } catch{ throw new Error('JSON parse error'); }
    RIDERS = arr.map(r=>({
      id: String(r['ç™»éŒ²ç•ªå·']||'').trim(),
      name: r['é¸æ‰‹å'],
      ki: extractKi(r['æœŸ']),
      region: r['åœ°åŸŸ']||'',
      grade: r['ç´š']||'',
      profile: (r['ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«URL']||'').replace('https://keirin.netkeiba.comhttps://','https://')
    }));
    setStatus(riderStatus, true);
  }catch(e){
    console.warn('é¸æ‰‹DBå–å¾—å¤±æ•—:', e);
    RIDERS = [];
    setStatus(riderStatus, false, e.message||'fetch error');
  }
}

async function fetchRaces(){
  try{
    const url = RACES_URL(ymdJST());
    const res = await fetch(url, { cache:'no-cache' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const raw = await res.text();
    let data; try{ data = JSON.parse(raw); } catch{ throw new Error('JSON parse error'); }
    DAYCARDS = Array.isArray(data) ? data : [];
    setStatus(raceStatus, true);
  }catch(e){
    console.warn('å½“æ—¥ãƒ¬ãƒ¼ã‚¹å–å¾—å¤±æ•—:', e);
    DAYCARDS = [];
    setStatus(raceStatus, false, e.message||'fetch error');
  }
}

/* ========== ã‚µã‚¸ã‚§ã‚¹ãƒˆï¼ˆæˆ¦æ³•ãƒ»é¸æ‰‹ãƒ»ãƒ¬ãƒ¼ã‚¹ãƒ»ã‚¿ã‚°ï¼‰ ========== */
const TACTICS = ['ä¸‰åˆ†æˆ¦','äºŒåˆ†æˆ¦','å˜é¨','å…ˆè¡Œä¸€è»Š','ã¾ãã‚Š','å·®ã—','ã‚«ãƒã‚·','è‡ªåœ¨'];

function getSlashToken(text, caret){
  const m = text.slice(0, caret).match(/(^|\s)\/(\S*)$/);
  if (!m) return null;
  return { token:m[2], start:caret - m[2].length - 1, end: caret };
}
function norm(s){ return (s||'').toLowerCase(); }

/* ãƒ¬ãƒ¼ã‚¹å„ªå…ˆã®å€™è£œ */
function findCandidates(q){
  const n = norm(q||'');
  const wantFallback = !q || !q.trim();
  const hasDigit = /[0-9ï¼-ï¼™]/.test(q||'');

  const raceItems=[];
  if (DAYCARDS.length && (wantFallback || hasDigit || (q && DAYCARDS.some(v=> norm(v.venue).includes(n) || n.includes(norm(v.venue)))))){
    const lower = n;
    outer: for (const v of DAYCARDS){
      const matchVenue = !q || norm(v.venue).includes(lower) || lower.includes(norm(v.venue));
      if (!matchVenue && !hasDigit) continue;
      for (const rr of v.races||[]){
        let pass=true;
        if (hasDigit){
          const m = lower.match(/(\d{1,2})$/);
          if (m){ const no=parseInt(m[1],10); pass = (rr.race_number===no); }
        }
        if (pass){
          raceItems.push({ type:'race', v, r: rr });
          if (raceItems.length>=MAX_RACE_ITEMS) break outer;
        }
      }
    }
  }

  const tacticItems = (q ? TACTICS.filter(t=>norm(t).includes(n)) : TACTICS).map(t=>({type:'tactic', t}));

  let riderItems=[];
  if (RIDERS.length && q){
    riderItems = RIDERS
      .filter(r => (`${r.name} ${r.region} ${r.ki}`).toLowerCase().includes(n))
      .slice(0, 6)
      .map(r => ({ type:'riderDb', r }));
  } else if (q){
    riderItems = [{type:'rider', name:q}];
  }

  const tagItems = q ? [{type:'tag', tag:q}] : [];
  const combined = [...raceItems, ...tacticItems, ...riderItems, ...tagItems];
  return combined.slice(0, Math.max(MAX_TOTAL_ITEMS, raceItems.length));
}

function renderDropdown(items){
  if (!items.length){ dropdown.style.display='none'; ddSel=-1; return; }
  dropdown.innerHTML = items.map((it,i)=>{
    if (it.type==='race'){ return `<div class="item" data-i="${i}"><span class="type">ãƒ¬ãƒ¼ã‚¹</span> - ${it.v.venue}${it.r.race_number}R</div>`; }
    if (it.type==='tactic') return `<div class="item" data-i="${i}"><span class="type">æˆ¦æ³•</span> #${it.t}</div>`;
    if (it.type==='riderDb'){
      const r=it.r; const right = r.region ? `${r.region}ï¼${r.ki}` : r.ki;
      return `<div class="item" data-i="${i}"><span class="type">é¸æ‰‹</span> @${r.name}ï¼ˆ${right}ï¼‰</div>`;
    }
    if (it.type==='rider')  return `<div class="item" data-i="${i}"><span class="type">é¸æ‰‹</span> @${it.name}</div>`;
    return `<div class="item" data-i="${i}"><span class="type">ã‚¿ã‚°</span> +${it.tag}</div>`;
  }).join('');
  dropdown.style.display='block';
  ddSel=0; highlightSelection();
  dropdown.scrollTop=0;
}

function updateDropdown(){
  // ã„ã¾ã®ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã¾ã§ã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ã€Œ/ãƒˆãƒ¼ã‚¯ãƒ³ã€ã‚’æ‹¾ã†
  const tok = getSlashToken(ta.value, lastCaret);
  if (!tok) {
    // ã€Œ/ã€ã®ç›´å¾Œã§ãªã‘ã‚Œã°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
    dropdown.style.display = 'none';
    ddSel = -1;
    return;
  }
  // ã€Œ/ã€ã®å¾Œã‚ã®æ–‡å­—åˆ—ã§å€™è£œã‚’ä½œã‚‹ï¼ˆç©ºã§ã‚‚OKï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€™è£œã‚’å‡ºã™ï¼‰
  const q = tok.token || '';
  curItems = findCandidates(q);
  renderDropdown(curItems);
}

/* ========== ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ“ä½œï¼ˆIMEå®‰å…¨ãƒ»å›ºå®šé…ç½®ï¼‰ ========== */
function highlightSelection(){
  const nodes=dropdown.querySelectorAll('.item');
  nodes.forEach((n,i)=>n.classList.toggle('is-active', i===ddSel));
  const active=nodes[ddSel];
  if(active){
    const r=active.getBoundingClientRect(), pr=dropdown.getBoundingClientRect();
    if(r.top<pr.top || r.bottom>pr.bottom) active.scrollIntoView({block:'nearest'});
  }
}
function moveSelection(delta){
  const n=dropdown.querySelectorAll('.item').length; if(!n) return;
  if(ddSel<0) ddSel=0; ddSel=(ddSel+delta+n)%n; highlightSelection();
}
function commitDropdown(idx){
  const tok=getSlashToken(ta.value, lastCaret);
  if(!tok){ dropdown.style.display='none'; ddSel=-1; return; }
  const it=curItems[idx];
  if(!it){ dropdown.style.display='none'; ddSel=-1; return; }

  let insert='';
  if(it.type==='tactic') insert = '#'+it.t;
  else if(it.type==='riderDb') insert = '@'+it.r.name;
  else if(it.type==='race') insert = `- ${it.v.venue}${it.r.race_number}R`;
  else if(it.type==='rider') insert = '@'+it.name;
  else insert = '+'+it.tag;

  const before=ta.value.slice(0,tok.start);
  const after=ta.value.slice(tok.end);

  const needsLeadingSpace = before && !/\s$/.test(before);
  const needsTrailingSpace = after && !/^\s/.test(after);

  const piece = (needsLeadingSpace?' ':'') + insert + (needsTrailingSpace?' ':'');
  ta.value = before + piece + after;

  const newPos = (before + piece).length;
  ta.setSelectionRange(newPos,newPos);
  lastCaret=newPos;

  dropdown.style.display='none'; ddSel=-1;
  ta.focus();
}

/* ========== å…¥åŠ›ãƒãƒ³ãƒ‰ãƒ©ï¼ˆIMEå®Œå…¨ã‚¬ãƒ¼ãƒ‰ï¼‰ ========== */
ta.addEventListener('compositionstart', ()=>{ composing=true; });
ta.addEventListener('compositionend', ()=>{
  composing=false;
  lastCaret=ta.selectionStart;
  updateDropdown();
  imeJustEnded=true;
  setTimeout(()=> imeJustEnded=false, IME_SUPPRESS_MS);
});
ta.addEventListener('input', ()=>{ lastCaret=ta.selectionStart; updateDropdown(); });
ta.addEventListener('keyup', (e)=>{ lastCaret=ta.selectionStart; if(e.key==='/' && !composing) updateDropdown(); });
ta.addEventListener('click', ()=>{ lastCaret=ta.selectionStart; });
document.addEventListener('selectionchange', ()=>{ if(document.activeElement===ta){ lastCaret=ta.selectionStart; }});

ta.addEventListener('keydown', (e)=>{
  if (e.isComposing) return;
  lastCaret = ta.selectionStart;
  if (dropdown.style.display!=='block') return;
  const tok = getSlashToken(ta.value, lastCaret);
  if (!tok) return;

  if(e.key==='ArrowDown'){ e.preventDefault(); moveSelection(1); }
  else if(e.key==='ArrowUp'){ e.preventDefault(); moveSelection(-1); }
  else if(e.key==='Enter' || e.key==='Tab'){
    if (imeJustEnded) return;
    e.preventDefault();
    if (ddSel>=0) commitDropdown(ddSel);
  }else if(e.key==='Escape'){ e.preventDefault(); dropdown.style.display='none'; ddSel=-1; }
});

/* ãƒ¢ãƒã‚¤ãƒ«ï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ã‚¿ãƒƒãƒ—ã®èª¤ç¢ºå®šæŠ‘æ­¢ */
let tapState=null; const TAP_MOVE_TOL=6;
dropdown.addEventListener('pointerdown', (e)=>{
  const node=e.target.closest('.item'); if(!node){ tapState=null; return; }
  tapState={ idx:parseInt(node.dataset.i,10), x:e.clientX, y:e.clientY, dragged:false };
});
dropdown.addEventListener('pointermove', (e)=>{
  if(!tapState) return;
  if(Math.abs(e.clientX-tapState.x)>TAP_MOVE_TOL || Math.abs(e.clientY-tapState.y)>TAP_MOVE_TOL) tapState.dragged=true;
});
dropdown.addEventListener('scroll', ()=>{ if(tapState) tapState.dragged=true; });
dropdown.addEventListener('pointerup', (e)=>{
  if(!tapState) return;
  const node=e.target.closest('.item'); const idx=node?parseInt(node.dataset.i,10):tapState.idx;
  const dragged=tapState.dragged; tapState=null;
  if(!dragged){ e.preventDefault(); e.stopPropagation(); commitDropdown(idx); }
});
dropdown.addEventListener('pointercancel', ()=>{ tapState=null; });

/* ã‚¹ãƒ©ãƒƒã‚·ãƒ¥æŒ¿å…¥ */
document.getElementById('inlineSlash').addEventListener('click', (ev)=>{
  ev.stopPropagation();
  ta.focus(); const st=ta.selectionStart; ta.setRangeText('/', st, st, 'end');
  lastCaret=ta.selectionStart; updateDropdown();
});

/* ========== CRUDï¼ˆãƒ¡ãƒ¢ãƒªâ†’UIâ†’ä¿å­˜ï¼‰ ========== */
function addEntry(raw, entities=null){
  const nowIso = new Date().toISOString();
  const entry = {
    id: Date.now().toString(36)+Math.random().toString(16).slice(2),
    created_at: nowIso,
    updated_at: nowIso,
    raw
  };

  // æ—¢å­˜entitiesã‚’ãƒãƒ¼ã‚¸
  if (entities && typeof entities==='object') entry.entities = entities;

  // 1) ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ãƒ¬ãƒ¼ã‚¹æ¨å®šï¼ˆå½“æ—¥ã‚«ãƒ¼ãƒ‰ã«ã‚ã‚‹å ´åˆï¼‰
  const raceGuess = parseRaceFromRaw(raw);
  // 2) ãƒ†ã‚­ã‚¹ãƒˆå†…ã«URLãŒã‚ã‚Œã°ãã‚Œã‚‚å€™è£œ
  const urlInText = firstUrlInText(raw);

  // entities.race ã‚’ç”¨æ„
  entry.entities = entry.entities || {};
  entry.entities.race = entry.entities.race || {};

  // 3) åˆå›ä¿å­˜æ™‚ã« entry_url/result_url ã‚’â€œå›ºå®šâ€
  if (!entry.entities.race.entry_url && (raceGuess?.entry || urlInText)){
    entry.entities.race.entry_url   = raceGuess?.entry || urlInText || null;
    entry.entities.race.result_url  = raceGuess?.result || null;
    entry.entities.race.venue       = raceGuess?.venue || entry.entities.race.venue || null;
    entry.entities.race.race_number = raceGuess?.raceNo || entry.entities.race.race_number || null;
    entry.entities.race.date        = (raceGuess?.date||'').replace(/-/g,'') || entry.entities.race.date || ymdJST();
  }

  const arr = loadEntries().slice();
  arr.push(entry);

  // âœ… æ–°è¦è¿½åŠ å¾Œã¯1ãƒšãƒ¼ã‚¸ç›®ã¸
  currentPage = 1;

  const ok = saveEntries(arr);
  renderList(arr);
  scheduleDriveSave();
  if (!ok) alert('æ³¨æ„ï¼šã“ã®ç’°å¢ƒã§ã¯ä¿å­˜ãŒåˆ¶é™ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ç­‰ï¼‰ã€‚');
}


function updateEntry(id, newRaw){
  const arr = loadEntries().slice();
  const i = arr.findIndex(e=>e.id===id); if(i<0) return;

  const prev = arr[i];
  const nowIso = new Date().toISOString();
  const updated = { ...prev, raw:newRaw, updated_at: nowIso };

  // æ—¢å­˜ã® race.entry_url ãŒç„¡ã„å ´åˆã®ã¿å†æ¨å®šï¼ˆâ€œä¸€åº¦ä»˜ä¸ã—ãŸã‚‰å›ºå®šâ€ã®ãƒãƒªã‚·ãƒ¼ï¼‰
  const hasFixedUrl = !!(prev.entities?.race?.entry_url);
  if (!hasFixedUrl){
    const raceGuess = parseRaceFromRaw(newRaw);
    const urlInText = firstUrlInText(newRaw);

    updated.entities = updated.entities || {};
    updated.entities.race = updated.entities.race || {};

    if (raceGuess?.entry || urlInText){
      updated.entities.race.entry_url  = raceGuess?.entry || urlInText || null;
      updated.entities.race.result_url = raceGuess?.result || null;
      updated.entities.race.venue      = raceGuess?.venue || updated.entities.race.venue || null;
      updated.entities.race.race_number= raceGuess?.raceNo || updated.entities.race.race_number || null;
      updated.entities.race.date       = (raceGuess?.date||'').replace(/-/g,'') || updated.entities.race.date || ymdJST();
    }
  }

  arr[i] = updated;
  const ok = saveEntries(arr);
  renderList(arr);
  scheduleDriveSave();
  if (!ok) alert('æ³¨æ„ï¼šã“ã®ç’°å¢ƒã§ã¯ä¿å­˜ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚');
}

function deleteEntry(id){
  const arr = loadEntries().filter(e=>e.id!==id);
  const ok = saveEntries(arr);
  renderList(arr);
  scheduleDriveSave();
  if (!ok) alert('æ³¨æ„ï¼šã“ã®ç’°å¢ƒã§ã¯ä¿å­˜ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚');
}

document.getElementById('addBtn').addEventListener('click', (ev)=>{
  ev.stopPropagation();
  const raw=ta.value.trim(); if(!raw){ alert('ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™'); return; }
  addEntry(raw);
  ta.value=''; dropdown.style.display='none';
});

/* ========== å‡ºèµ°è¡¨ãƒ»çµæœãƒªãƒ³ã‚¯ã®è‡ªå‹•å·®ã—è¾¼ã¿ï¼ˆã‚«ãƒ¼ãƒ‰å´ï¼‰ ========== */
function parseRaceFromRaw(raw){
  const m = (raw||'').match(/-\s*([\u3040-\u30ff\u4e00-\u9fafA-Za-z]+)(\d{1,2})R/);
  if(!m) return null;
  const venue = m[1]; const raceNo = parseInt(m[2],10);
  const v = (DAYCARDS||[]).find(x=>x.venue===venue);
  if(!v) return { venue, raceNo, entry:null, result:null, date: ymd_dash() };
  const rr = (v.races||[]).find(x=>x.race_number===raceNo);
  if(!rr) return { venue, raceNo, entry:null, result:null, date: ymd_dash() };
  const entry = rr.race_url || rr.url || null; // ã‚ªãƒƒã‚ºãƒ‘ãƒ¼ã‚¯
  const result = rr.result_url || (entry && entry.includes('/entry/') ? entry.replace('/entry/','/result/') : null);
  return { venue, raceNo, entry, result, date: (v.date? `${v.date.slice(0,4)}-${v.date.slice(4,6)}-${v.date.slice(6)}` : ymd_dash()) };
}
/* ========== ãƒ†ã‚­ã‚¹ãƒˆå†…ã®URLæŠ½å‡ºï¼ˆå…ˆé ­ã®1ä»¶ï¼‰ ========== */
function firstUrlInText(raw){
  const m = (raw||'').match(/https?:\/\/[^\s<>"']+/);
  return m ? m[0] : null;
}

/* ========== è¡¨ç¤ºï¼ˆä¸€è¦§ï¼‰ ========== */
function linkifyRaw(html){
  // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã¯å‘¼ã³å‡ºã—å´ã§æ¸ˆã‚“ã§ã„ã‚‹å‰æï¼ˆrenderListã§ < ã‚’ &lt; æ¸ˆã¿ï¼‰
  html = html.replace(/(https?:\/\/[^\s<]+)/g, (m)=>`<a href="${m}" target="_blank" rel="noopener">${m}</a>`);
  html = html.replace(/@([^\s@#\+ï¼ˆï¼‰()]+)/g,(m,n)=>`<a href="#" class="riderLink" data-q="@${n}">@${n}</a>`);
  html = html.replace(/\+("[^"]+"|[\w\u3040-\u30ff\u4e00-\u9faf]+)/g,(m)=>`<a href="#" class="tagLink" data-q="${m}">${m}</a>`);
  return html;
}

function renderList(listOverride){
  const el = document.getElementById('cards');
  const src = (listOverride ?? loadEntries());

  // --- äº‹å‰ãƒ‘ã‚¹ï¼šå›ºå®šURLã®ä»˜ä¸ï¼ˆå…¨ä»¶å¯¾è±¡ï¼‰ ---
  let upgraded = false;
  for (const e of src){
    const hasFixed = !!(e.entities?.race?.entry_url);
    if (hasFixed) continue;
    const race = parseRaceFromRaw(e.raw||'');
    if (race && race.entry){
      e.entities = e.entities || {};
      e.entities.race = e.entities.race || {};
      e.entities.race.entry_url   = race.entry || null;
      e.entities.race.result_url  = race.result || null;
      e.entities.race.venue       = race.venue || null;
      e.entities.race.race_number = race.raceNo || null;
      e.entities.race.date        = (race.date||'').replace(/-/g,'') || ymdJST();
      upgraded = true;
    }
  }
  if (upgraded){ saveEntries(src); scheduleDriveSave(); }

  // --- ä¸¦ã³æ›¿ãˆï¼ˆæ–°ã—ã„é †ï¼‰ ---
  const all = src.slice().reverse();

  // --- ãƒšãƒ¼ã‚¸è¨ˆç®— ---
  const totalItems = all.length;
  const size = Math.max(1, pageSize|0);
  const totalPages = Math.max(1, Math.ceil(totalItems / size));
  if (currentPage > totalPages) currentPage = totalPages;
  const start = (currentPage - 1) * size;
  const pageItems = all.slice(start, start + size);

  // --- ãƒšãƒ¼ã‚¸ã®ã‚«ãƒ¼ãƒ‰ã‚’çµ„ã¿ç«‹ã¦ ---
  const html = pageItems.map(e=>{
    const created = e.created_at || e.at || null;
    const updated = e.updated_at || null;

    const fixedEntryUrl  = e.entities?.race?.entry_url  || e.race?.entry_url  || null;
    const fixedResultUrl = e.entities?.race?.result_url || e.race?.result_url || null;

    let raceLabel = (e.entities?.race?.venue && e.entities?.race?.race_number)
      ? `${e.entities.race.venue}${e.entities.race.race_number}R`
      : null;

    // â€œä¿é™ºâ€ã®å‹•çš„æ¨å®šï¼ˆè¡¨ç¤ºæ™‚ã®ã¿ï¼‰
    let entryUrl  = fixedEntryUrl;
    let resultUrl = fixedResultUrl;
    if (!entryUrl || !raceLabel){
      const race = parseRaceFromRaw(e.raw||'');
      if (race){
        raceLabel = raceLabel || `${race.venue}${race.raceNo}R`;
        entryUrl  = entryUrl  || race.entry || null;
        resultUrl = resultUrl || race.result || null;
      }
    }

    const createdText  = created ? fmtJst(created) : ymd_dash();
    const editedSuffix = (updated && updated !== created) ? `ï¼ˆç·¨é›† ${fmtJst(updated)}ï¼‰` : '';
    const headText     = `${createdText}${editedSuffix}`;

    const raceLine = (raceLabel || entryUrl || resultUrl) ? `
      <div class="small" style="margin:.15rem 0 .35rem; display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
        ${raceLabel ? `<strong>${raceLabel}</strong>` : ''}
        ${entryUrl ? `<a href="${entryUrl}" target="_blank" rel="noopener">[å‡ºèµ°è¡¨]</a>` : ''}
        ${resultUrl? `<a href="${resultUrl}" target="_blank" rel="noopener">[çµæœ]</a>` : ''}
      </div>
    ` : '';

    let bodyText = (e.raw || '');
    if (raceLabel){
      const pattern = new RegExp(`^\\s*-\\s*${raceLabel}\\s*\\n?`);
      bodyText = bodyText.replace(pattern, '');
    }
    const rawHtml = linkifyRaw(bodyText.replace(/</g,'&lt;'));

    const actions = `<div style="margin-left:auto;display:flex;gap:.6rem">
        <a class="linklike editBtn" href="#/edit/${e.id}" data-id="${e.id}">ç·¨é›†</a>
        <button class="linklike delBtn" data-id="${e.id}">å‰Šé™¤</button>
      </div>`;

    return `<div class="card" id="card_${e.id}">
      <div class="head">
        <span class="date">${headText}</span>
        ${actions}
      </div>
      ${raceLine}
      <div class="raw">${rawHtml}</div>
    </div>`;
  }).join('') || '<div class="card" style="color:#9ca3af">ï¼ˆã¾ã ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰</div>';

  el.innerHTML = html;

  // --- ãƒšãƒ¼ã‚¸ãƒ£æç”» ---
  renderPager(totalItems, totalPages);
}



/* ç·¨é›†ãƒ»å‰Šé™¤ãƒ»ãƒªãƒ³ã‚¯ã§æ¤œç´¢ */
document.body.addEventListener('click', (e)=>{
  const editBtn=e.target.closest('a.editBtn'); const delBtn=e.target.closest('.delBtn');
  const r=e.target.closest('a.riderLink'); const t=e.target.closest('a.tagLink');

  if(editBtn){
  e.preventDefault(); e.stopPropagation();
  const id = editBtn.dataset.id || ((editBtn.getAttribute('href')||'').split('#/edit/')[1]||'');
  if(id) location.hash = '#/edit/'+id;  // â†’ handleRoute() ãŒ enterEdit() ã‚’å‘¼ã¶
     return;
}
  if(delBtn){
    const id=delBtn.dataset.id; if(confirm('ã“ã®ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) deleteEntry(id); return;
  }
  if(r){ e.preventDefault(); openSearch(''); switchToTab('full'); searchInput.value=r.dataset.q; runSearch(); }
  if(t){ e.preventDefault(); openSearch(''); switchToTab('full'); searchInput.value=t.dataset.q; runSearch(); }
});

/* ========== å…¨æ–‡æ¤œç´¢ ========== */
const searchDlg=document.getElementById('searchDlg');
const searchInput=document.getElementById('searchInput');
document.getElementById('openSearch').addEventListener('click', ()=>{ openSearch(''); });
document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); openSearch(''); }});

function openSearch(prefill){
  searchInput.value=prefill||'';
  document.getElementById('searchList').innerHTML='';
  document.getElementById('searchCount').textContent='';
  switchToTab('race'); // â† åˆæœŸè¡¨ç¤ºã¯ãƒ¬ãƒ¼ã‚¹å†…æ¤œç´¢
  searchDlg.showModal();
  focusRaceSearch();
  renderRaceSuggest();   // âœ… ã“ã‚Œã‚’è¿½åŠ 
}
document.getElementById('searchClose').addEventListener('click', ()=> searchDlg.close());
let searchTimer=null;
searchInput.addEventListener('input', ()=>{ clearTimeout(searchTimer); searchTimer=setTimeout(runSearch,200); });

function makeHiliter(words){
  const sorted=[...words].sort((a,b)=>b.length-a.length);
  const res=sorted.map(w=>w.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'));
  if(!res.length) return s=>s; const re=new RegExp('('+res.join('|')+')','gi');
  return s=>s.replace(re,'<span class="hl">$1</span>');
}
function snippet(raw, query){
  if(!query.length) return raw.slice(0,120);
  const q=query[0]; const idx=raw.toLowerCase().indexOf(q.toLowerCase());
  const i=idx>=0?idx:0; const start=Math.max(0,i-40), end=Math.min(raw.length,i+80);
  return (start>0?'â€¦':'')+raw.slice(start,end)+(end<raw.length?'â€¦':'');
}
function runSearch(){
  const q=(searchInput.value||'').trim();
  const all=loadEntries();
  const hits = q ? all.filter(e => (e.raw||'').includes(q)) : all.slice();

  // ä¸¦ã³æ›¿ãˆï¼šæ›´æ–°æ—¥æ™‚ â†’ ä½œæˆæ—¥æ™‚ â†’ æ—§at
  hits.sort((a,b)=> ((b.updated_at||b.created_at||b.at||'').localeCompare(a.updated_at||a.created_at||a.at||'')));

  const words = q ? [q] : [];
  const hi = makeHiliter(words);

  const html=hits.slice(0,200).map(e=>{
    const race=parseRaceFromRaw(e.raw||'');
    const ts = e.updated_at || e.created_at || e.at || '';
    const headLeft=race?`${race.date} ${race.venue}${race.raceNo}R`:(ts?fmtJst(ts):ymd_dash());
    const snip=snippet(e.raw, words).replace(/</g,'&lt;');
    return `<div class="card result-item">
      <div class="head"><span class="date">${headLeft}</span>
        <button class="linklike openCardBtn" data-id="${e.id}">è¡¨ç¤º</button></div>
      <div class="raw">${hi(snip)}</div>
    </div>`;
  }).join('') || '<div class="card" style="color:#9ca3af">ï¼ˆè©²å½“ãªã—ï¼‰</div>';

  document.getElementById('searchList').innerHTML=html;
  document.getElementById('searchCount').textContent=`${hits.length} ä»¶`;

  // â–¼ ã‚¯ãƒªãƒƒã‚¯ã§è©²å½“ãƒšãƒ¼ã‚¸ã¸è‡ªå‹•ã‚¸ãƒ£ãƒ³ãƒ—
  document.getElementById('searchList').onclick = (e)=>{
    const btn=e.target.closest('.openCardBtn'); if(!btn) return;
    const id=btn.dataset.id; searchDlg.close();

    // é€†é †ãƒªã‚¹ãƒˆã§ä½ç½®ã‚’ç‰¹å®šã—ã¦ãƒšãƒ¼ã‚¸ã‚’æ±ºå®š
    const all = loadEntries().slice().reverse();
    const idx = all.findIndex(x=>x.id===id);
    if (idx >= 0){
      currentPage = Math.floor(idx / Math.max(1, pageSize|0)) + 1;
    }
    renderList();

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    setTimeout(()=>{
      const node=document.getElementById('card_'+id);
      if(node){ node.scrollIntoView({behavior:'smooth', block:'center'}); }
    }, 0);
  };
}



/* ========== ãƒ¬ãƒ¼ã‚¹å†…æ¤œç´¢ ========== */
const tabFull=document.getElementById('tabFull');
const tabRace=document.getElementById('tabRace');
const panelFull=document.getElementById('panelFull');
const panelRace=document.getElementById('panelRace');

function switchToTab(which){
  if(which==='full'){
    tabFull.classList.add('is-active'); tabRace.classList.remove('is-active');
    panelFull.classList.add('is-active'); panelRace.classList.remove('is-active');
  }else{
    tabRace.classList.add('is-active'); tabFull.classList.remove('is-active');
    panelRace.classList.add('is-active'); panelFull.classList.remove('is-active');
  }
}
tabFull.addEventListener('click', ()=>switchToTab('full'));
tabRace.addEventListener('click', ()=>{ switchToTab('race'); focusRaceSearch(); renderRaceSuggest(); });

const raceSearchInput=document.getElementById('raceSearchInput');
const raceSuggest=document.getElementById('raceSuggest');
const raceSearchClear=document.getElementById('raceSearchClear');
const raceView=document.getElementById('raceView');
const raceHead=document.getElementById('raceHead');
const raceEntryLink=document.getElementById('raceEntryLink');
const raceResultLink=document.getElementById('raceResultLink');
const playerList=document.getElementById('playerList');
const playerNotesWrap=document.getElementById('playerNotesWrap');
const playerNotesHead=document.getElementById('playerNotesHead');
const playerNotes=document.getElementById('playerNotes');
const newMemoWrap=document.getElementById('newMemoWrap');
const newMemoTa=document.getElementById('newMemoTa');
const saveMemoBtn=document.getElementById('saveMemoBtn');
const cancelMemoBtn=document.getElementById('cancelMemoBtn');

function focusRaceSearch(){ setTimeout(()=>raceSearchInput.focus(), 0); }

/* å€™è£œä½œæˆ */
function buildRaceOptions(){
  const opts=[];
  for(const v of DAYCARDS){
    for(const r of (v.races||[])){
      opts.push({
        label:`${v.venue}${r.race_number}R`,
        venue:v.venue, race_number:r.race_number,
        date:v.date, jo_code:v.jo_code||'',
        race_url:r.race_url||r.url||'',
        result_url:r.result_url||null,
        start_time:r.start_time||'', closed_at:r.closed_at||'',
        class_category:r.class_category||'',
        players:r.players||[]
      });
    }
  }
  return opts;
}

/* ãƒ¬ãƒ¼ã‚¹å€™è£œè¡¨ç¤º */
function renderRaceSuggest(){
  const q=normStr(raceSearchInput.value||'');
  const opts=buildRaceOptions();
  const filtered = q
    ? opts.filter(o=> normStr(o.label).includes(q) || normStr(o.venue).includes(q) )
    : opts;
  const top = filtered.slice(0, 100);
  raceSuggest.innerHTML = top.map((o,i)=>`
    <div class="row" data-i="${i}">
      <strong>${o.label}</strong>
      <span class="muted small">ï¼ˆ${o.date? `${o.date.slice(0,4)}-${o.date.slice(4,6)}-${o.date.slice(6)}`:'â€”'}ï¼‰</span>
      ${o.class_category? `<span class="pill">${o.class_category}</span>`:''}
    </div>
  `).join('') || '<div class="muted small" style="padding:.5rem">ï¼ˆå½“æ—¥ã®ãƒ¬ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼‰</div>';
  raceSuggest.dataset.rows = JSON.stringify(top);
}

raceSearchInput.addEventListener('input', ()=>renderRaceSuggest());
raceSearchClear.addEventListener('click', ()=>{ raceSearchInput.value=''; renderRaceSuggest(); });

raceSuggest.addEventListener('click', (e)=>{
  const row=e.target.closest('.row'); if(!row) return;
  const arr=JSON.parse(raceSuggest.dataset.rows||'[]');
  const o=arr[parseInt(row.dataset.i,10)];
  if(!o) return;
  showRace(o);
});

/* ãƒ¬ãƒ¼ã‚¹è¡¨ç¤ºï¼ˆå‡ºèµ°è¡¨ï¼‹é¸æ‰‹ãƒªã‚¹ãƒˆï¼‰ */
let currentRace=null, currentPlayer=null;

function raceUid(o){
  return `${o.date||ymdJST()}-${o.jo_code||'jo'}-${pad2(o.race_number)}`;
}
function showRace(o){
  currentRace = o; currentPlayer = null;
  raceView.style.display='block';
  const dateStr = o.date? `${o.date.slice(0,4)}-${o.date.slice(4,6)}-${o.date.slice(6)}` : ymd_dash();
  raceHead.textContent = `${dateStr} ${o.venue}${o.race_number}R`;
  raceEntryLink.href = o.race_url || '#';
  raceEntryLink.style.display = o.race_url ? 'inline-flex' : 'none';
  // å°†æ¥ã®çµæœURLï¼ˆä»Šã¯ç„¡ã‘ã‚Œã°éè¡¨ç¤ºï¼‰
  if (o.result_url){ raceResultLink.href = o.result_url; raceResultLink.style.display='inline-flex'; }
  else{ raceResultLink.style.display='none'; }

  // é¸æ‰‹ãƒªã‚¹ãƒˆ
  const players = o.players||[];
  playerList.innerHTML = players.map((p,idx)=>{
    const region = normRegion(p.region||'');
    const term = p.term? `${p.term}æœŸ` : '';
    return `<div class="player-item" data-i="${idx}">
      <div><strong>@${(p.name||'').trim()}</strong> <span class="muted small">${region} ${term}</span></div>
    </div>`;
  }).join('') || '<div class="muted small">ï¼ˆå‡ºèµ°è¡¨ã«é¸æ‰‹æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰</div>';

  playerList.onclick = (e)=>{
    const it=e.target.closest('.player-item'); if(!it) return;
    const idx=parseInt(it.dataset.i,10);
    const p=(o.players||[])[idx]; if(!p) return;
    selectPlayer(o, p);
  };

  // ä¸‹ã®ãƒ–ãƒ­ãƒƒã‚¯åˆæœŸåŒ–
  playerNotesWrap.style.display='none';
  newMemoWrap.style.display='none';

  // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  raceView.scrollIntoView({behavior:'smooth', block:'start'});
}

function selectPlayer(o, p){
  currentPlayer = p;
  const name=(p.name||'').trim();
  playerNotesHead.textContent = `@${name} ã®éå»ãƒ¡ãƒ¢`;

  // éå»ãƒ¡ãƒ¢æŠ½å‡ºï¼ˆIDä¸€è‡´å„ªå…ˆâ†’åå‰ä¸€è‡´ï¼‰
  const cand = collectNotesForPlayer(p);
  renderPlayerNotes(cand);

  // æ–°è¦ãƒ¡ãƒ¢ãƒ†ãƒ³ãƒ—ãƒ¬
  newMemoTa.value = `- ${o.venue}${o.race_number}R\n@${name}`;
  newMemoWrap.style.display='block';
  playerNotesWrap.style.display='block';

  // ç·¨é›†ä¸­ãªã‚‰ã€ŒæŒ¿å…¥ã€è¡¨ç¤ºã«
    if (editingId) {
    saveMemoBtn.textContent = 'æŒ¿å…¥';
    newMemoTip.textContent = 'ç·¨é›†ä¸­ã®ãƒ†ã‚­ã‚¹ãƒˆã«æŒ¿å…¥ã—ã¾ã™ã€‚ç·¨é›†ç”»é¢ã®ã€Œä¿å­˜ã€ã§ç¢ºå®šã€‚';
    } else {
    saveMemoBtn.textContent = 'ç™»éŒ²';
    newMemoTip.textContent = 'â€» ç™»éŒ²ã™ã‚‹ã¨ä¸€è¦§ã«å³åæ˜ ã•ã‚Œã¾ã™';
    }

  newMemoWrap.scrollIntoView({behavior:'smooth', block:'start'});
}

/* éå»ãƒ¡ãƒ¢æŠ½å‡ºï¼šIDå„ªå…ˆã€ç„¡ã‘ã‚Œã°@åå‰ */
function collectNotesForPlayer(p){
  const all=loadEntries();
  const riderId = guessRiderId(p);
  return all.filter(e=>{
    if (riderId && e.entities?.players && Array.isArray(e.entities.players)){
      if (e.entities.players.some(x=> x.id && String(x.id)===String(riderId))) return true;
    }
    if ((e.raw||'').includes('@'+(p.name||'').trim())) return true;
    return false;
  }).sort((a,b)=>(b.at||'').localeCompare(a.at||''));
}

function renderPlayerNotes(list){
  if(!list.length){
    playerNotes.innerHTML = '<div class="muted small" style="padding:.3rem .2rem">ã“ã®é¸æ‰‹ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  playerNotes.innerHTML = list.slice(0,20).map(e=>{
    const race=parseRaceFromRaw(e.raw||'');
    const ts = e.updated_at || e.created_at || e.at || '';
    const headLeft=race?`${race.date} ${race.venue}${race.raceNo}R`:(ts?fmtJst(ts):ymd_dash());
    const body=(e.raw||'').replace(/</g,'&lt;');
    return `<div class="note">
      <div class="small muted">${headLeft}</div>
      <div class="raw">${body}</div>
    </div>`;
  }).join('');
}

/* ãƒ¡ãƒ¢ç™»éŒ²ï¼ˆentities ä»˜ãï¼‰ */
saveMemoBtn.addEventListener('click', ()=>{
  if(!currentRace || !currentPlayer){ alert('ãƒ¬ãƒ¼ã‚¹ã¨é¸æ‰‹ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const raw=newMemoTa.value.trim(); if(!raw){ alert('ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™'); return; }

    // â–¼ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼š#taï¼ˆç·¨é›†ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã«â€œæŒ¿å…¥â€ã—ã¦çµ‚ã‚ã‚Š
    if (editingId) {
        insertIntoTaAsBlock(raw);  // ä¸‹ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’è¿½åŠ ã—ã¾ã™
        searchDlg.close();
        ta.focus();
        return;
    }

    // â–¼ æ–°è¦ãƒ¢ãƒ¼ãƒ‰ï¼šå¾“æ¥ã©ãŠã‚Šæ–°è¦ç™»éŒ²
    const r=currentRace, p=currentPlayer;
    const uid=raceUid(r);
    const riderId=guessRiderId(p); // ä¸æ˜ãªã‚‰ null ã§OK
    const entities={
    race:{
        uid,
        date: r.date || ymdJST(),
        venue: r.venue,
        jo_code: r.jo_code||'',
        race_number: r.race_number,
        start_at_iso: toJstIso(r.date||ymdJST(), r.start_time||'00:00')
        },
    players:[{ id: riderId||null, name: (p.name||'').trim(), region: normRegion(p.region||''), term: p.term||null }]
    };
    addEntry(raw, entities);



  // ç›´å¾Œã«éå»ãƒ¡ãƒ¢ã‚‚æ›´æ–°
  const cand = collectNotesForPlayer(p);
  renderPlayerNotes(cand);
  newMemoTa.value = `- ${r.venue}${r.race_number}R  @${(p.name||'').trim()}`;

  // ï¼ˆï¼”ï¼‰ç™»éŒ²å¾Œã¯æ¤œç´¢ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã¦TOPã¸
  searchDlg.close();
});

cancelMemoBtn.addEventListener('click', ()=>{
  newMemoWrap.style.display='none';
});

/* ========== ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿ï¼ˆå˜ä¸€ãƒšãƒ¼ã‚¸é·ç§»ï¼‰ ========== */
const homeView = document.getElementById('homeView');
const editView = document.getElementById('editView');
const editMount = document.getElementById('editMount');
const editMeta = document.getElementById('editMeta');
const saveEditBtn = document.getElementById('saveEditBtn');
const cancelEditBtn = document.getElementById('cancelEditBtn');

const taWrap = document.getElementById('taWrap'); // æ—¢å­˜ã®å…¥åŠ›ï¼‹ã‚µã‚¸ã‚§ã‚¹ãƒˆã®è¦ª
const taOriginalParent = taWrap.parentNode;
const taOriginalNext = taWrap.nextSibling;

let editingId = null;

function enterEdit(entry){
  editingId = entry.id;
  // æœ¬æ–‡ã‚»ãƒƒãƒˆ
  ta.value = entry.raw || '';
  // ãƒ¡ã‚¿ï¼ˆJSTï¼‰
  const created = entry.created_at || entry.at || '';
  const updated = entry.updated_at || '';
  editMeta.textContent = `ï¼ˆæŠ•ç¨¿: ${created?fmtJst(created):'â€”'}${updated?`ï¼ ç·¨é›†: ${fmtJst(updated)}`:''}ï¼‰`;

  // å…¥åŠ›UIã‚’ç·¨é›†ãƒ“ãƒ¥ãƒ¼ã¸ç§»å‹•
  editMount.appendChild(taWrap);

  // è¡¨ç¤ºåˆ‡æ›¿
  homeView.style.display = 'none';
  editView.style.display = 'block';

  // ãƒ«ãƒ¼ãƒˆæ›´æ–°ï¼ˆæˆ»ã‚‹å¯¾å¿œï¼‰
  const targetHash = '#/edit/' + entry.id;
  if (location.hash !== targetHash) history.pushState({view:'edit', id: entry.id}, '', targetHash);

  // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  setTimeout(()=>{
    ta.focus();
    const end = ta.value.length;
    ta.setSelectionRange(end,end);
    updateDropdown();
  }, 0);
}

function exitEdit(){
  editingId = null;

  // å…¥åŠ›UIã‚’å…ƒã®ä½ç½®ã¸æˆ»ã™
  if (taOriginalNext) taOriginalParent.insertBefore(taWrap, taOriginalNext);
  else taOriginalParent.appendChild(taWrap);

  editMeta.textContent = '';

  // è¡¨ç¤ºåˆ‡æ›¿
  editView.style.display = 'none';
  homeView.style.display = 'block';

  // ãƒ«ãƒ¼ãƒˆã‚’ãƒ›ãƒ¼ãƒ ã«
  if (location.hash.startsWith('#/edit/')) history.replaceState({view:'home'}, '', '#/');
}

function handleRoute(){
  const h = location.hash || '#/';
  if (h.startsWith('#/edit/')){
    const id = h.slice('#/edit/'.length);
    const entry = loadEntries().find(e=>e.id===id);
    if (entry) enterEdit(entry); else exitEdit();
  } else {
    if (editingId) exitEdit();
  }
}
window.addEventListener('hashchange', handleRoute);

// ä¿å­˜ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«
saveEditBtn.addEventListener('click', ()=>{
  if (!editingId) return exitEdit();
  const raw = ta.value.trim();
  if (!raw){ alert('ãƒ†ã‚­ã‚¹ãƒˆãŒç©ºã§ã™'); return; }
  updateEntry(editingId, raw);
  // ã“ã“ã§ä½œæˆç”¨ã®å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‚µã‚¸ã‚§ã‚¹ãƒˆã‚‚é–‰ã˜ã‚‹
    ta.value = '';
    dropdown.style.display = 'none';
    lastCaret = 0;
  exitEdit();
});
cancelEditBtn.addEventListener('click', ()=> exitEdit());

/* IDæ¨å®šï¼ˆåŒå§“åŒåå¯¾ç­–ã®è£æ–¹ï¼‰ï¼šname + term + region ã§ä¸€æ„ã«è¿‘ã¥ã‘ã‚‹ */
function guessRiderId(p){
  if(!RIDERS.length) return null;
  const key=normNameKey(p.name||'');
  const term = p.term ? `${p.term}æœŸ` : null;
  const region = normRegion(p.region||'');
  let cand = RIDERS.filter(r=> normNameKey(r.name)===key );
  if (term) cand = cand.filter(r=> (r.ki||'')===term);
  if (region) cand = cand.filter(r=> normRegion(r.region)===region);
  if (cand.length===1) return cand[0].id;
  return null;
}

/* ========== è¨­å®šï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»Googleãƒ­ã‚°ã‚¤ãƒ³ï¼‰ ========== */
const settingsBtn=document.getElementById('settingsBtn');
const settingsMenu=document.getElementById('settingsMenu');
settingsBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); settingsMenu.style.display = (settingsMenu.style.display==='block') ? 'none' : 'block'; });
document.addEventListener('click', (e)=>{ if(!settingsMenu.contains(e.target) && e.target!==settingsBtn){ settingsMenu.style.display='none'; }});

document.getElementById('loginMi').addEventListener('click', async ()=>{
  settingsMenu.style.display='none';
  if(!await ensureGisReady()) return;
  tokenClient.requestAccessToken({prompt:'consent'});
});

document.getElementById('importMi').addEventListener('click', ()=>{
  settingsMenu.style.display='none';
  const inp=Object.assign(document.createElement('input'),{type:'file',accept:'.ndjson,.jsonl'});
  inp.onchange=async ()=>{
    const text=await inp.files[0].text(); const lines=text.split(/\r?\n/).filter(Boolean);
    const got=[]; let bad=0; for(const l of lines){ try{got.push(JSON.parse(l));}catch{bad++;} }
    const cur=loadEntries(); const seen=new Set(cur.map(x=>x.id));
    for(const e of got){ if(e && !seen.has(e.id)){ cur.push(e); seen.add(e.id); } }
    const ok = saveEntries(cur);
    renderList(cur);
    alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼ˆæ–°è¦ ${got.length-bad} ä»¶ï¼å£Šã‚Œè¡Œ ${bad} ä»¶ï¼‰`);
    scheduleDriveSave();
    if(!ok) alert('æ³¨æ„ï¼šã“ã®ç’°å¢ƒã§ã¯ä¿å­˜ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚');
  };
  inp.click();
});
document.getElementById('exportMi').addEventListener('click', ()=>{
  settingsMenu.style.display='none';
  const nd=loadEntries().map(x=>JSON.stringify(x)).join('\n');
  const blob=new Blob([nd],{type:'application/x-ndjson'});
  const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob), download:`mofu_${ymdJST()}.ndjson`});
  a.click(); URL.revokeObjectURL(a.href);
});
document.getElementById('logoutMi').addEventListener('click', async ()=>{
  settingsMenu.style.display='none';
  await doLogout();
});




/* ========== Google Drive åŒæœŸï¼ˆåˆå›ã¯å‘ãã‚’ç¢ºèªï¼‰ ========== */
async function doLogout(){
  try{
    // 1) ã‚¢ãƒ—ãƒªå´ã®ã€ŒDriveé€£æº æœ‰åŠ¹ã€ãƒ•ãƒ©ã‚°ã‚’è½ã¨ã™
    try{ localStorage.removeItem(KEY_DRIVE_ENABLED); }catch{}

    // 2) ãƒãƒ¼ãƒªãƒ³ã‚°ã¨ãƒˆãƒ¼ã‚¯ãƒ³ç¶­æŒã‚’åœæ­¢
    if (typeof stopDrivePolling === 'function') stopDrivePolling();
    if (typeof stopAuthKeepAlive === 'function') stopAuthKeepAlive();

    // 3) ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å¿˜ã‚Œã‚‹
    const prevToken = accessToken;
    accessToken = null;

    // 4) ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆåŒæœŸãƒãƒƒã‚¸ç­‰ï¼‰ã‚’æ¶ˆã™
    if (typeof renderSyncStatus === 'function') renderSyncStatus();

    // 5) å¯èƒ½ãªã‚‰Googleå´ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚‚æ˜ç¤ºçš„ã«å¤±åŠ¹ï¼ˆä»»æ„ï¼‰
    //    â€» æ–°ã—ã„GISã¯ revoke(token) ãŒä½¿ãˆã¾ã™ã€‚å¤±æ•—ã—ã¦ã‚‚ç„¡è¦–ã§OKã€‚
    try{
      if (window.google?.accounts?.oauth2?.revoke && prevToken){
        await new Promise(res=> window.google.accounts.oauth2.revoke(prevToken, res));
      }
    }catch{}

    alert('Googleé€£æºã‚’è§£é™¤ã—ã¾ã—ãŸã€‚å†åº¦ã€Œè¨­å®š â†’ Googleãƒ­ã‚°ã‚¤ãƒ³ã€ã§æ¥ç¶šã§ãã¾ã™ã€‚');
  }catch(e){
    console.debug('logout error', e);
    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚');
  }
}

// â–¼ è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ç”¨ã®ãƒ•ãƒ©ã‚°
const KEY_DRIVE_ENABLED = 'mofu:drive:enabled';

// â–¼ ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ­ãƒ¼ã‚«ãƒ«ä¿æŒï¼ˆæœ‰åŠ¹æœŸé™å†…ã®ã¿ä½¿ç”¨ï¼‰
const KEY_TOKEN = 'mofu:drive:access_token';
const KEY_TOKEN_EXP = 'mofu:drive:access_token_exp'; // epoch(ms)

function saveToken(token, expiresInSec){
  const now = Date.now();
  // ä½™è£•ã‚’æŒã£ã¦ 60ç§’ æ—©ã‚ã«å¤±åŠ¹ã•ã›ã‚‹
  const exp = now + (Math.max(1, expiresInSec||3600) - 60) * 1000;
  try{
    localStorage.setItem(KEY_TOKEN, token);
    localStorage.setItem(KEY_TOKEN_EXP, String(exp));
  }catch{}
}
function loadSavedToken(){
  try{
    const t = localStorage.getItem(KEY_TOKEN);
    const exp = Number(localStorage.getItem(KEY_TOKEN_EXP)||0);
    if (t && exp > Date.now()) return { token:t, exp };
  }catch{}
  return null;
}
function clearSavedToken(){
  try{
    localStorage.removeItem(KEY_TOKEN);
    localStorage.removeItem(KEY_TOKEN_EXP);
  }catch{}
}

// â–¼ æœŸé™ãƒã‚§ãƒƒã‚¯ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆã“ã“ã«è¿½åŠ ï¼‰
function msToExpiry() {
  const s = loadSavedToken();
  return s ? (s.exp - Date.now()) : -1;
}
function tokenIsFresh(graceMs = 5 * 60 * 1000) { // æ—¢å®šã¯5åˆ†ä»¥ä¸Šæ®‹ã£ã¦ãŸã‚‰â€œæ–°é®®â€
  return msToExpiry() > graceMs;
}



// â–¼ ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚­ãƒ¼ãƒ—ã‚¢ãƒ©ã‚¤ãƒ–ï¼ˆæ¯åˆ†ãƒã‚§ãƒƒã‚¯ï¼‰
const AUTH_KEEPALIVE_TICK_MS = 60 * 1000;
let authRefreshTimer = null;

function startAuthKeepAlive(){
  stopAuthKeepAlive();
  authRefreshTimer = setInterval(async ()=>{
    const saved = loadSavedToken();
    if (!saved) return; // ãƒˆãƒ¼ã‚¯ãƒ³ç„¡ã—ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆï¼å‹æ‰‹ã«é–‹ã‹ãªã„ï¼‰
    const msLeft = saved.exp - Date.now();
    if (msLeft < 5 * 60 * 1000 && !IS_ANDROID) { // 5åˆ†å‰ã€ã‹ã¤ Android ã¯å›é¿
      try{
        await refreshAccessTokenSilent();
        renderSyncStatus?.();
      }catch{}
    }
  }, AUTH_KEEPALIVE_TICK_MS);
}

function stopAuthKeepAlive(){
  if (authRefreshTimer){
    clearInterval(authRefreshTimer);
    authRefreshTimer = null;
  }
}


// ã‚¿ãƒ–å¾©å¸°æ™‚ã«å¿µã®ãŸã‚ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼†ãƒãƒ¼ãƒªãƒ³ã‚°å†é–‹
window.addEventListener('visibilitychange', async ()=>{
  if (document.visibilityState === 'visible' && localStorage.getItem(KEY_DRIVE_ENABLED)==='1'){
    try{
      await refreshAccessTokenSilent();
      if (typeof renderSyncStatus === 'function') renderSyncStatus();
      if (typeof startDrivePolling === 'function') startDrivePolling();
    }catch{}
  }
});


// â–¼ è¿½åŠ ï¼šè‡ªå‹•ãƒãƒ¼ãƒªãƒ³ã‚°è¨­å®š
const DRIVE_POLL_INTERVAL_MS = 15000; // 15ç§’ã”ã¨ï¼ˆãŠå¥½ã¿ã§ 5â€“60ç§’ï¼‰
let drivePollTimer = null;
let lastServerMtime = null;        // ã‚µãƒ¼ãƒãƒ¼ã§æœ€å¾Œã«è¦‹ãŸ modifiedTime
let lastLocalSyncEpoch = 0;        // ãƒ­ãƒ¼ã‚«ãƒ«ã§æœ€å¾Œã«ãƒãƒ¼ã‚¸ã—ãŸæ™‚åˆ»(ms)

// Drive ãƒ¡ã‚¿å–å¾—
async function driveGetMeta(fileId){
  const url = `https://www.googleapis.com/drive/v3/files/${fileId}?fields=id,name,modifiedTime,md5Checksum,size`;
  const res = await fetch(url, { headers: authHeaders() });
  if(!res.ok) throw new Error(`Drive meta failed ${res.status}`);
  return await res.json(); // {id,name,modifiedTime,md5Checksum,size}
}

// ISO or '' â†’ epoch(ms)
function toEpoch(s){
  const t = Date.parse(s||'');
  return Number.isFinite(t) ? t : 0;
}

// NDJSON åŒå£«ã®ãƒãƒ¼ã‚¸ï¼šidå˜ä½ã«ã€Œupdated_atï¼ˆ> created_atï¼‰ã€ãŒæ–°ã—ã„æ–¹ã‚’æ¡ç”¨
function mergeEntriesLatest(localArr, serverArr){
  const score = (e)=> toEpoch(e.updated_at || e.created_at || e.at || 0);
  const m = new Map();
  for (const e of localArr) m.set(e.id, e);
  for (const e of serverArr) {
    const cur = m.get(e.id);
    if (!cur || score(e) > score(cur)) m.set(e.id, e);
  }
  return Array.from(m.values());
}


// ã‚µãƒ¼ãƒãƒ¼â†’ãƒ­ãƒ¼ã‚«ãƒ«ã¸å–ã‚Šè¾¼ã¿ï¼ˆå·®åˆ†ãŒã‚ã‚Œã°ä¿å­˜ï¼†å†æç”»ï¼‰
async function pullAndMergeFromServer(){
  if(!accessToken) return;
  try{
    if(!driveFileId){
      driveFileId = await driveFindFileIdByName();
      if(!driveFileId) return; // ã‚µãƒ¼ãƒãƒ¼æœªä½œæˆãªã‚‰ä½•ã‚‚ã—ãªã„
    }
    // å¤‰æ›´ãƒã‚§ãƒƒã‚¯ï¼ˆmodifiedTimeï¼‰
    const meta = await driveGetMeta(driveFileId);
    const mtime = meta.modifiedTime || null;
    if(mtime && mtime === lastServerMtime){
      return; // å¤‰æ›´ãªã—
    }

    // å¤‰æ›´ã‚ã‚Š â†’ NDJSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const nd = await driveDownloadFile(driveFileId);
    let serverEntries = [];
    try{ serverEntries = ndjsonToEntries(nd); }catch{ serverEntries = []; }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã®æ–¹ã«â€œæœªä¿å­˜ã®ç›´è¿‘å¤‰æ›´â€ãŒã‚ã‚‹å ´åˆã®è»½é‡å¯¾ç­–ï¼š
    // ã“ã“ã§ã¯ã€Œæœ€æ–°ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å„ªå…ˆã€ã§ãƒãƒ¼ã‚¸ï¼ˆæœ€å¾Œã«ç·¨é›†ã•ã‚ŒãŸæ–¹å‹ã¡ï¼‰
    const local = loadEntries();
    const merged = mergeEntriesLatest(local, serverEntries);

    // å¤‰åŒ–ãŒã‚ã‚Œã°åæ˜ 
    const beforeJson = JSON.stringify(local);
    const afterJson  = JSON.stringify(merged);
    if(beforeJson !== afterJson){
      saveEntries(merged);
      renderList(merged);
      if (typeof setSyncTimeNow === 'function') setSyncTimeNow();
      lastLocalSyncEpoch = Date.now();
    }

    lastServerMtime = mtime || lastServerMtime;
  }catch(err){
    // èªè¨¼åˆ‡ã‚Œã¯ã‚µã‚¤ãƒ¬ãƒ³ãƒˆæ›´æ–° â†’ æ¬¡ã®tickã§ã¾ãŸè©¦ã™
    const msg = String(err||'');
    if(msg.includes('401') || msg.includes('403')){
      try{ await refreshAccessTokenSilent(); }catch{}
    }
    // ãã‚Œä»¥å¤–ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã ã‘å‡ºã—ã¦ç¶™ç¶š
    console.debug('Drive pull failed:', err);
  }
}

// ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ï¼ˆå¤šé‡èµ·å‹•é˜²æ­¢ï¼‰
function startDrivePolling(){
  stopDrivePolling();
  // ã™ãä¸€å›ã€ä»¥é™ã¯ interval
  pullAndMergeFromServer();
  drivePollTimer = setInterval(pullAndMergeFromServer, DRIVE_POLL_INTERVAL_MS);
}

// åœæ­¢
function stopDrivePolling(){
  if(drivePollTimer){ clearInterval(drivePollTimer); drivePollTimer = null; }
}

// ãƒšãƒ¼ã‚¸ãŒéè¡¨ç¤ºã®ã¨ãã¯è² è·ã‚’æŠ‘ãˆã‚‹ï¼ˆä»»æ„ï¼‰
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState === 'hidden'){ stopDrivePolling(); }
  else if(accessToken){ startDrivePolling(); }
});


let didInitialDriveSync=false;
const SCOPE='https://www.googleapis.com/auth/drive.appdata';
const SYNC_DEBOUNCE_MS=1200;
let syncTimer=null;

function authHeaders(){ if(!accessToken) throw new Error('no access token'); return { 'Authorization': `Bearer ${accessToken}` }; }
async function waitForGis(){ for(let i=0;i<50;i++){ if(window.google?.accounts?.oauth2) return; await new Promise(r=>setTimeout(r,100)); } throw new Error('GIS load fail'); }

async function driveFindFileIdByName(name=DRIVE_FILENAME){
  const params=new URLSearchParams({spaces:'appDataFolder', q:`name='${name.replace(/'/g,"\\'")}' and trashed=false`, fields:'files(id,name)', pageSize:'1'});
  const res=await fetch(`https://www.googleapis.com/drive/v3/files?${params}`, {headers:authHeaders()});
  if(!res.ok) throw new Error(`Drive list failed ${res.status}`); const j=await res.json();
  return j.files?.[0]?.id||null;
}
async function driveDownloadFile(fileId){
  const res=await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {headers:authHeaders()});
  if(!res.ok) throw new Error(`Drive download failed ${res.status}`); return await res.text();
}
async function driveCreateFile(name, content){
  const meta={name, parents:['appDataFolder']}; const boundary='mofu_'+Math.random().toString(16).slice(2);
  const body=`--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(meta)}\r\n--${boundary}\r\nContent-Type: application/x-ndjson\r\n\r\n${content}\r\n--${boundary}--`;
  const res=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{method:'POST', headers:{...authHeaders(),'Content-Type':`multipart/related; boundary=${boundary}`}, body});
  if(!res.ok) throw new Error(`Drive create failed ${res.status}`); const j=await res.json(); return j.id;
}
async function driveUpdateFile(fileId, content){
  const res=await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {method:'PATCH', headers:{...authHeaders(),'Content-Type':'application/x-ndjson'}, body:content});
  if(!res.ok) throw new Error(`Drive update failed ${res.status}`);
}

function entriesToNdjson(arr){ return arr.map(x=>JSON.stringify(x)).join('\n'); }
function ndjsonToEntries(text){ if(!text) return []; return text.split(/\r?\n/).filter(Boolean).map(l=>JSON.parse(l)); }
function latestStamp(e){
  // updated_at > created_at > at ã®å„ªå…ˆé †ã§è¦‹ã‚‹
  return Date.parse(e.updated_at || e.created_at || e.at || 0) || 0;
}
function arrayLatestAt(arr){
  return arr.reduce((m, e) => Math.max(m, latestStamp(e)), 0);
}


async function ensureGisReady(){
  try{
    await waitForGis();
  }catch{
    alert('Googleã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚');
    return false;
  }

  if(!CLIENT_ID || !CLIENT_ID.endsWith('.apps.googleusercontent.com')){
    alert('Googleã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDãŒæœªè¨­å®šã‹ä¸æ­£ã§ã™ã€‚');
    return false;
  }
  if(!ORIGIN_ALLOWED){
    alert('ã“ã®ã‚ªãƒªã‚¸ãƒ³ã§ã¯Driveé€£æºã‚’ç„¡åŠ¹åŒ–ã—ã¦ã„ã¾ã™ã€‚');
    return false;
  }

  if(!tokenClient){
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPE,
      callback: async (resp)=>{
        if(resp.error){
          console.error(resp);
          alert('Googleæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }
        accessToken = resp.access_token;

        saveToken(accessToken, resp.expires_in); // å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜


        // â–¼ ã“ã“å¤§äº‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¸€åº¦è¨±å¯ã—ãŸã“ã¨ã‚’è¨˜éŒ²
        localStorage.setItem(KEY_DRIVE_ENABLED, '1');           // â˜…

        if (typeof renderSyncStatus === 'function') renderSyncStatus();
        if (typeof startDrivePolling === 'function') startDrivePolling();

        // â–¼ ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è‡ªå‹•ã§ç¶­æŒ
        startAuthKeepAlive();                                    // â˜…

        if(!didInitialDriveSync){
          didInitialDriveSync = true;
          await runInitialSyncFlow();
        }
      }
    });
  }
  return true;
}



// â‘¡ ã‚µã‚¤ãƒ¬ãƒ³ãƒˆæ›´æ–°ï¼ˆAndroidå¯¾ç­–ä»˜ããƒ»å¤šé‡å®Ÿè¡Œã‚¬ãƒ¼ãƒ‰ãƒ»æ¯å›callbackå†ã‚»ãƒƒãƒˆï¼‰
async function refreshAccessTokenSilent(){
  // ä¸€åº¦ã§ã‚‚ã‚µã‚¤ãƒ¬ãƒ³ãƒˆæ‹’å¦/å¤±æ•—ãŒç¢ºå®šã—ãŸã‚‰ä»¥é™ã¯èµ°ã‚‰ã›ãªã„
  if (silentDenied) {
    return Promise.reject(new Error('silent-denied'));
  }
  // Android ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰/éå¯è¦–æ™‚ã¯ã‚„ã‚‰ãªã„ï¼ˆå‹æ‰‹ã«ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè£ã§é–‹ãã®ã‚’æŠ‘æ­¢ï¼‰
  if (IS_ANDROID && document.visibilityState !== 'visible') {
    return Promise.reject(new Error('not-visible'));
  }
  // å¤šé‡å®Ÿè¡Œã‚¬ãƒ¼ãƒ‰
  if (authRefreshing) {
    return Promise.reject(new Error('refresh-inflight'));
  }

  authRefreshing = true;
  try{
    await waitForGis();

    // tokenClient æœªåˆæœŸåŒ–ãªã‚‰ãƒ€ãƒŸãƒ¼callbackã§ä¸€åº¦ã ã‘ä½œã‚‹
    if(!tokenClient){
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPE,
        callback: ()=>{} // å®Ÿã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯æ¯å›ä¸‹ã§å·®ã—æ›¿ãˆã‚‹
      });
    }

    return await new Promise((resolve, reject)=>{
      // â˜… æ¯å›ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å·®ã—æ›¿ãˆã‚‹ï¼ˆå¤ã„å‚ç…§ã‚’ä½¿ã‚ãªã„ï¼‰
      tokenClient.callback = (resp)=>{
        authRefreshing = false;

        if (resp?.error) {
          // ã‚µã‚¤ãƒ¬ãƒ³ãƒˆæ›´æ–°ãŒã€ŒåŒæ„å¿…è¦ã€ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¿…è¦ã€ãªã‚‰ä»Šå¾Œã¯è‡ªå‹•å®Ÿè¡Œã—ãªã„
          const err = String(resp.error)||'';
          if (/(consent_required|interaction_required|popup_closed)/i.test(err)) {
            silentDenied = true;
          }
          reject(resp);
          return;
        }

        accessToken = resp.access_token;
        if (resp.expires_in) saveToken(accessToken, resp.expires_in); // æœ‰åŠ¹æœŸé™å†…ã¯å†åˆ©ç”¨
        try { renderSyncStatus?.(); } catch {}
        resolve(resp);
      };

      try{
        tokenClient.requestAccessToken({ prompt: 'none' });
      }catch(e){
        authRefreshing = false;
        // ä¾‹å¤–ãŒæŠ•ã’ã‚‰ã‚Œã‚‹å ´åˆã‚‚ã€ä»¥å¾Œã®ã‚µã‚¤ãƒ¬ãƒ³ãƒˆã¯æŠ‘æ­¢
        silentDenied = true;
        reject(e);
      }
    });
  }catch(err){
    authRefreshing = false;
    throw err;
  }
}


async function runInitialSyncFlow(){
  try{
    driveFileId = await driveFindFileIdByName();
    let serverEntries = [], serverNd = '';

    if (driveFileId){
      serverNd = await driveDownloadFile(driveFileId);
      try{ serverEntries = ndjsonToEntries(serverNd); }catch{ serverEntries = []; }
    }

    const local = loadEntries();
    const localCount  = local.length;
    const serverCount = serverEntries.length;
    const localLatest  = arrayLatestAt(local);
    const serverLatest = arrayLatestAt(serverEntries);
    const fmt = (ts)=> ts ? new Date(ts).toISOString().slice(0,19).replace('T',' ') : 'â€”';

    const msgHtml = `
      <div>ãƒ­ãƒ¼ã‚«ãƒ«ï¼š<strong>${localCount}</strong> ä»¶ï¼ˆæœ€çµ‚ ${fmt(localLatest)}ï¼‰</div>
      <div>ã‚µãƒ¼ãƒãƒ¼ï¼š<strong>${serverCount}</strong> ä»¶ï¼ˆæœ€çµ‚ ${fmt(serverLatest)}ï¼‰</div>
      <div style="margin-top:6px;color:#6b7280">ã©ã¡ã‚‰ã‚’<strong>æ­£</strong>ã¨ã—ã¦åæ˜ ã—ã¾ã™ã‹ï¼Ÿ</div>
    `;

    const syncDlg = document.getElementById('syncDlg');
    document.getElementById('syncSummary').innerHTML = msgHtml;

    const choice = await new Promise((resolve)=>{
      function h(){ syncDlg.removeEventListener('close', h); resolve(syncDlg.returnValue); }
      syncDlg.addEventListener('close', h);
      syncDlg.showModal();
    });

    if (choice === 'localToServer'){
      const nd = entriesToNdjson(local);
      if (!driveFileId){
        driveFileId = await driveCreateFile(DRIVE_FILENAME, nd);
      }else{
        await driveUpdateFile(driveFileId, nd);
      }
      // â–¼ åŒæœŸæ™‚åˆ»æ›´æ–°ï¼ˆå®šç¾©ãŒã‚ã‚Œã°å‘¼ã¶ï¼‰
      if (typeof setSyncTimeNow === 'function') setSyncTimeNow();
      alert('ã‚µãƒ¼ãƒãƒ¼ã¸ä¸Šæ›¸ãã—ã¾ã—ãŸã€‚ä»¥å¾Œã¯è‡ªå‹•åŒæœŸã—ã¾ã™ã€‚');

    } else if (choice === 'serverToLocal'){
      localStorage.setItem(KEY_ENTRIES, JSON.stringify(serverEntries));
      MEM_ENTRIES = serverEntries;
      renderList(serverEntries);
      // â–¼ åŒæœŸæ™‚åˆ»æ›´æ–°ï¼ˆå®šç¾©ãŒã‚ã‚Œã°å‘¼ã¶ï¼‰
      if (typeof setSyncTimeNow === 'function') setSyncTimeNow();
      alert('ãƒ­ãƒ¼ã‚«ãƒ«ã¸ä¸Šæ›¸ãã—ã¾ã—ãŸã€‚ä»¥å¾Œã¯è‡ªå‹•åŒæœŸã—ã¾ã™ã€‚');

    } else {
      alert('åŒæœŸè¨­å®šã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚ï¼ˆã„ã¤ã§ã‚‚ã€Œè¨­å®šâ†’Googleãƒ­ã‚°ã‚¤ãƒ³ã€ã‹ã‚‰å†è¨­å®šã§ãã¾ã™ï¼‰');
    }

    // ãƒ­ã‚°ã‚¤ãƒ³ç›´å¾Œã«è¡¨ç¤ºã ã‘æ•´ãˆã‚‹ï¼ˆå®šç¾©ãŒã‚ã‚Œã°å‘¼ã¶ï¼‰
    if (typeof renderSyncStatus === 'function') renderSyncStatus();

  }catch(e){
    console.error(e);
    alert('åŒæœŸåˆæœŸè¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
  }
}


function scheduleDriveSave(){
  if(!accessToken) return;
  clearTimeout(syncTimer);
  syncTimer=setTimeout(async ()=>{
    try{
      const nd=entriesToNdjson(loadEntries());
      if(!driveFileId){ driveFileId=await driveFindFileIdByName(); if(!driveFileId) driveFileId=await driveCreateFile(DRIVE_FILENAME, nd); else await driveUpdateFile(driveFileId, nd); }
      else{ await driveUpdateFile(driveFileId, nd); }
    }catch(e){
      const msg=String(e||'');
      if(msg.includes('401')||msg.includes('403')){
        try{
          await refreshAccessTokenSilent();
          const nd=entriesToNdjson(loadEntries());
          if(!driveFileId){ driveFileId=await driveFindFileIdByName(); if(!driveFileId) driveFileId=await driveCreateFile(DRIVE_FILENAME, nd); else await driveUpdateFile(driveFileId, nd); }
          else{ await driveUpdateFile(driveFileId, nd); }
        }catch(e2){ console.warn('Driveä¿å­˜å¤±æ•—ï¼ˆå†è©¦è¡Œã‚‚å¤±æ•—ï¼‰:', e2); }
      }else{ console.warn('Driveä¿å­˜å¤±æ•—:', e); }
    }
  }, SYNC_DEBOUNCE_MS);
}

// ç·¨é›†ãƒ“ãƒ¥ãƒ¼ã§ã‚‚ "/" æŒ¿å…¥ã‚’åŒã˜æŒ™å‹•ã§
document.getElementById('eInlineSlash')?.addEventListener('click', (ev)=>{
  ev.stopPropagation();
  ta.focus();
  const st = ta.selectionStart || 0;
  ta.setRangeText('/', st, st, 'end');
  lastCaret = ta.selectionStart;
  updateDropdown();
});

// ç·¨é›†ãƒ“ãƒ¥ãƒ¼ã§ã‚‚ãƒ¬ãƒ¼ã‚¹æ¤œç´¢ã‚’é–‹ã
document.getElementById('eOpenSearch')?.addEventListener('click', ()=>{
  openSearch('');
});

function insertIntoTaAsBlock(text){
  const st = ta.selectionStart ?? ta.value.length;
  const en = ta.selectionEnd ?? st;
  const before = ta.value.slice(0, st);
  const after  = ta.value.slice(en);
  const needLFLeft  = before && !/\n$/.test(before);   // ç›´å‰ãŒæ”¹è¡Œã§ãªã‘ã‚Œã°å‰ã«æ”¹è¡Œ
  const needLFRight = after  && !/^\n/.test(after);    // ç›´å¾ŒãŒæ”¹è¡Œã§ãªã‘ã‚Œã°å¾Œã‚ã«æ”¹è¡Œ
  const piece = (needLFLeft? '\n' : '') + text + (needLFRight? '\n' : '');
  ta.value = before + piece + after;
  const pos = (before + piece).length;
  ta.setSelectionRange(pos, pos);
  lastCaret = pos;
  updateDropdown(); // ç›´å¾Œã® / ã§ã‚‚ã‚µã‚¸ã‚§ã‚¹ãƒˆãŒç´ ç›´ã«å‡ºã‚‹ã‚ˆã†ã«
}

function waitForFirstUserGesture(){
  if (document.userActivation?.hasBeenActive) return Promise.resolve();
  return new Promise((resolve) => {
    const once = () => { off(); resolve(); };
    const off = () => {
      window.removeEventListener('pointerdown', once, true);
      window.removeEventListener('keydown', once, true);
      window.removeEventListener('touchstart', once, true);
    };
    window.addEventListener('pointerdown', once, true);
    window.addEventListener('keydown', once, true);
    window.addEventListener('touchstart', once, true);
  });
}


/* ========== åˆæœŸåŒ– ========== */

(async () => {
  setStatus(riderStatus, false, 'â€¦');
  setStatus(raceStatus,  false, 'â€¦');
  renderList(loadEntries());
  await Promise.allSettled([ fetchRiders(), fetchRaces() ]);
  lastCaret = ta.selectionStart;
  updateDropdown();
  handleRoute();


// â–¼ ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å¸°ï¼ˆãƒãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ–¹é‡ï¼‰
const saved = loadSavedToken();
if (saved) {
  accessToken = saved.token;         // ã¾ãšã¯æ‰‹å…ƒã®ãƒˆãƒ¼ã‚¯ãƒ³ã ã‘ã§å¾©å¸°ï¼ˆGISè§¦ã‚‰ãªã„ï¼‰
  renderSyncStatus?.();
  startDrivePolling?.();
  startAuthKeepAlive?.();
}

if (localStorage.getItem(KEY_DRIVE_ENABLED) === '1') {
  // æœ‰åŠ¹æœŸé™ãŒè¿‘ã„/åˆ‡ã‚Œã¦ã„ã‚‹æ™‚ã ã‘ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œâ€œå¾Œâ€ã«ã‚µã‚¤ãƒ¬ãƒ³ãƒˆæ›´æ–°
  const needRefresh = !saved || !tokenIsFresh(); // tokenIsFresh(grace=5åˆ†)
  if (needRefresh) {
    // 1) ã‚¿ãƒ–ãŒå¯è¦–ã«ãªã‚‹ã®ã‚’å¾…ã¤
    if (document.visibilityState !== 'visible') {
      await new Promise((r) => {
        const onVis = () => {
          if (document.visibilityState === 'visible') {
            document.removeEventListener('visibilitychange', onVis);
            r();
          }
        };
        document.addEventListener('visibilitychange', onVis);
      });
    }
    // 2) æœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’å¾…ã¤ï¼ˆã‚¯ãƒªãƒƒã‚¯/ã‚­ãƒ¼/ã‚¿ãƒƒãƒï¼‰
    await waitForFirstUserGesture();

    // 3) ã“ã“ã§åˆã‚ã¦ GIS ã‚’æº–å‚™ï¼†ã‚µã‚¤ãƒ¬ãƒ³ãƒˆæ›´æ–°ï¼ˆprompt:'none'ï¼‰
    try {
      await ensureGisReady();
      await refreshAccessTokenSilent();
      renderSyncStatus?.();
      startDrivePolling?.();
      startAuthKeepAlive?.();
    } catch (e) {
      console.debug('silent refresh skipped:', e); // å¤±æ•—ã—ã¦ã‚‚ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã¯å‡ºã•ãªã„
    }
  }
}



// â–¼ è¿½åŠ ï¼šãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§å‰å›åŒæœŸæ™‚åˆ»ãŒã‚ã‚Œã°è¡¨ç¤º
  if (typeof renderSyncStatus === 'function') renderSyncStatus();
  if (accessToken) startDrivePolling();  // â† è¿½åŠ ï¼šæ—¢ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹å ´åˆã«ç›£è¦–é–‹å§‹

})();
</script>
</body>
</html>
