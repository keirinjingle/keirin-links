<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>もふメモ</title>
<meta name="description" content="競輪メモ。ローカル保存＋/サジェスト（戦法・選手・レース・タグ）＋素朴検索＋Drive同期＋レース検索。" />

<!-- ▼ あなたの Client ID（.apps.googleusercontent.com で終わる） -->
<meta name="mofu:google-client-id" content="451004577569-euhu5f661onevj9a0tlsfr9i4jntm6jm.apps.googleusercontent.com">
<!-- ▼ 許可オリジン（必要に応じて追加） -->
<meta name="mofu:allowed-origins" content="https://keirinjingle.github.io, http://localhost:3000">

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
:root{
  --bg:#FAFAFA; --fg:#1F2937; --muted:#6B7280; --line:#E5E7EB;
  --card:#FFFFFF; --accent:#2563EB; --accent-ink:#fff; --danger:#DC2626;
  --ok:#16A34A; --warn:#F59E0B; --hl:#FEF3C7; --shadow-sm:0 1px 2px rgba(0,0,0,.06); --shadow-md:0 6px 18px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
  background:var(--bg); color:var(--fg); line-height:1.6;
}

/* Header (1段) */
header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:30}
.bar{
  display:flex; align-items:center; gap:.75rem;
  padding:.65rem .9rem; flex-wrap:wrap;
}
.title{font-weight:800; font-size:1.1rem}

/* 右側ナビ（使い方/設定/寄付） */
.nav-right{margin-left:auto; display:flex; align-items:center; gap:.5rem; flex-wrap:wrap}
.nav-right .links{display:flex; gap:.35rem; align-items:center}
.nav-right .links a{padding:.35rem .55rem; border-radius:.5rem; color:#374151}

/* ボタン */
.btn{
  appearance:none; border:1px solid var(--line); background:var(--card); color:var(--fg);
  padding:.45rem .7rem; border-radius:.55rem; cursor:pointer;
  box-shadow:var(--shadow-sm);
}
.btn:hover{background:#F9FAFB}
.btn.primary{background:var(--accent); color:var(--accent-ink); border-color:transparent}
.btn.ghost{border-color:transparent; background:transparent}

/* メイン */
main{max-width:900px; margin:1rem auto; padding:0 1rem}

/* サジェストの注意 */
.hint{font-size:.9rem; color:var(--muted); background:var(--hl); padding:.5rem .7rem; border-radius:.5rem}

/* 検索ダイアログ（簡易） */
dialog{border:none; border-radius:12px; padding:0; width:min(880px, 96vw); box-shadow:var(--shadow-md)}
dialog .dlg-head{display:flex; justify-content:space-between; align-items:center; padding:.8rem 1rem; border-bottom:1px solid var(--line)}
dialog .dlg-body{padding:1rem}
dialog .dlg-foot{display:flex; justify-content:flex-end; gap:.5rem; padding:1rem; border-top:1px solid var(--line)}

textarea{width:100%; min-height:110px; padding:.6rem .7rem; border:1px solid var(--line); border-radius:.5rem; resize:vertical}
hr{border:none; border-top:1px solid var(--line); margin:1rem 0}
</style>
</head>

<body>
  <header>
    <div class="bar">
      <div class="title">🐾 もふメモ</div>
      <div class="nav-right">
        <div class="links">
          <a href="#" id="howtoLink" class="btn ghost">使い方</a>
          <div class="dropdown">
            <button class="btn" id="settingsBtn">設定 ▾</button>
          </div>
          <a href="#" id="donateLink" class="btn ghost">寄付</a>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="hint">
      ・「/」で補完を開きます（選手／当日レース／戦法／タグ）。<br/>
      ・使い方は <a href="https://keirinjingle.github.io/keirin-links/howto.html" target="_blank">詳細な使い方はこちら</a>。
    </div>

    <!-- 入力とツールバー -->
    <section style="margin-top:1rem">
      <div style="display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:.5rem">
        <button id="slashBtn" class="btn">/</button>
        <button id="openSearchBtn" class="btn">レース検索</button>
        <button id="addTopBtn" class="btn primary">登録</button>
      </div>
      <textarea id="memoInput" placeholder="ここにメモ。/ で補完（選手・レース・戦法・タグ）"></textarea>
    </section>

    <!-- 一覧 -->
    <section style="margin-top:1rem">
      <div id="entriesList"></div>
    </section>
  </main>

  <!-- 設定メニューのポップオーバー（簡易） -->
  <div id="settingsMenu" style="position:fixed; right:10px; top:58px; background:var(--card); border:1px solid var(--line); border-radius:10px; box-shadow:var(--shadow-md); padding:.5rem; display:none; z-index:40; min-width:260px">
    <div style="padding:.35rem .5rem; font-weight:700">設定</div>
    <hr/>
    <div style="display:flex; flex-direction:column; gap:.4rem; padding:.3rem .5rem">
      <button id="googleLoginBtn" class="btn">Googleログイン</button>
      <button id="exportBtn" class="btn">エクスポート（NDJSON）</button>
      <button id="importBtn" class="btn">インポート（NDJSON）</button>
    </div>
  </div>

  <!-- 検索ダイアログ -->
  <dialog id="searchDlg">
    <div class="dlg-head">
      <div>検索</div>
      <button class="btn ghost" id="closeSearchBtn">×</button>
    </div>
    <div class="dlg-body">
      <div style="display:flex; gap:.5rem; margin-bottom:.5rem">
        <button id="tabRaceBtn" class="btn primary">レース内検索</button>
        <button id="tabFullBtn" class="btn">全文検索</button>
      </div>

      <!-- タブ: レース内検索 -->
      <div id="raceTab">
        <div id="raceSuggestWrap" style="min-height:120px"></div>
        <hr/>
        <div id="newMemoWrap" style="display:none">
          <div style="font-weight:700; margin-bottom:.2rem">メモを追加</div>
          <textarea id="newMemoTa" placeholder="このレースに紐づくメモを記入"></textarea>
          <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem">
            <button id="saveMemoBtn" class="btn primary">登録</button>
            <button id="cancelMemoBtn" class="btn">キャンセル</button>
          </div>
        </div>
      </div>

      <!-- タブ: 全文検索 -->
      <div id="fullTab" style="display:none">
        <input id="searchInput" placeholder="キーワードで検索" style="width:100%; padding:.55rem .65rem; border:1px solid var(--line); border-radius:.5rem"/>
        <div id="searchResult" style="margin-top:.6rem"></div>
      </div>
    </div>
    <div class="dlg-foot">
      <button class="btn" id="clearSearchBtn">クリア</button>
      <button class="btn primary" id="goTopBtn">TOPに戻る</button>
    </div>
  </dialog>

<!-- ========== GIS (Google Identity Services) と Drive 同期ヘルパ ========== -->
<script>
(() => {
  const CLIENT_ID = (document.querySelector('meta[name="mofu:google-client-id"]')?.content || '').trim();
  let tokenClient = null;
  let accessToken = null;

  // 1) GIS準備
  function waitGisReady(timeoutMs=5000){
    return new Promise((resolve)=>{
      const t0 = Date.now();
      (function loop(){
        const ok = !!(window.google && google.accounts && google.accounts.oauth2);
        if (ok) return resolve(true);
        if (Date.now() - t0 > timeoutMs) return resolve(false);
        setTimeout(loop, 60);
      })();
    });
  }

  // 2) 外部公開：ログイン準備（app.js から呼ばれる）
  window.ensureGisReady = async function(){
    const ok = await waitGisReady();
    if (!ok) { console.error('GIS not loaded'); alert('Googleログインの準備に失敗しました'); return false; }

    if (!tokenClient){
      if (!CLIENT_ID){ alert('Google Client ID が見つかりません'); return false; }

      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/drive.file',
        callback: (resp) => {
          if (resp && resp.access_token){
            accessToken = resp.access_token;
            window.accessToken = accessToken;
            console.info('mofu: got access token');
          }else{
            console.warn('mofu: no access token in callback', resp);
          }
        }
      });
    }

    // 最初のトークン要求
    tokenClient.requestAccessToken({ prompt: 'consent' });
    return true;
  };

  // 3) 外部公開：サイレント更新（401時の再試行など）
  window.refreshAccessTokenSilent = async function(){
    const ok = await waitGisReady();
    if (!ok || !tokenClient) return false;

    return new Promise((resolve) => {
      tokenClient.callback = (resp) => {
        const has = !!(resp && resp.access_token);
        if (has){
          accessToken = resp.access_token;
          window.accessToken = accessToken;
        }
        resolve(has);
      };
      tokenClient.requestAccessToken({ prompt: '' }); // consent なし
    });
  };
})();
</script>

<!-- ▼▼▼ ここから：Drive API ヘルパ3関数を公開（必須） ▼▼▼ -->
<script>
(() => {
  const DRIVE_V3 = 'https://www.googleapis.com/drive/v3';
  const UPLOAD_V3 = 'https://www.googleapis.com/upload/drive/v3';

  async function ensureAccessToken() {
    if (window.accessToken) return true;
    if (typeof window.refreshAccessTokenSilent === 'function') {
      const ok = await window.refreshAccessTokenSilent();
      return !!ok;
    }
    return false;
  }

  async function driveFetch(url, opt = {}, retry = true) {
    const ok = await ensureAccessToken();
    if (!ok) throw new Error('No access token. Please Google-login first.');

    const res = await fetch(url, {
      ...opt,
      headers: {
        'Authorization': `Bearer ${window.accessToken}`,
        ...(opt.headers || {})
      }
    });

    // 401 → トークン失効の可能性。1回だけ再取得して再試行。
    if (res.status === 401 && retry && typeof window.refreshAccessTokenSilent === 'function') {
      const r = await window.refreshAccessTokenSilent();
      if (r) return driveFetch(url, opt, /*retry*/false);
    }
    return res;
  }

  // 1) 名前でファイルIDを探す
  window.driveFindFileIdByName = async function(name) {
    const q = encodeURIComponent(`name='${name.replace(/'/g, "\\'")}' and trashed=false`);
    const url = `${DRIVE_V3}/files?q=${q}&fields=files(id,name)&spaces=drive&pageSize=10`;
    const res = await driveFetch(url, { method: 'GET' });
    if (!res.ok) throw new Error('Drive list failed: ' + res.status);
    const data = await res.json();
    return (data.files && data.files[0] && data.files[0].id) || null;
  };

  // 2) 新規作成（multipart/related）
  window.driveCreateFile = async function(name, content) {
    const boundary = 'mofu-' + Math.random().toString(16).slice(2);
    const meta = { name, mimeType: 'application/x-ndjson' }; // NDJSON想定

    const body =
      `--${boundary}\r\n` +
      `Content-Type: application/json; charset=UTF-8\r\n\r\n` +
      `${JSON.stringify(meta)}\r\n` +
      `--${boundary}\r\n` +
      `Content-Type: application/x-ndjson; charset=UTF-8\r\n\r\n` +
      `${content || ''}\r\n` +
      `--${boundary}--`;

    const res = await driveFetch(`${UPLOAD_V3}/files?uploadType=multipart&fields=id`, {
      method: 'POST',
      headers: { 'Content-Type': `multipart/related; boundary=${boundary}` },
      body
    });
    if (!res.ok) throw new Error('Drive create failed: ' + res.status);
    const data = await res.json();
    return data.id;
  };

  // 3) 既存更新（mediaアップロード）
  window.driveUpdateFile = async function(fileId, content) {
    const res = await driveFetch(`${UPLOAD_V3}/files/${encodeURIComponent(fileId)}?uploadType=media`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/x-ndjson; charset=UTF-8' },
      body: content || ''
    });
    if (!res.ok) throw new Error('Drive update failed: ' + res.status);
    return true;
  };

  console.info('mofu: Drive helpers installed');
})();
</script>
<!-- ▲▲▲ Drive API ヘルパ ここまで ▲▲▲ -->

<!-- アプリ本体（モジュール版 or バンドル版のどちらかを使用） -->
<!-- ▼モジュール版（開発時はこちらを推奨） -->
<script type="module" src="./main.js"></script>
<!-- ▼バンドル版（本番でrollup/esbuild等で dist/app.min.js を吐く場合はこちら）
<script defer src="./dist/app.min.js"></script>
-->

</body>
</html>
