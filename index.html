<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>もふメモ | keirin changelog memo</title>
  <meta name="description" content="競輪メモをシンプルに。/でスマート補完、全文検索、Google Drive同期（任意）。" />

  <!-- ✅ 設定値はここ（ビルドなしで切替可能） -->
  <meta name="mofu:google-client-id" content="YOUR_CLIENT_ID.apps.googleusercontent.com" />
  <!-- 許可オリジン（カンマ区切り）。一致しない場合はDrive同期を無効化 -->
  <meta name="mofu:allowed-origins" content="https://yourname.github.io, http://localhost:8080" />

  <!-- 軽いCSP（必要に応じて調整してください） -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' https://accounts.google.com 'unsafe-inline';
                 connect-src 'self' https://www.googleapis.com https://keirinjingle.github.io;
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data:;">

  <!-- Google Identity Services（OAuth2 Token Client用） -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{--bg:#fff;--fg:#111;--muted:#6b7280;--line:#e5e7eb;--blue:#2563eb;--ok:#10b981;--ng:#ef4444;--hl:#FEF3C7}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:var(--fg)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);z-index:50}
    .bar{display:flex;gap:.5rem;align-items:center;padding:.6rem .8rem;flex-wrap:wrap}
    .title{font-weight:800;margin-right:auto}
    .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .5rem;border:1px solid var(--line);border-radius:999px;font-size:.8rem}
    .ok{color:var(--ok)} .ng{color:var(--ng)}
    button,.btn{appearance:none;border:1px solid var(--line);background:#fafafa;padding:.5rem .75rem;border-radius:.7rem;cursor:pointer;font-size:.9rem}
    button:active{transform:translateY(1px)}
    .slash{width:42px;padding:.5rem 0;text-align:center;font-weight:700}
    .wrap{max-width:960px;margin:14px auto;padding:0 12px}
    .hint{color:var(--muted);font-size:.85rem;margin:8px 0 10px}
    textarea{width:100%;min-height:120px;font-size:16px;padding:12px;border:1px solid var(--line);border-radius:12px}
    .row{display:flex;gap:.5rem;align-items:center;justify-content:space-between}
    .dropdown{position:absolute;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.08);display:none;max-height:260px;overflow:auto;min-width:280px}
    .item{padding:.55rem .7rem;cursor:pointer;font-size:.95rem;display:flex;gap:.5rem;align-items:center}
    .item:hover{background:#f3f4f6}
    .type{font-size:.7rem;color:#fff;background:#9ca3af;border-radius:999px;padding:0 .4rem}
    .cards{margin-top:14px}
    .card{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;margin-bottom:10px}
    .head{font-size:.95rem;margin-bottom:6px;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .head .date{font-weight:600}
    .head a{color:var(--blue);text-decoration:none}
    .raw{white-space:pre-wrap;word-break:break-word;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.95rem}
    .footer{color:var(--muted);font-size:.8rem;text-align:center;padding:20px 8px}
    .banner{margin-top:8px;padding:.6rem .8rem;border:1px solid var(--line);border-radius:10px;background:#fff7ed;color:#9a3412;font-size:.85rem}
    .toolbar{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    dialog{border:none;border-radius:12px;max-width:720px;width:96%}
    dialog::backdrop{background:rgba(0,0,0,.25)}
    .search-phrase{font-weight:700}
    .card-actions{margin-left:auto; display:flex; gap:.4rem}
    .linklike{color:var(--blue); background:transparent; border:none; padding:.2rem .4rem; cursor:pointer}
    .muted{color:var(--muted)}
    .hl{background:var(--hl);font-weight:700}
    .pulse{animation:pulse-bg 1.5s ease 1}
    @keyframes pulse-bg{0%{box-shadow:0 0 0 0 rgba(37,99,235,.25)} 100%{box-shadow:0 0 0 18px rgba(37,99,235,0)}}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">もふメモ</div>
      <span id="riderStatus" class="badge">選手DB <span class="mark">…</span></span>
      <span id="raceStatus" class="badge">レース情報 <span class="mark">…</span></span>
      <div class="spacer"></div>
      <button id="slashBtn" class="slash">/</button>
      <button id="openSearchBtn">検索</button>
      <button id="connectGoogleBtn">Googleに接続</button>
      <button id="exportBtn">エクスポート</button>
      <button id="importBtn">インポート</button>
      <button id="logoutBtn" title="この端末のログイン情報を消去">ログアウト</button>
    </div>
  </header>

  <main class="wrap">
    <div class="hint">「/」でスマート補完（選手／レース／戦法／タグ）。Enterは登録しません（登録はボタン）。Shift+Enterで改行。全文検索は［検索］から。保存は端末ローカル＋（Google接続で）Drive App Folderへ。</div>

    <div class="row" style="position:relative;margin:.25rem 0 .5rem">
      <div class="toolbar">
        <button id="inlineSlash" class="slash" title="/ を挿入">/</button>
        <button id="addBtn" class="btn">登録</button>
      </div>
    </div>

    <div style="position:relative">
      <textarea id="ta" placeholder="例）- 函館6R 先行注意 /あさい #三分戦 +展開"></textarea>
      <div id="dropdown" class="dropdown"></div>
    </div>

    <section id="cards" class="cards"></section>

    <div id="raceNotice" class="banner" style="display:none">※「状態」が〔✅〕でないときは、レース情報補完は限定的になります。</div>

    <div class="footer">データは端末ローカル（IndexedDB/localStorage）に保存。Googleに接続すると、各ユーザー自身のDrive（App Folder）にも保存されます。</div>
  </main>

  <!-- 全文検索モーダル -->
  <dialog id="fullSearchDlg">
    <div style="padding:12px 14px; display:grid; gap:10px;">
      <div style="display:flex; gap:.5rem; align-items:center;">
        <input id="searchInput" type="text" placeholder="キーワード（空白=AND、\"フレーズ\"対応）" style="flex:1; padding:.5rem .7rem; border:1px solid var(--line); border-radius:10px;">
        <button id="searchClose">閉じる</button>
      </div>
      <div id="searchResultMeta" class="muted"></div>
      <div id="searchList" style="max-height:60vh; overflow:auto"></div>
    </div>
  </dialog>

  <!-- 編集ダイアログ -->
  <dialog id="editDlg">
    <form method="dialog" style="padding:14px 16px; display:grid; gap:12px; max-width:720px;">
      <h3 style="margin:0;">メモを編集</h3>
      <textarea id="editTa" style="width:100%;min-height:160px;font-size:16px;padding:12px;border:1px solid var(--line);border-radius:12px"></textarea>
      <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:8px;">
        <button value="cancel">キャンセル</button>
        <button id="editSaveBtn" value="default" class="btn">保存</button>
      </div>
    </form>
  </dialog>

  <!-- 単一JS -->
  <script type="module" src="./app.js"></script>
</body>
</html>
