<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>もふメモ | MVP-Lite + Riders/Races</title>
<meta name="description" content="競輪メモ。ローカル保存＋/サジェスト（戦法・選手・レース・タグ）＋素朴検索。" />
<style>
  :root{
    --bg:#fffaf3; --card:#fff; --fg:#111; --muted:#6b7280; --line:#e5e7eb;
    --blue:#3b82f6; --green:#10b981; --hl:#FEF3C7;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:var(--fg)}
  header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:20}
  .bar{display:flex;gap:.5rem;align-items:center;padding:.6rem .8rem;flex-wrap:wrap}
  .title{font-weight:800;margin-right:auto}
  .wrap{max-width:900px;margin:14px auto;padding:0 12px}
  .hint{color:var(--muted);font-size:.95rem;margin:10px 0 12px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px 12px;line-height:1.6}
  .hint a{color:#2563eb;text-decoration:none}
  textarea{width:100%;min-height:120px;font-size:16px;padding:12px;border:1px solid var(--line);border-radius:12px;background:var(--card)}
  .toolbar{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin:.4rem 0}
  .btn{appearance:none;border:1px solid var(--line);background:#fafafa;padding:.55rem .85rem;border-radius:.8rem;cursor:pointer;font-size:.95rem}
  .btn:active{transform:translateY(1px)}
  .btn-primary{background:#e8fbf3;border-color:#c9f3e3}
  .cards{margin-top:14px}
  .card{padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:var(--card);margin-bottom:10px;box-shadow:0 2px 6px rgba(0,0,0,.04)}
  .head{font-size:.95rem;margin-bottom:6px;display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  .head .date{font-weight:600}
  .raw{white-space:pre-wrap;word-break:break-word;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:.95rem}
  .linklike{color:#2563eb; background:transparent; border:none; padding:.2rem .4rem; cursor:pointer}
  .footer{color:var(--muted);font-size:.85rem;text-align:center;padding:20px 8px}

  /* ▼ ドロップダウン（テキストエリア直下・固定配置） */
  .dropdown{
    position:absolute; left:0; right:0; top:100%; margin-top:6px;
    background:var(--card); border:1px solid var(--line); border-radius:12px;
    box-shadow:0 10px 24px rgba(0,0,0,.08); display:none; overflow:auto; max-height:260px; z-index:30;
    padding-bottom:max(8px, env(safe-area-inset-bottom));
    overscroll-behavior: contain; -webkit-overflow-scrolling: touch; touch-action: pan-y;
  }
  .item{padding:.55rem .7rem;cursor:pointer;font-size:.95rem;display:flex;gap:.5rem;align-items:center}
  .item:hover{background:#f3f4f6}
  .item.is-active{ background:#eef2ff; }
  .type{font-size:.7rem;color:#fff;background:#9ca3af;border-radius:999px;padding:0 .4rem}

  dialog{border:none;border-radius:12px;max-width:720px;width:96%;}
  dialog::backdrop{background:rgba(0,0,0,.25)}
  .hl{background:var(--hl);font-weight:700}

  /* ステータスバッジ（任意表示用） */
  .badge{display:inline-flex;align-items:center;gap:.35rem;padding:.2rem .5rem;border:1px solid var(--line);border-radius:999px;font-size:.8rem;background:var(--card)}
  .ok{color:#10b981} .ng{color:#ef4444}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">もふメモ</div>
    <span id="riderStatus" class="badge">選手DB <span class="mark">…</span></span>
    <span id="raceStatus" class="badge">レース情報 <span class="mark">…</span></span>
    <button id="openSearch" class="btn" title="Ctrl/Cmd+K でも開けます">検索</button>
  </div>
</header>

<main class="wrap">
  <div class="hint">
    <div>・「/」で補完を開きます（戦法／@選手／当日レース／+タグ）。</div>
    <div>・まずはローカル保存のみ。安定後に外部連携等を段階追加。</div>
  </div>

  <div class="toolbar">
    <button id="inlineSlash" class="btn" title="/ を挿入">/</button>
    <button id="addBtn" class="btn btn-primary">登録</button>
  </div>

  <div id="taWrap" style="position:relative">
    <textarea id="ta" placeholder="例）- 函館6R 先行注意 /まくり +展開 @山田太郎"></textarea>
    <div id="dropdown" class="dropdown"></div>
  </div>

  <section id="cards" class="cards"></section>

  <div class="footer">データは端末ローカル（localStorage）にのみ保存されます。</div>
</main>

<!-- 検索ダイアログ（素朴検索のみ） -->
<dialog id="searchDlg">
  <div style="padding:12px 14px; display:grid; gap:10px;">
    <div style="display:flex;align-items:center;gap:.5rem;justify-content:space-between">
      <div style="display:flex; gap:.5rem; align-items:center;">
        <strong>全文検索（素朴）</strong>
        <input id="searchInput" type="text" placeholder="語句を入力（raw.includes）" style="width:46ch;max-width:68vw;padding:.4rem .6rem;border:1px solid var(--line);border-radius:.6rem">
      </div>
      <button id="searchClose" class="btn">閉じる</button>
    </div>
    <div id="searchCount" style="color:#6b7280"></div>
    <div id="searchList" style="margin-top:.25rem; max-height:60vh; overflow:auto;"></div>
  </div>
</dialog>

<script>
/* ====== 最小ユーティリティ ====== */
const ta = document.getElementById('ta');
const dropdown = document.getElementById('dropdown');
const KEY_ENTRIES = 'mofu:entries:mvp1';
let composing=false, imeJustEnded=false, ddSel=-1, curItems=[], lastCaret=0;
const IME_SUPPRESS_MS=200;

const riderStatus = document.getElementById('riderStatus');
const raceStatus  = document.getElementById('raceStatus');
function setStatus(el, ok, msg){
  const mark = el.querySelector('.mark');
  mark.textContent = ok ? '✅' : `✖${msg?`(${msg})`:''}`;
  el.classList.toggle('ok', !!ok);
  el.classList.toggle('ng', !ok);
}

/* ====== 外部データ（選手DB・当日レース） ====== */
const RIDERS_URL = 'https://keirinjingle.github.io/keirin-links/senshuID.json';
const RACES_URL  = (ymd) => `https://keirinjingle.github.io/date/keirin_race_list_${ymd}.json`;

let RIDERS = [];   // {id,name,region,ki,grade,profile}
let DAYCARDS = []; // [{venue, races:[{race_number, url, ...}]}]

// JST日付（YYYYMMDD）
const ymdJST = () => {
  const d = new Date();
  const tzAdj = d.getTimezoneOffset() * 60000;
  return new Date(d.getTime() - tzAdj).toISOString().slice(0,10).replace(/-/g,'');
};

/* ====== ローカル入出力 ====== */
const loadEntries=()=>JSON.parse(localStorage.getItem(KEY_ENTRIES)||'[]');
const saveEntries=(a)=>localStorage.setItem(KEY_ENTRIES, JSON.stringify(a));

/* ====== 選手・レース取得 ====== */
function extractKi(kiText){ const m=(kiText||'').match(/(\d+)期/); return m ? `${m[1]}期` : (kiText||''); }

async function fetchRiders(){
  try{
    const res = await fetch(RIDERS_URL, { cache:'no-cache' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const raw = await res.text();
    let arr;
    try{ arr = JSON.parse(raw); } catch{ throw new Error('JSON parse error'); }
    RIDERS = arr.map(r=>({
      id: String(r['登録番号']||'').trim(),
      name: r['選手名'],
      ki: extractKi(r['期']),
      region: r['地域']||'',
      grade: r['級']||'',
      profile: (r['プロフィールURL']||'').replace('https://keirin.netkeiba.comhttps://','https://')
    }));
    setStatus(riderStatus, true);
  }catch(e){
    console.warn('選手DB取得失敗:', e);
    RIDERS = [];
    setStatus(riderStatus, false, e.message||'fetch error');
  }
}

async function fetchRaces(){
  try{
    const url = RACES_URL(ymdJST());
    const res = await fetch(url, { cache:'no-cache' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const raw = await res.text();
    let data;
    try{ data = JSON.parse(raw); } catch{ throw new Error('JSON parse error'); }
    DAYCARDS = Array.isArray(data) ? data : [];
    setStatus(raceStatus, true);
  }catch(e){
    console.warn('当日レース取得失敗:', e);
    DAYCARDS = [];
    setStatus(raceStatus, false, e.message||'fetch error');
  }
}

/* ====== サジェスト（戦法・選手・レース・タグ） ====== */
const TACTICS = ['三分戦','二分戦','単騎','先行一車','まくり','差し','カマシ','自在'];

function getSlashToken(text, caret){
  const m = text.slice(0, caret).match(/(^|\s)\/(\S*)$/);
  if (!m) return null;
  return { token:m[2], start:caret - m[2].length - 1, end: caret };
}
function norm(s){ return (s||'').toLowerCase(); }

function findCandidates(q){
  const items=[];
  const n = norm(q||'');
  const wantFallback = !q || !q.trim();
  const hasDigit = /[0-9０-９]/.test(q||'');

  // 0) 戦法（常に提示）
  const ts = q ? TACTICS.filter(t=>norm(t).includes(n)) : TACTICS;
  items.push(...ts.map(t=>({type:'tactic', t})));

  // 1) 選手（DBがあれば最優先）
  if (RIDERS.length && q){
    const list = RIDERS
      .filter(r => (`${r.name} ${r.region} ${r.ki}`).toLowerCase().includes(n))
      .slice(0, 6);
    items.push(...list.map(r => ({ type:'riderDb', r })));
  } else if (q){
    // DBが無いときは自由入力の@候補
    items.push({type:'rider', name:q});
  }

  // 2) レース（当日データがあれば）
  if (DAYCARDS.length && (wantFallback || hasDigit || (q && DAYCARDS.some(v=> norm(v.venue).includes(n) || n.includes(norm(v.venue)))))){
    const lower = n;
    let pushed = 0;
    outer: for (const v of DAYCARDS){
      const matchVenue = !q || norm(v.venue).includes(lower) || lower.includes(norm(v.venue));
      if (!matchVenue && !hasDigit) continue;
      for (const rr of v.races){
        let pass=true;
        if (hasDigit){
          const m = lower.match(/(\d{1,2})$/);
          if (m){ const no=parseInt(m[1],10); pass = (rr.race_number===no); }
        }
        if (pass){
          items.push({ type:'race', v, r: rr });
          pushed++;
          if (pushed>=8) break outer;
        }
      }
    }
  }

  // 3) タグ（自由入力）
  if (q) items.push({type:'tag', tag:q});

  return items.slice(0, 8);
}

function renderDropdown(items){
  if (!items.length){ dropdown.style.display='none'; ddSel=-1; return; }
  dropdown.innerHTML = items.map((it,i)=>{
    if (it.type==='tactic') return `<div class="item" data-i="${i}"><span class="type">戦法</span> #${it.t}</div>`;
    if (it.type==='riderDb'){
      const r=it.r; const right = r.region ? `${r.region}／${r.ki}` : r.ki;
      return `<div class="item" data-i="${i}"><span class="type">選手</span> @${r.name}（${right}）</div>`;
    }
    if (it.type==='race'){
      return `<div class="item" data-i="${i}"><span class="type">レース</span> - ${it.v.venue}${it.r.race_number}R</div>`;
    }
    if (it.type==='rider')  return `<div class="item" data-i="${i}"><span class="type">選手</span> @${it.name}</div>`;
    return `<div class="item" data-i="${i}"><span class="type">タグ</span> +${it.tag}</div>`;
  }).join('');
  dropdown.style.display='block';
  ddSel=0; highlightSelection();
  dropdown.scrollTop=0;
}

/* ====== ドロップダウン操作（IME安全・固定配置） ====== */
function highlightSelection(){
  const nodes=dropdown.querySelectorAll('.item');
  nodes.forEach((n,i)=>n.classList.toggle('is-active', i===ddSel));
  const active=nodes[ddSel];
  if(active){
    const r=active.getBoundingClientRect(), pr=dropdown.getBoundingClientRect();
    if(r.top<pr.top || r.bottom>pr.bottom) active.scrollIntoView({block:'nearest'});
  }
}
function moveSelection(delta){
  const n=dropdown.querySelectorAll('.item').length; if(!n) return;
  if(ddSel<0) ddSel=0; ddSel=(ddSel+delta+n)%n; highlightSelection();
}
function commitDropdown(idx){
  const tok=getSlashToken(ta.value, lastCaret);
  if(!tok){ dropdown.style.display='none'; ddSel=-1; return; }
  const it=curItems[idx];
  if(!it){ dropdown.style.display='none'; ddSel=-1; return; }

  let insert='';
  if(it.type==='tactic') insert = '#'+it.t;
  else if(it.type==='riderDb') insert = '@'+it.r.name;
  else if(it.type==='race') insert = `- ${it.v.venue}${it.r.race_number}R`;
  else if(it.type==='rider') insert = '@'+it.name;
  else insert = '+'+it.tag;

  const before=ta.value.slice(0,tok.start);
  const after=ta.value.slice(tok.end);

  const needsLeadingSpace = before && !/\s$/.test(before);
  const needsTrailingSpace = after && !/^\s/.test(after);

  const piece = (needsLeadingSpace?' ':'') + insert + (needsTrailingSpace?' ':'');
  ta.value = before + piece + after;

  const newPos = (before + piece).length;
  ta.setSelectionRange(newPos,newPos);
  lastCaret=newPos;

  dropdown.style.display='none'; ddSel=-1;
  ta.focus();
}

/* ====== 入力ハンドラ（IME完全ガード） ====== */
ta.addEventListener('compositionstart', ()=>{ composing=true; });
ta.addEventListener('compositionend', ()=>{
  composing=false;
  lastCaret=ta.selectionStart;
  updateDropdown();
  imeJustEnded=true;
  setTimeout(()=> imeJustEnded=false, IME_SUPPRESS_MS);
});
ta.addEventListener('input', ()=>{ lastCaret=ta.selectionStart; updateDropdown(); });
ta.addEventListener('keyup', (e)=>{ lastCaret=ta.selectionStart; if(e.key==='/' && !composing) updateDropdown(); });
ta.addEventListener('click', ()=>{ lastCaret=ta.selectionStart; });
document.addEventListener('selectionchange', ()=>{ if(document.activeElement===ta){ lastCaret=ta.selectionStart; }});

ta.addEventListener('keydown', (e)=>{
  // IME変換中は何もしない
  if (e.isComposing) return;

  // キャレット常に最新
  lastCaret = ta.selectionStart;

  if (dropdown.style.display!=='block') return;

  const tok = getSlashToken(ta.value, lastCaret);
  if (!tok) return;

  if(e.key==='ArrowDown'){ e.preventDefault(); moveSelection(1); }
  else if(e.key==='ArrowUp'){ e.preventDefault(); moveSelection(-1); }
  else if(e.key==='Enter' || e.key==='Tab'){
    if (imeJustEnded) return;
    e.preventDefault();
    if (ddSel>=0) commitDropdown(ddSel);
  }else if(e.key==='Escape'){ e.preventDefault(); dropdown.style.display='none'; ddSel=-1; }
});

/* モバイル：スクロールとタップの誤確定抑止 */
let tapState=null; const TAP_MOVE_TOL=6;
dropdown.addEventListener('pointerdown', (e)=>{
  const node=e.target.closest('.item'); if(!node){ tapState=null; return; }
  tapState={ idx:parseInt(node.dataset.i,10), x:e.clientX, y:e.clientY, dragged:false };
});
dropdown.addEventListener('pointermove', (e)=>{
  if(!tapState) return;
  if(Math.abs(e.clientX-tapState.x)>TAP_MOVE_TOL || Math.abs(e.clientY-tapState.y)>TAP_MOVE_TOL) tapState.dragged=true;
});
dropdown.addEventListener('scroll', ()=>{ if(tapState) tapState.dragged=true; });
dropdown.addEventListener('pointerup', (e)=>{
  if(!tapState) return;
  const node=e.target.closest('.item'); const idx=node?parseInt(node.dataset.i,10):tapState.idx;
  const dragged=tapState.dragged; tapState=null;
  if(!dragged){ e.preventDefault(); e.stopPropagation(); commitDropdown(idx); }
});
dropdown.addEventListener('pointercancel', ()=>{ tapState=null; });

/* スラッシュ挿入 */
document.getElementById('inlineSlash').addEventListener('click', ()=>{
  ta.focus(); const st=ta.selectionStart; ta.setRangeText('/', st, st, 'end');
  lastCaret=ta.selectionStart; updateDropdown();
});

/* ====== メモのCRUD（rawのみ保存） ====== */
function addEntry(raw){
  const entry={ id: Date.now().toString(36)+Math.random().toString(16).slice(2), at:new Date().toISOString(), raw };
  const arr=loadEntries(); arr.push(entry); saveEntries(arr); renderList();
}
function updateEntry(id, newRaw){
  const arr=loadEntries(); const i=arr.findIndex(e=>e.id===id); if(i<0) return;
  arr[i]={ ...arr[i], raw:newRaw, at:new Date().toISOString() }; saveEntries(arr); renderList();
}
function deleteEntry(id){
  const arr=loadEntries().filter(e=>e.id!==id); saveEntries(arr); renderList();
}

document.getElementById('addBtn').addEventListener('click', ()=>{
  const raw=ta.value.trim(); if(!raw){ alert('テキストが空です'); return; }
  addEntry(raw); ta.value=''; dropdown.style.display='none';
});

/* ====== 表示 ====== */
function linkifyRaw(html){
  // @name と +tag だけ軽くリンク化（検索にジャンプ）
  html=html.replace(/@([^\s@#\+（）()]+)/g,(m,n)=>`<a href="#" class="riderLink" data-q="@${n}">@${n}</a>`);
  html=html.replace(/\+("[^"]+"|[\w\u3040-\u30ff\u4e00-\u9faf]+)/g,(m)=>`<a href="#" class="tagLink" data-q="${m}">${m}</a>`);
  return html;
}
function renderList(){
  const el=document.getElementById('cards');
  const list=loadEntries().slice().reverse();
  el.innerHTML=list.map(e=>{
    const headLeft=(e.at||'').slice(0,10);
    const raw=linkifyRaw((e.raw||'').replace(/</g,'&lt;'));
    const actions=`<div style="margin-left:auto;display:flex;gap:.4rem">
      <button class="linklike editBtn" data-id="${e.id}">編集</button>
      <button class="linklike delBtn" data-id="${e.id}">削除</button></div>`;
    return `<div class="card" id="card_${e.id}">
      <div class="head"><span class="date">${headLeft}</span> ${actions}</div>
      <div class="raw">${raw}</div></div>`;
  }).join('') || '<div class="card" style="color:#9ca3af">（まだメモがありません）</div>';
}
renderList();

/* ====== 編集・削除・リンクで検索 ====== */
document.body.addEventListener('click', (e)=>{
  const editBtn=e.target.closest('.editBtn'); const delBtn=e.target.closest('.delBtn');
  const r=e.target.closest('a.riderLink'); const t=e.target.closest('a.tagLink');

  if(editBtn){
    const id=editBtn.dataset.id;
    const entry=loadEntries().find(x=>x.id===id); if(!entry) return;
    const newRaw=prompt('メモを編集', entry.raw||''); if(newRaw==null) return;
    updateEntry(id, newRaw);
    return;
  }
  if(delBtn){
    const id=delBtn.dataset.id; if(confirm('このメモを削除しますか？')) deleteEntry(id); return;
  }
  if(r){ e.preventDefault(); openSearch(r.dataset.q); }
  if(t){ e.preventDefault(); openSearch(t.dataset.q); }
});

/* ====== 素朴検索（Ctrl/Cmd+K） ====== */
const searchDlg=document.getElementById('searchDlg');
const searchInput=document.getElementById('searchInput');
document.getElementById('openSearch').addEventListener('click', ()=>openSearch(''));
document.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); openSearch(''); }});

function openSearch(prefill){
  searchInput.value=prefill||'';
  document.getElementById('searchList').innerHTML='';
  document.getElementById('searchCount').textContent='';
  searchDlg.showModal(); searchInput.focus();
  runSearch();
}
document.getElementById('searchClose').addEventListener('click', ()=> searchDlg.close());
let searchTimer=null;
searchInput.addEventListener('input', ()=>{ clearTimeout(searchTimer); searchTimer=setTimeout(runSearch,200); });

function makeHiliter(words){
  const sorted=[...words].sort((a,b)=>b.length-a.length);
  const res=sorted.map(w=>w.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'));
  if(!res.length) return s=>s; const re=new RegExp('('+res.join('|')+')','gi');
  return s=>s.replace(re,'<span class="hl">$1</span>');
}
function snippet(raw, query){
  if(!query.length) return raw.slice(0,120);
  const q=query[0]; const idx=raw.toLowerCase().indexOf(q.toLowerCase());
  const i=idx>=0?idx:0; const start=Math.max(0,i-40), end=Math.min(raw.length,i+80);
  return (start>0?'…':'')+raw.slice(start,end)+(end<raw.length?'…':'');
}
function runSearch(){
  const q=(searchInput.value||'').trim();
  const all=loadEntries();
  const hits = q ? all.filter(e => (e.raw||'').includes(q)) : all.slice();
  hits.sort((a,b)=>(b.at||'').localeCompare(a.at||''));
  const words = q ? [q] : [];
  const hi = makeHiliter(words);

  const html=hits.slice(0,200).map(e=>{
    const headLeft=(e.at||'').slice(0,10);
    const snip=snippet(e.raw, words).replace(/</g,'&lt;');
    return `<div class="card result-item">
      <div class="head"><span class="date">${headLeft}</span>
        <button class="linklike openCardBtn" data-id="${e.id}">表示</button></div>
      <div class="raw">${hi(snip)}</div>
    </div>`;
  }).join('') || '<div class="card" style="color:#9ca3af">（該当なし）</div>';

  document.getElementById('searchList').innerHTML=html;
  document.getElementById('searchCount').textContent=`${hits.length} 件`;

  document.getElementById('searchList').onclick = (e)=>{
    const btn=e.target.closest('.openCardBtn'); if(!btn) return;
    const id=btn.dataset.id; searchDlg.close();
    const node=document.getElementById('card_'+id);
    if(node){ node.scrollIntoView({behavior:'smooth', block:'center'}); }
  };
}

/* ====== 初期化：外部データ並行取得（失敗しても継続） ====== */
(async () => {
  setStatus(riderStatus, false, '…');
  setStatus(raceStatus,  false, '…');
  renderList();
  await Promise.allSettled([ fetchRiders(), fetchRaces() ]);
  // 入力中なら候補を最新化
  lastCaret = ta.selectionStart;
  updateDropdown();
})();

/* ====== サジェスト更新トリガ ====== */
function updateDropdown(){
  const tok=getSlashToken(ta.value, lastCaret);
  if (!tok){ dropdown.style.display='none'; return; }
  curItems=findCandidates(tok.token);
  renderDropdown(curItems);
}
</script>
</body>
</html>
