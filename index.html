<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ã‚‚ãµãƒ¡ãƒ¢</title>
<meta name="description" content="ç«¶è¼ªãƒ¡ãƒ¢ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‹/ã‚µã‚¸ã‚§ã‚¹ãƒˆï¼ˆæˆ¦æ³•ãƒ»é¸æ‰‹ãƒ»ãƒ¬ãƒ¼ã‚¹ãƒ»ã‚¿ã‚°ï¼‰ï¼‹ç´ æœ´æ¤œç´¢ï¼‹DriveåŒæœŸï¼‹ãƒ¬ãƒ¼ã‚¹æ¤œç´¢ã€‚" />

<!-- â–¼ ã‚ãªãŸã® Client IDï¼ˆ.apps.googleusercontent.com ã§çµ‚ã‚ã‚‹ï¼‰ -->
<meta name="mofu:google-client-id" content="451004577569-euhu5f661onevj9a0tlsfr9i4jntm6jm.apps.googleusercontent.com">
<!-- â–¼ è¨±å¯ã‚ªãƒªã‚¸ãƒ³ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¿½åŠ ï¼‰ -->
<meta name="mofu:allowed-origins" content="https://keirinjingle.github.io, http://localhost:3000">

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
:root{
  --bg:#FAFAFA; --fg:#1F2937; --muted:#6B7280; --line:#E5E7EB;
  --card:#FFFFFF; --accent:#2563EB; --accent-ink:#fff; --danger:#DC2626;
  --ok:#16A34A; --warn:#F59E0B; --hl:#FEF3C7; --shadow-sm:0 1px 2px rgba(0,0,0,.06); --shadow-md:0 6px 18px rgba(0,0,0,.08);
}
*{box-sizing:border-box}
html,body{margin:0;padding:0}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
  background:var(--bg); color:var(--fg); line-height:1.6;
}

/* Header (1æ®µ) */
header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:30}
.bar{
  display:flex; align-items:center; gap:.75rem;
  padding:.65rem .9rem; flex-wrap:wrap;
}
.title{font-weight:800; font-size:1.1rem}

/* å³å´ãƒŠãƒ“ï¼ˆä½¿ã„æ–¹/è¨­å®š/å¯„ä»˜ï¼‰ */
.nav-right{margin-left:auto; display:flex; align-items:center; gap:.5rem; flex-wrap:wrap}
.nav-right .links{display:flex; gap:.35rem; align-items:center}
.nav-right .links a{padding:.35rem .55rem; border-radius:.5rem; color:#374151}

/* ãƒœã‚¿ãƒ³ */
.btn{
  appearance:none; border:1px solid var(--line); background:var(--card); color:var(--fg);
  padding:.45rem .7rem; border-radius:.55rem; cursor:pointer;
  box-shadow:var(--shadow-sm);
}
.btn:hover{background:#F9FAFB}
.btn.primary{background:var(--accent); color:var(--accent-ink); border-color:transparent}
.btn.ghost{border-color:transparent; background:transparent}

/* ãƒ¡ã‚¤ãƒ³ */
main{max-width:900px; margin:1rem auto; padding:0 1rem}

/* ã‚µã‚¸ã‚§ã‚¹ãƒˆã®æ³¨æ„ */
.hint{font-size:.9rem; color:var(--muted); background:var(--hl); padding:.5rem .7rem; border-radius:.5rem}

/* æ¤œç´¢ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆç°¡æ˜“ï¼‰ */
dialog{border:none; border-radius:12px; padding:0; width:min(880px, 96vw); box-shadow:var(--shadow-md)}
dialog .dlg-head{display:flex; justify-content:space-between; align-items:center; padding:.8rem 1rem; border-bottom:1px solid var(--line)}
dialog .dlg-body{padding:1rem}
dialog .dlg-foot{display:flex; justify-content:flex-end; gap:.5rem; padding:1rem; border-top:1px solid var(--line)}

textarea{width:100%; min-height:110px; padding:.6rem .7rem; border:1px solid var(--line); border-radius:.5rem; resize:vertical}
hr{border:none; border-top:1px solid var(--line); margin:1rem 0}
</style>
</head>

<body>
  <header>
    <div class="bar">
      <div class="title">ğŸ¾ ã‚‚ãµãƒ¡ãƒ¢</div>
      <div class="nav-right">
        <div class="links">
          <a href="#" id="howtoLink" class="btn ghost">ä½¿ã„æ–¹</a>
          <div class="dropdown">
            <button class="btn" id="settingsBtn">è¨­å®š â–¾</button>
          </div>
          <a href="#" id="donateLink" class="btn ghost">å¯„ä»˜</a>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="hint">
      ãƒ»ã€Œ/ã€ã§è£œå®Œã‚’é–‹ãã¾ã™ï¼ˆé¸æ‰‹ï¼å½“æ—¥ãƒ¬ãƒ¼ã‚¹ï¼æˆ¦æ³•ï¼ã‚¿ã‚°ï¼‰ã€‚<br/>
      ãƒ»ä½¿ã„æ–¹ã¯ <a href="https://keirinjingle.github.io/keirin-links/howto.html" target="_blank">è©³ç´°ãªä½¿ã„æ–¹ã¯ã“ã¡ã‚‰</a>ã€‚
    </div>

    <!-- å…¥åŠ›ã¨ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
    <section style="margin-top:1rem">
      <div style="display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom:.5rem">
        <button id="slashBtn" class="btn">/</button>
        <button id="openSearchBtn" class="btn">ãƒ¬ãƒ¼ã‚¹æ¤œç´¢</button>
        <button id="addTopBtn" class="btn primary">ç™»éŒ²</button>
      </div>
      <textarea id="memoInput" placeholder="ã“ã“ã«ãƒ¡ãƒ¢ã€‚/ ã§è£œå®Œï¼ˆé¸æ‰‹ãƒ»ãƒ¬ãƒ¼ã‚¹ãƒ»æˆ¦æ³•ãƒ»ã‚¿ã‚°ï¼‰"></textarea>
    </section>

    <!-- ä¸€è¦§ -->
    <section style="margin-top:1rem">
      <div id="entriesList"></div>
    </section>
  </main>

  <!-- è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ï¼ˆç°¡æ˜“ï¼‰ -->
  <div id="settingsMenu" style="position:fixed; right:10px; top:58px; background:var(--card); border:1px solid var(--line); border-radius:10px; box-shadow:var(--shadow-md); padding:.5rem; display:none; z-index:40; min-width:260px">
    <div style="padding:.35rem .5rem; font-weight:700">è¨­å®š</div>
    <hr/>
    <div style="display:flex; flex-direction:column; gap:.4rem; padding:.3rem .5rem">
      <button id="googleLoginBtn" class="btn">Googleãƒ­ã‚°ã‚¤ãƒ³</button>
      <button id="exportBtn" class="btn">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆNDJSONï¼‰</button>
      <button id="importBtn" class="btn">ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆNDJSONï¼‰</button>
    </div>
  </div>

  <!-- æ¤œç´¢ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <dialog id="searchDlg">
    <div class="dlg-head">
      <div>æ¤œç´¢</div>
      <button class="btn ghost" id="closeSearchBtn">Ã—</button>
    </div>
    <div class="dlg-body">
      <div style="display:flex; gap:.5rem; margin-bottom:.5rem">
        <button id="tabRaceBtn" class="btn primary">ãƒ¬ãƒ¼ã‚¹å†…æ¤œç´¢</button>
        <button id="tabFullBtn" class="btn">å…¨æ–‡æ¤œç´¢</button>
      </div>

      <!-- ã‚¿ãƒ–: ãƒ¬ãƒ¼ã‚¹å†…æ¤œç´¢ -->
      <div id="raceTab">
        <div id="raceSuggestWrap" style="min-height:120px"></div>
        <hr/>
        <div id="newMemoWrap" style="display:none">
          <div style="font-weight:700; margin-bottom:.2rem">ãƒ¡ãƒ¢ã‚’è¿½åŠ </div>
          <textarea id="newMemoTa" placeholder="ã“ã®ãƒ¬ãƒ¼ã‚¹ã«ç´ã¥ããƒ¡ãƒ¢ã‚’è¨˜å…¥"></textarea>
          <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem">
            <button id="saveMemoBtn" class="btn primary">ç™»éŒ²</button>
            <button id="cancelMemoBtn" class="btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          </div>
        </div>
      </div>

      <!-- ã‚¿ãƒ–: å…¨æ–‡æ¤œç´¢ -->
      <div id="fullTab" style="display:none">
        <input id="searchInput" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢" style="width:100%; padding:.55rem .65rem; border:1px solid var(--line); border-radius:.5rem"/>
        <div id="searchResult" style="margin-top:.6rem"></div>
      </div>
    </div>
    <div class="dlg-foot">
      <button class="btn" id="clearSearchBtn">ã‚¯ãƒªã‚¢</button>
      <button class="btn primary" id="goTopBtn">TOPã«æˆ»ã‚‹</button>
    </div>
  </dialog>

<!-- ========== GIS (Google Identity Services) ã¨ Drive åŒæœŸãƒ˜ãƒ«ãƒ‘ ========== -->
<script>
(() => {
  const CLIENT_ID = (document.querySelector('meta[name="mofu:google-client-id"]')?.content || '').trim();
  let tokenClient = null;
  let accessToken = null;

  // 1) GISæº–å‚™
  function waitGisReady(timeoutMs=5000){
    return new Promise((resolve)=>{
      const t0 = Date.now();
      (function loop(){
        const ok = !!(window.google && google.accounts && google.accounts.oauth2);
        if (ok) return resolve(true);
        if (Date.now() - t0 > timeoutMs) return resolve(false);
        setTimeout(loop, 60);
      })();
    });
  }

  // 2) å¤–éƒ¨å…¬é–‹ï¼šãƒ­ã‚°ã‚¤ãƒ³æº–å‚™ï¼ˆapp.js ã‹ã‚‰å‘¼ã°ã‚Œã‚‹ï¼‰
  window.ensureGisReady = async function(){
    const ok = await waitGisReady();
    if (!ok) { console.error('GIS not loaded'); alert('Googleãƒ­ã‚°ã‚¤ãƒ³ã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸ'); return false; }

    if (!tokenClient){
      if (!CLIENT_ID){ alert('Google Client ID ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return false; }

      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/drive.file',
        callback: (resp) => {
          if (resp && resp.access_token){
            accessToken = resp.access_token;
            window.accessToken = accessToken;
            console.info('mofu: got access token');
          }else{
            console.warn('mofu: no access token in callback', resp);
          }
        }
      });
    }

    // æœ€åˆã®ãƒˆãƒ¼ã‚¯ãƒ³è¦æ±‚
    tokenClient.requestAccessToken({ prompt: 'consent' });
    return true;
  };

  // 3) å¤–éƒ¨å…¬é–‹ï¼šã‚µã‚¤ãƒ¬ãƒ³ãƒˆæ›´æ–°ï¼ˆ401æ™‚ã®å†è©¦è¡Œãªã©ï¼‰
  window.refreshAccessTokenSilent = async function(){
    const ok = await waitGisReady();
    if (!ok || !tokenClient) return false;

    return new Promise((resolve) => {
      tokenClient.callback = (resp) => {
        const has = !!(resp && resp.access_token);
        if (has){
          accessToken = resp.access_token;
          window.accessToken = accessToken;
        }
        resolve(has);
      };
      tokenClient.requestAccessToken({ prompt: '' }); // consent ãªã—
    });
  };
})();
</script>

<!-- â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ï¼šDrive API ãƒ˜ãƒ«ãƒ‘3é–¢æ•°ã‚’å…¬é–‹ï¼ˆå¿…é ˆï¼‰ â–¼â–¼â–¼ -->
<script>
(() => {
  const DRIVE_V3 = 'https://www.googleapis.com/drive/v3';
  const UPLOAD_V3 = 'https://www.googleapis.com/upload/drive/v3';

  async function ensureAccessToken() {
    if (window.accessToken) return true;
    if (typeof window.refreshAccessTokenSilent === 'function') {
      const ok = await window.refreshAccessTokenSilent();
      return !!ok;
    }
    return false;
  }

  async function driveFetch(url, opt = {}, retry = true) {
    const ok = await ensureAccessToken();
    if (!ok) throw new Error('No access token. Please Google-login first.');

    const res = await fetch(url, {
      ...opt,
      headers: {
        'Authorization': `Bearer ${window.accessToken}`,
        ...(opt.headers || {})
      }
    });

    // 401 â†’ ãƒˆãƒ¼ã‚¯ãƒ³å¤±åŠ¹ã®å¯èƒ½æ€§ã€‚1å›ã ã‘å†å–å¾—ã—ã¦å†è©¦è¡Œã€‚
    if (res.status === 401 && retry && typeof window.refreshAccessTokenSilent === 'function') {
      const r = await window.refreshAccessTokenSilent();
      if (r) return driveFetch(url, opt, /*retry*/false);
    }
    return res;
  }

  // 1) åå‰ã§ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’æ¢ã™
  window.driveFindFileIdByName = async function(name) {
    const q = encodeURIComponent(`name='${name.replace(/'/g, "\\'")}' and trashed=false`);
    const url = `${DRIVE_V3}/files?q=${q}&fields=files(id,name)&spaces=drive&pageSize=10`;
    const res = await driveFetch(url, { method: 'GET' });
    if (!res.ok) throw new Error('Drive list failed: ' + res.status);
    const data = await res.json();
    return (data.files && data.files[0] && data.files[0].id) || null;
  };

  // 2) æ–°è¦ä½œæˆï¼ˆmultipart/relatedï¼‰
  window.driveCreateFile = async function(name, content) {
    const boundary = 'mofu-' + Math.random().toString(16).slice(2);
    const meta = { name, mimeType: 'application/x-ndjson' }; // NDJSONæƒ³å®š

    const body =
      `--${boundary}\r\n` +
      `Content-Type: application/json; charset=UTF-8\r\n\r\n` +
      `${JSON.stringify(meta)}\r\n` +
      `--${boundary}\r\n` +
      `Content-Type: application/x-ndjson; charset=UTF-8\r\n\r\n` +
      `${content || ''}\r\n` +
      `--${boundary}--`;

    const res = await driveFetch(`${UPLOAD_V3}/files?uploadType=multipart&fields=id`, {
      method: 'POST',
      headers: { 'Content-Type': `multipart/related; boundary=${boundary}` },
      body
    });
    if (!res.ok) throw new Error('Drive create failed: ' + res.status);
    const data = await res.json();
    return data.id;
  };

  // 3) æ—¢å­˜æ›´æ–°ï¼ˆmediaã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
  window.driveUpdateFile = async function(fileId, content) {
    const res = await driveFetch(`${UPLOAD_V3}/files/${encodeURIComponent(fileId)}?uploadType=media`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/x-ndjson; charset=UTF-8' },
      body: content || ''
    });
    if (!res.ok) throw new Error('Drive update failed: ' + res.status);
    return true;
  };

  console.info('mofu: Drive helpers installed');
})();
</script>
<!-- â–²â–²â–² Drive API ãƒ˜ãƒ«ãƒ‘ ã“ã“ã¾ã§ â–²â–²â–² -->

<!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç‰ˆ or ãƒãƒ³ãƒ‰ãƒ«ç‰ˆã®ã©ã¡ã‚‰ã‹ã‚’ä½¿ç”¨ï¼‰ -->
<!-- â–¼ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç‰ˆï¼ˆé–‹ç™ºæ™‚ã¯ã“ã¡ã‚‰ã‚’æ¨å¥¨ï¼‰ -->
<script type="module" src="./main.js"></script>
<!-- â–¼ãƒãƒ³ãƒ‰ãƒ«ç‰ˆï¼ˆæœ¬ç•ªã§rollup/esbuildç­‰ã§ dist/app.min.js ã‚’åãå ´åˆã¯ã“ã¡ã‚‰ï¼‰
<script defer src="./dist/app.min.js"></script>
-->

</body>
</html>
